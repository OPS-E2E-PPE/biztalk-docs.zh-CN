---
title: "清单： 维护和故障排除 BizTalk Server 数据库 |Microsoft 文档"
ms.custom: 
ms.date: 06/29/2017
ms.prod: biztalk-server
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: 58931faf-fc84-46fe-8359-506da94c3756
caps.latest.revision: "4"
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 3e5ef7cdc4fb136a9fc80b04a04cdbe4f1e064e3
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/20/2017
---
# <a name="checklist-maintaining-and-troubleshooting-biztalk-server-databases"></a>清单： 维护和故障排除 BizTalk Server 数据库
[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]数据库和它们的运行状况是进行的成功非常重要[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]数据库邮件环境。 本主题列出在维护或故障排除时必须遵循的步骤[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]数据库。  
  
-   [维护 BizTalk Server 数据库](../technical-guides/checklist-maintaining-and-troubleshooting-biztalk-server-databases.md#BKMK_MaintainDB)  
  
-   [故障排除的 BizTalk Server 数据库](../technical-guides/checklist-maintaining-and-troubleshooting-biztalk-server-databases.md#BKMK_Troubleshoot)  
  
<a name="BKMK_MaintainDB"></a>   
## <a name="maintaining-biztalk-server-databases"></a>维护 BizTalk Server 数据库  
  
|步骤|参考|  
|-----------|---------------|  
|禁用**自动更新统计信息**和**自动创建统计信息**选项 (仅适用于[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]MessageBox 数据库)。|**注意：**这些设置默认情况下完成的一部分[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]配置。 你不应更改这些设置。 <br /><br /> 必须禁用**自动创建统计信息**和**自动更新统计信息**选项。 若要确定这些设置将被禁用，请在 SQL Server 中执行以下存储的过程：<br /><br /> exec sp_dboption BizTalkMsgBoxDB，自动创建统计信息 exec sp_dboption BizTalkMsgBoxDB 自动更新统计信息<br /><br /> 返回的值**CurrentSetting**应为 OFF。 如果此值返回有关**CurrentSetting**为 ON，将其更改为 OFF，通过在 SQL Server 中执行以下存储的过程：<br /><br /> exec sp_dboption BizTalkMsgBoxDB，自动创建统计信息，关闭 exec sp_dboption BizTalkMsgBoxDB、 自动更新统计信息，关闭<br /><br /> 有关这些设置的详细信息请参阅以下 Microsoft 知识库文章：<br /><br /> -   **917845**-["你遇到阻止，死锁条件或其他 SQL Server 问题，当你尝试连接到 BizTalk Server 中的 BizTalkMsgBoxDb 数据库时"](http://go.microsoft.com/fwlink/?LinkId=153429) (http://go.microsoft.com/fwlink/?LinkId=153429)。<br />-   **912262**-["自动更新统计信息选项的自动创建统计信息选项和并行度设置处于关闭状态中承载 BizTalk Server BizTalkMsgBoxDB 数据库的 SQL Server 数据库实例"](http://go.microsoft.com/fwlink/?LinkId=153430)(http://go.microsoft.com/fwlink/?LinkId=153430)。|  
|设置最大并行度属性度|**注意：**这些设置默认情况下完成的一部分[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]配置。 你不应更改这些设置。 <br /><br /> 设置最大并行度**run_value**和**config_value**为一 (1) 上的值的属性[!INCLUDE[btsSQLServerNoVersion](../includes/btssqlservernoversion-md.md)]托管实例[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]Messagebox 数据库。 若要检查最大并行度设置度，请执行以下存储过程对主数据库中[!INCLUDE[btsSQLServerNoVersion](../includes/btssqlservernoversion-md.md)]:<br /><br /> exec sp_configure 'max degree of parallelism<br /><br /> 如果**run_value**和**config_value**是未设置为值一 (1)，在 SQL Server 中执行以下存储的过程：<br /><br /> exec sp_configure 'max degree of parallelism'、 '1' reconfigure 替代方法<br /><br /> 有关如何最大并行度设置度影响[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]，请参阅以下 Microsoft 知识库文章：<br /><br /> -   **899000**-["的实例的 SQL Server 配置 BizTalk Server 时的并行度设置"](http://go.microsoft.com/fwlink/?LinkId=153432) (http://go.microsoft.com/fwlink/?LinkId=153432)。<br />-   **917845**-["你遇到阻止，死锁条件或其他 SQL Server 问题，当你尝试连接到 BizTalk Server 中的 BizTalkMsgBoxDb 数据库时"](http://go.microsoft.com/fwlink/?LinkId=153429) (http://go.microsoft.com/fwlink/?LinkId=153429)。|  
|确定当你可以重新生成[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]索引|中的索引的大多数[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]聚集数据库 (索引 ID: 1)。 DBCC SHOWCONTIG 命令可以用于显示表中的碎片信息[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]数据库。 这些索引是基于 GUID 的因此是正常的碎片发生。 如果 DBCC SHOWCONTIG 扫描密度值是小于 30%，可以在停机期间重新生成索引。 中的多个表[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]数据库包含使用数据类型定义不能执行联机索引的列。 因此中的表的索引[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]数据库应永远不会重新生成时 BizTalk 正在处理数据。 有关如何重新生成 BizTalk 索引的详细信息，请参阅以下 Microsoft 知识库文章：<br /><br /> -   **917845**-["你遇到阻止，死锁条件或其他 SQL Server 问题，当你尝试连接到 BizTalk Server 中的 BizTalkMsgBoxDb 数据库时"](http://go.microsoft.com/fwlink/?LinkId=153429) (http://go.microsoft.com/fwlink/?LinkId=153429)。<br /><br /> 有关索引碎片和工作负荷类型的详细信息，请参阅白皮书[Microsoft SQL Server 2000 索引碎片整理最佳实践](http://go.microsoft.com/fwlink/?LinkId=101580)(http://go.microsoft.com/fwlink/?LinkId=101580)。 **注意：** sys.dm_db_index_physical_stats 函数还可用来查找中的碎片信息[!INCLUDE[btsSQLServer2005](../includes/btssqlserver2005-md.md)]和[!INCLUDE[btsSQLServer2008](../includes/btssqlserver2008-md.md)]。 有关详细信息，请参阅[sys.dm_db_index_physical_stats (TRANSACT-SQL)](http://go.microsoft.com/fwlink/?LinkId=158493) (http://go.microsoft.com/fwlink/?LinkId=158493)。|  
|监视数据库的锁、 块或死锁|它是锁和块上才会出现的预期的行为[!INCLUDE[btsSQLServerNoVersion](../includes/btssqlservernoversion-md.md)]所使用的数据库[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]。 但是，因此不应具有这些锁或块的时间长的时间继续。 扩展阻止和死锁情况上[!INCLUDE[btsSQLServerNoVersion](../includes/btssqlservernoversion-md.md)]所使用的数据库[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]是潜在问题的指示符。 为当前已知原因死锁情况以及阻塞[!INCLUDE[btsSQLServerNoVersion](../includes/btssqlservernoversion-md.md)]所使用的数据库[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]，查看以下 Microsoft 知识库文章：<br /><br /> -   **917845**-["你遇到阻止，死锁条件或其他 SQL Server 问题，当你尝试连接到 BizTalk Server 中的 BizTalkMsgBoxDb 数据库时"](http://go.microsoft.com/fwlink/?LinkId=153429) (http://go.microsoft.com/fwlink/?LinkId=153429)。|  
|监视数据库和表的大小|大小[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]Messagebox 数据库通常应不超过大约 5 GB。  BizTalkMsgBoxDb 数据库不应为保存任何数据，并且应被视为缓冲区，直到处理数据或将其移到 BizTalkDTADb 数据库。 具有强大的 SQL Server 后端和多长时间运行的业务流程的环境可能具有 BizTalkMsgBoxDb 数据库大于 5 GB。 任何长时间运行业务流程的大容量环境应具有[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]Messagebox 数据库远小于 5 GB。 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]跟踪数据库大小可以极大地改变，但如果查询性能会显著降低，然后跟踪数据库可能是太大。 根据经验，[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]跟踪数据库大于 15 到 20 GB 属于太大，可能会对性能产生不利影响。 以下问题可能是由引起[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]太大的数据库：<br /><br /> - [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] Messagebox 数据库继续增长时仍然很大的数据大小 （而不仅仅是日志文件）。 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]采用较长的时间比平时处理甚至简单消息流方案。<br />组中心查询需要比平时更长时间，并可能甚至超时。<br />-数据库日志文件永远不会被截断。<br />-BizTalk SQL 代理作业运行速度慢于正常。<br />-具有过多行相比为 normal 或者某些表很大得多。<br /><br /> [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]数据库会变得大的原因包括：<br /><br /> -BizTalk SQL 代理作业未运行<br />-过多挂起的消息或服务实例<br />磁盘故障<br />-高级别的跟踪<br />-   [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]限制<br />-不佳[!INCLUDE[btsSQLServerNoVersion](../includes/btssqlservernoversion-md.md)]性能<br />网络延迟问题<br /><br /> 同样，你可以在表中有太多行。 没有任何组具有太多的行数。 此外，此数目的行因表中存储什么类型的数据而异。 例如， *dta_DebugTrace*可能具有多个 100 万行的表具有行过多。 A *HostNameQ_Suspended*可能有多个 200,000 行的表具有行过多。<br /><br /> 请确保你知道的预期内容你的环境以确定是否在发生数据问题。|  
|在上启用跟踪[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]主机|默认情况下，默认主机上启用跟踪。 BizTalk 需要**允许主机跟踪**选项检查一台主机上。 跟踪数据解码服务 (TDDS) 启用跟踪后，将跟踪事件数据从[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]Messagebox 数据库添加到[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]跟踪数据库。 如果没有[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]主机配置为具有选项**允许主机跟踪**或如果跟踪主机已停止，则将不会运行 TDDS 和 TrackingData_x_x 表中的[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]Messagebox 数据库将增大未选中状态. 因此，专用[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]主机应配置的选项**允许主机跟踪**。 有关配置专用的跟踪主机的详细信息请参阅[配置专用的跟踪主机](~/technical-guides/configuring-a-dedicated-tracking-host.md)。 **注意：**若要允许 TDDS 维护在大容量方案中的新跟踪事件，你可以创建单个跟踪主机的多个实例，但不是能超过一个主机应配置对其进行跟踪。|  
|使用正确的 BizTalk SQL Server 代理作业|执行[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]SQL 代理作业用于管理至关重要[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]数据库和保持最佳性能。<br /><br /> -**备份[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]**  SQL Server 代理作业是唯一受支持的方法，以备份[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]数据库。 此作业需要设置所有[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]数据库使用完整恢复模式。 你应配置此作业的正常[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]环境。 你可以使用 SQL Server 方法备份[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]数据库仅当 SQL Server 服务已停止并且所有[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]进程停止。 **注意：**有关配置 SQL 代理备份时使用的 SQL Server 完整恢复模型的详细信息[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]作业，请参阅[日志传送](http://go.microsoft.com/fwlink/?LinkId=153450)(http://go.microsoft.com/fwlink/?LinkId = 153450) 或[备份完整恢复模式下](http://go.microsoft.com/fwlink/?LinkId=156509)(http://go.microsoft.com/fwlink/?LinkId = 156509)。<br />- **MessageBox_Message_ManageRefCountLog_BizTalkMsgBoxDb** SQL Server 代理作业旨在无限期运行。 因此 SQL 代理作业历史记录可能不表示此 SQL 代理作业已成功完成;此行为是设计使然。 如果失败，作业将在 1 分钟内重新启动，并继续运行全速。 因此，通常可以忽略此作业的失败通知。 如果 MessageBox_Message_ManageRefCountLog_BizTalkMsgBoxDb SQL Server 代理作业的作业历史记录表示此作业是不断发生故障，重新启动到可能的原因的进一步调查的失败/重新启动周期可能需要。<br />- **MessageBox_Message_Cleanup_BizTalkMsgBoxDb** SQL Server 代理作业是仅应手动启用，因为它由 MessageBox_Message_ManageRefCountLog_BizTalkMsgBoxDb 作业启动的作业。<br />- **DTA 清除和存档**SQL Server 代理作业维护[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]按清除和存档跟踪的消息跟踪数据库。 此作业将读取表中的每个行，并比较每个行，以确定是否应删除记录的时间戳。 **注意：**进行故障排除时[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]SQL Server 代理作业，验证 MessageBox_Message_ManageRefCountLog_BizTalkMsgBoxDb 除外的所有 SQL 代理作业是否都完成未出现错误。 <br /><br /> 有关详细信息[!INCLUDE[btsBizTalkServer2006r3](../includes/btsbiztalkserver2006r3-md.md)]中使用的 SQL 代理作业[!INCLUDE[btsSQLServerNoVersion](../includes/btssqlservernoversion-md.md)]:<br /><br /> -请参阅[数据库结构和作业](http://go.microsoft.com/fwlink/?LinkId=153451)(http://go.microsoft.com/fwlink/?LinkId=153451)。<br />-请参阅[说明 SQL Server 代理作业在 BizTalk Server](http://go.microsoft.com/fwlink/?LinkId=153452) (http://go.microsoft.com/fwlink/?LinkId=153452)。|  
|监视和终止挂起的实例|服务实例可能已挂起 （恢复），或已挂起 （不恢复）。 消息传递、 业务流程或端口，可能是这些服务实例。 [!INCLUDE[btsBizTalkServer2006r3](../includes/btsbiztalkserver2006r3-md.md)]通过使用组中心数据库页中的，能够适应终止和删除这些实例[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]管理控制台或通过 Terminate.vbs 脚本使用。 有关 Terminate.vbs 脚本的详细信息，请参阅[删除挂起的服务实例](http://go.microsoft.com/fwlink/?LinkId=153453)(http://go.microsoft.com/fwlink/?LinkId=153453)。 **提示：**你还可以使用终止符工具删除挂起的实例。 [终止符工具](http://go.microsoft.com/fwlink/?LinkId=151931)位于[http://go.microsoft.com/fwlink/?LinkId=151931](http://go.microsoft.com/fwlink/?LinkId=151931)。 使用此工具不支持由 Microsoft 和 Microsoft 则没有此程序的适用性的保证。 使用此程序风险自负。 <br /><br /> 术语"孤立行"和"傀儡"通常是交替使用。 孤立或僵停消息是一条消息，不具有关联的服务实例，通常因为服务实例已终止之前已接收消息。 孤立或僵停服务是一种服务，没有任何关联的消息。 有关僵停消息和中的服务实例的详细信息[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]请参阅[BizTalk Server 中的僵尸](http://go.microsoft.com/fwlink/?LinkId=153454)(http://go.microsoft.com/fwlink/?LinkId=153454)。|  
|监视性能计数器的**PhysicalDisk**性能对象|[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]在一分钟内对 SQL Server 大量的较短的非常快速的事务。 如果 SQL Server 无法承受此活动，你可能会遇到[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]性能问题。 监视器**avg.Disk sec/Read**， **avg.Disk sec/Transfer**，和**avg.Disk sec/Write**性能监视器计数器**PhysicalDisk**性能对象。 最佳值是小于 10 毫秒 （毫秒）。 一个或更大的 20 毫秒的值被视为较差的性能。<br /><br /> -有关 SQL Server 2005 性能的详细信息，请参阅[故障排除 SQL Server 2005 中的性能问题](http://go.microsoft.com/fwlink/?LinkID=153585)(http://go.microsoft.com/fwlink/?LinkID=153585)。<br />-有关 SQL Server 2008 性能的详细信息，请参阅[中 SQL Server 2008 的故障排除性能问题](http://go.microsoft.com/fwlink/?LinkID=153586)(http://go.microsoft.com/fwlink/?LinkID=153586)。<br />有关详细信息的[!INCLUDE[btsBizTalkServer2006r3](../includes/btsbiztalkserver2006r3-md.md)]数据库高可用性，请参阅[BizTalk Server 数据库提供高可用性](http://go.microsoft.com/fwlink/?LinkId=153587)(http://go.microsoft.com/fwlink/?LinkId=153587)。<br /><br /> 您还可以参考以下 Microsoft 知识库文章有关 SQL Server 性能的详细信息：<br /><br /> -   **298475** – ["如何解决 SQL Server 性能问题"](http://go.microsoft.com/fwlink/?LinkId=153588) (http://go.microsoft.com/fwlink/?LinkId=153588)。<br />-   **271509** – ["how to monitor 阻止在 SQL Server 2005 中"](http://go.microsoft.com/fwlink/?LinkId=153589) (http://go.microsoft.com/fwlink/?LinkId=153589)。|  
|遵循的最佳实践[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]数据库。|请参阅[维护 BizTalk Server 数据库的最佳实践](~/technical-guides/best-practices-for-maintaining-biztalk-server-databases.md)。|  
  
<a name="BKMK_Troubleshoot"></a>   
## <a name="troubleshooting-biztalk-server-databases"></a>故障排除的 BizTalk Server 数据库  
 执行以下任务来诊断任何问题[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]数据库。  
  
|步骤|参考|  
|-----------|---------------|  
|确保所有必需的 BizTalk SQL Server 代理作业处于启用状态且正在运行|所有 BizTalk SQL Server 代理都作业除外**MessageBox_Message_ManageRefCountLog_BizTalkMsgBoxDb**作业应成功为启用并正在运行。 请勿禁用任何其他作业。<br /><br /> 如果发生故障，使用**查看历史记录**以查看错误信息，并相应地解决失败的 SQL Server 中的选项。 请记住， **MessageBox _Message_ManageRefCountLog_BizTalkMsgBoxDb** SQL Server 代理作业将无限期运行。 因此，你只应考虑如果作业历史记录报告作业不断失败和重启。|  
|使用 MsgBoxViewer 工具来分析 BizTalk MessageBox 和其他数据库|**重要说明：** Microsoft，不支持使用此工具和 Microsoft 则没有此程序的适用性的保证。 使用此程序风险自负。 <br /><br /> MsgBoxViewer 工具是可从[http://go.microsoft.com/fwlink/?LinkId=151930](http://go.microsoft.com/fwlink/?LinkId=151930) (http://go.microsoft.com/fwlink/?LinkId=151930)。 MsgBoxViewer 工具可用于故障排除，因为它提供的详细信息表的大小和行计数的 HTML 报表。 报表还可以帮助确定是否[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]进行限制。 此外，该工具将提供的快照[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]数据库和[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]配置。<br /><br /> 当[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]是比平常慢，运行运行 MsgBoxViewer 工具中，单击选中的所有查询**可选查询**选项卡，然后查看生成的 HTML 报告的任何问题。 **摘要报表**部分列出在为红色的黄色的潜在问题的警告。<br /><br /> 此外，MsgBoxViewer 工具可用于确定哪些表是最大和具有大多数记录。 通常增长 larges 的表的列表以及有关如何管理这些表的说明，请参阅[大增长 BizTalk Server 数据库表](~/technical-guides/large-growing-biztalk-server-database-tables.md)。|  
|使用终止符工具来解决问题，如果任何，由 MsgBoxViewer 工具|**重要说明：** Microsoft，不支持使用此工具和 Microsoft 则没有此程序的适用性的保证。 使用此程序风险自负。 <br /><br /> 运行终结器工具，可在[终止符](http://go.microsoft.com/fwlink/?LinkId=151931)(http://go.microsoft.com/fwlink/?LinkId=151931)。 此工具使用户能够轻松地解决由 BizTalk MsgBoxViewer 工具标识的任何问题。 有关如何与 BizTalk MsgBoxViewer 工具集成终止符工具的详细信息，请参阅[使用 BizTalk 终止符，若要解决问题由 BizTalk MsgBoxViewer](http://go.microsoft.com/fwlink/?LinkId=151932) (http://go.microsoft.com/fwlink/?LinkId=151932)。|  
|调查死锁方案|在死锁方案中，启用 SQL Server 上的 DBCC 跟踪，以便死锁信息写入到 SQLERROR 日志。<br /><br /> 在 SQL Server 2008 或 SQL Server 2005 中，执行以下语句以启用 DBCC 跟踪死锁方案：<br /><br /> DBCC TRACEON (1222，则为-1)<br /><br /> 您还可以使用 PSSDIAG 实用工具用于收集数据的**Lock: Deadlock**事件和**Lock: Deadlock Chain**事件。 有关 PSSDIAG 实用工具的详细信息，请参阅[PSSDIAG 数据收集实用程序](http://go.microsoft.com/fwlink/?LinkId=153627)(http://go.microsoft.com/fwlink/?LinkId=153627)。<br /><br /> BizTalkMsgBoxDB 数据库是大容量和高事务联机事务处理 (OLTP) 数据库。 此类数据库中，与预期某些死锁，并且此死锁处理内部[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]引擎。 在这种情况，在错误日志中不列出任何错误。 后调查死锁情况时，必须使用事件日志中的死锁错误关联正在调查在输出中死锁。|  
|查找阻塞的进程|可以使用 SQL Server 中的活动监视器获取锁定系统进程的服务器进程标识符 (SPID)。 然后可以运行 SQL 事件探查器，以确定在锁定 SPID 中执行的 SQL 语句。 PSSDIAG 实用工具可用于解决 SQL Server 中的锁定和阻塞问题。 该实用工具捕获具有启用阻止脚本的所有 TRANSACT-SQL 事件。 有关 PSSDIAG 实用工具的详细信息，请参阅[PSSDIAG 数据收集实用程序](http://go.microsoft.com/fwlink/?LinkId=153627)(http://go.microsoft.com/fwlink/?LinkId=153627)。<br /><br /> 在 SQL Server 2005 和更高版本中，你可以指定**阻塞的进程阈值**设置，以确定 SPID 或 Spid 阻塞时间长于你指定的阈值。 Blocked 的 process threshold 选项有关的详细信息，请参阅[阻塞的进程阈值选项](http://go.microsoft.com/fwlink/?LinkId=153628)(http://go.microsoft.com/fwlink/?LinkId=153628)。 **注意：**时遇到 SQL Server 中的锁定或正在阻塞问题，我们建议您与 Microsoft 客户支持服务部门联系。 Microsoft 客户支持服务可以帮助你配置正确的 PSSDiag 实用程序选项。|  
|删除所有不需要的数据|如果数据库已增大，会变得太大，如果在数据库中包含的数据将不会需要过更长，首选的方法是删除的数据。 **注意：**不要使用此方法在任何环境中知道数据的业务关键型或如果所需要的数据。 <br /><br /> **若要清除 BizTalkMsgBox 数据库**<br /> 1.下载并安装在该终止符工具[Biztalk 终止符](http://go.microsoft.com/fwlink/?LinkId=220869)(http://go.microsoft.com/fwlink/?LinkId=220869)。<br />2.按照本主题中的步骤[如何手动清除数据从测试环境中的 MessageBox 数据库](http://go.microsoft.com/fwlink/?LinkID=158064)(http://go.microsoft.com/fwlink/?LinkID=158064) 创建 bts_CleanupMsgbox BizTalk MessageBox 数据库中存储过程。<br />3.使用终止符工具执行 bts_CleanupMsgbox 存储过程并清除 BizTalk MessageBox 数据库。 **警告：**确实在运行 BizTalk Server 生产服务器上运行 bts_CleanupMsgbox 存储过程。 您仅应在测试环境中运行 bts_CleanupMsgbox 存储过程。 不支持运行 bts_CleanupMsgbox 在生产环境中的存储的过程。<br />4.重新启动所有主机和[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]服务。<br /><br /> **若要清除 BizTalkDTADb 数据库**<br /> <ul><li>**方法 1**<br /><br /> <ol><li>备份所有[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]数据库。</li><li>执行**dtasp_PurgeAllCompletedTrackingData**存储过程。 有关存储过程的详细信息，请参阅[如何手动清除数据从 BizTalk 跟踪数据库](http://go.microsoft.com/fwlink/?LinkId=153635)(http://go.microsoft.com/fwlink/?LinkId=153635)。</li></ol></li><li>**方法 2**。 仅当 BizTalkDTADb 数据库包含多个未完成的实例，则必须删除，请使用此选项。<br /><br /> <ol><li>备份所有[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]数据库。</li><li>停止所有 BizTalk 主机、 服务和自定义独立的适配器。 如果你使用 HTTP 或 SOAP 适配器，请重新启动 IIS 服务。</li><li>执行**dtasp_CleanHMData** BizTalkDTADb 数据库上的存储过程。</li><li>重新启动所有主机和[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]服务。</li></ol></li></ul> **注意：**必须具有跟踪数据，备份 BizTalkDTADb 数据库中，如果将数据库还原到另一个 SQL Server，然后清除原始 BizTalkDTADb 数据库。|  
  
 如果你想分析 MsgBoxViewer 数据或 PSSDIAG 输出的帮助，请与 Microsoft 客户支持服务联系。 请联系客户支持服务之前，压缩 MsgBoxViewer 数据、 PSSDIAG 输出和更新的事件日志 （.evt 文件）。 您可能必须将发送到这些文件[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]支持工程师  
  
## <a name="in-this-section"></a>本节内容  
  
-   [用于维护 BizTalk Server 数据库的最佳方案](~/technical-guides/best-practices-for-maintaining-biztalk-server-databases.md)  
  
-   [大型增长 BizTalk Server 数据库表](~/technical-guides/large-growing-biztalk-server-database-tables.md)  
  
-   [工具和实用程序可用于故障排除](../technical-guides/tools-and-utilities-for-troubleshooting.md)  
  
## <a name="see-also"></a>另请参阅  
 [不应更改的 SQL Server 设置](~/technical-guides/sql-server-settings-that-should-not-be-changed.md)