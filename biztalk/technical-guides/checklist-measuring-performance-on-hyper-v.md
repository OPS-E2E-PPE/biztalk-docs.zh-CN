---
title: 清单： 度量 HYPER-V 上的性能 |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: f32c95f4-a4eb-412b-9fa7-140e80b85e5a
caps.latest.revision: 13
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 111ca6bfa37fdfc6af6f484ebc1568cbaca2c8f6
ms.sourcegitcommit: 266308ec5c6a9d8d80ff298ee6051b4843c5d626
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 06/27/2018
ms.locfileid: "37007110"
---
# <a name="checklist-measuring-performance-on-hyper-v"></a>清单： 度量 HYPER-V 上的性能
虽然大部分分析性能的来宾操作系统安装上的 HYPER-V 虚拟机性能的原则是与分析的物理计算机上安装操作系统的性能相同，许多集合方法都是不同的结果。 评估您的 HYPER-V 虚拟机上安装来宾操作系统上运行的 BizTalk Server 解决方案的性能时，以下各节应用作快速参考。  

## <a name="measuring-disk-io-performance"></a>衡量磁盘 I/O 性能  
 使用下列性能监视器计数器来测量在 HYPER-V 虚拟机上安装来宾操作系统上的磁盘 I/O 性能：  


|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 步骤                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                参考                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **度量值的 HYPER-V 主机操作系统上的磁盘延迟**-在 HYPER-V 主机操作系统上的磁盘性能的最佳初始指标通过使用"\Logical 磁盘 (*) \Avg。Disk sec/Read"和"\Logical 磁盘 (\*) \Avg。Disk sec/Write"性能监视器计数器。这些性能监视器计数器来测量的读取和写入操作要花费的时间响应操作系统时间量。作为常规经验，平均响应时间大于时间被视为不够理想。作为常规经验，平均响应时间大于时间被视为不够理想。这基于典型查找单个 7200 RPM 磁盘驱动器，而无需缓存的时间。建议的物理磁盘性能监视器计数器与逻辑磁盘使用，因为 Windows 应用程序和服务利用表示为驱动器号提供给操作系统的物理磁盘 (LUN) 可以是其中的逻辑驱动器包含磁盘阵列中的多个物理磁盘驱动器。在测量磁盘延迟使用 \Logical 磁盘的 HYPER-V 主机操作系统上使用以下规则的经验法则 (\*) \Avg。磁盘秒数/读取或 \Logical 磁盘 (\*) \Avg。磁盘秒数/写入性能监视器计数器：<br /> <br />这基于典型查找单个 7200 RPM 磁盘驱动器，而无需缓存的时间。建议的物理磁盘性能监视器计数器与逻辑磁盘使用，因为 Windows 应用程序和服务利用表示为驱动器号提供给操作系统的物理磁盘 (LUN) 可以是其中的逻辑驱动器包含磁盘阵列中的多个物理磁盘驱动器。在测量磁盘延迟使用 \Logical 磁盘的 HYPER-V 主机操作系统上使用以下规则的经验法则 (\*) \Avg。磁盘秒数/读取或 \Logical 磁盘 (\*) \Avg。磁盘秒数/写入性能监视器计数器：<br /> <br /> -1 毫秒到时间 = 正常<br />-时间到为 25 ms = 警告或监视<br />-26ms年或更高版本 = 严重，性能会受到不利影响\* \*注意：* \*在非虚拟化环境中安装的物理磁盘提供更好的性能比通过 HYPER-V 主机操作系统访问的磁盘。 如果磁盘性能非常重要的应用程序的整体性能，请考虑托管磁盘仅物理硬件上。 **注意：** 评估磁盘 I/O 性能时，请确保配置防病毒软件扫描的任何计算的磁盘分区中排除。 防病毒扫描引入了对产生负面影响性能和倾斜的测试结果的开销。 <br /><br /> **测量来宾操作系统上的磁盘延迟**– 可以使用用于测量响应时间的 HYPER-V 主机操作系统所用的磁盘的相同性能监视器计数器测量所用的来宾操作系统磁盘响应时间系统。 | 有关磁盘性能分析的详细信息，请参阅以下资源：<br /><br /> -"的 HYPER-V 中运行 SQL Server 的性能开销"部分中的"运行 SQL Server 2008 in a HYPER-V 环境 – 最佳实践和性能注意事项"白皮书，网址[ http://go.microsoft.com/fwlink/?LinkId=144622 ](http://go.microsoft.com/fwlink/?LinkId=144622)。<br />-不再在绑定磁盘问题[ http://go.microsoft.com/fwlink/?LinkId=120947 ](http://go.microsoft.com/fwlink/?LinkId=120947)。<br />在 SQL Server 预部署 I/O 最佳实践[ http://go.microsoft.com/fwlink/?LinkId=120948 ](http://go.microsoft.com/fwlink/?LinkId=120948)。<br />-"I/O 瓶颈"部分中的"在 SQL Server 2008" 白皮书中提供的性能问题故障排除[ http://go.microsoft.com/fwlink/?LinkID=202135 ](http://go.microsoft.com/fwlink/?LinkID=202135)。<br />-如何确定磁盘性能瓶颈使用在 Microsoft 服务器性能顾问 (SPA) 工具[ http://go.microsoft.com/fwlink/?LinkID=98096 ](http://go.microsoft.com/fwlink/?LinkID=98096)。 |

## <a name="measuring-memory-performance"></a>测量内存性能  
 使用下列性能监视器计数器以衡量性能的 HYPER-V 虚拟机上安装来宾操作系统上的可用内存的影响：  

|步骤|参考|  
|----------|---------------|  
|**度量值的 HYPER-V 主机操作系统上的可用内存**-可通过监视"\Memory\Available MBytes"性能监视器计数器来确定可用的 HYPER-V 主机操作系统的物理内存量物理计算机。 此计数器报告供主机操作系统的可用物理内存量。 评估可用于主机操作系统的可用物理内存时，请使用以下规则的经验法则：<br /><br /> <ul><li>**\Memory\Available Mbytes** – Available MBytes 测量可安装在计算机上的物理内存的百分比的计算机上，运行的进程的物理内存量。 在测量此性能监视器计数器的值时，应考虑下列准则：<br /><br /> <ul><li>内存可用的 50%或更多 = 正常</li><li>25%的内存可用 = 监视</li><li>10%的内存可用 = 警告</li><li>小于 5%的内存可用 = 关键，性能将受到负面影响</li></ul></li><li>**\Memory\Pages/sec** – 此性能监视器计数器测量从读取或写入磁盘为解决强制分页错误页的速率。 若要解决强制分页错误，操作系统必须更换内存到磁盘，性能有负面影响的内容。 大量的页面每秒在可用物理内存不足可能表示物理内存不足。 在测量此性能监视器计数器的值时，应考虑下列准则：<br /><br /> <ul><li>少于 500 = 正常</li><li>500-1000年 = 监视或注意</li><li>大于 1000年 = 严重，性能将受到负面影响</li></ul></li></ul><br /> **测量来宾操作系统上的可用内存**– 适用于来宾操作系统的内存可用于度量可用的 HYPER-V 主机操作系统的内存的相同性能监视器计数器进行度量。|有关详细信息影响可用物理内存的应用程序服务器性能，查看 Exchange Server 2003 帮助主题"排除出受内存限制时出现问题[ http://go.microsoft.com/fwlink/?LinkId=121056 ](http://go.microsoft.com/fwlink/?LinkId=121056)。|  

## <a name="measuring-network-performance"></a>测量的网络性能  
 HYPER-V 允许来宾计算机，以共享相同的物理网络适配器。 虽然这可帮助整合硬件，请注意不饱和的物理适配器。 使用以下方法以确保 HYPER-V 虚拟机使用的网络的运行状况：  


|                                 步骤                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               参考                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|----------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|                       **测试网络延迟**                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Ping 每个虚拟机，以确保足够的网络延迟。 在局域网，预计可以收到不超过 1 毫秒响应时间。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|                       **数据包丢失的测试**                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          使用 pathping.exe 实用工具来测试虚拟机之间的数据包丢失。 Pathping.exe 测量网络上的数据包丢失，并可与所有版本的[!INCLUDE[btsWinNoVersion](../includes/btswinnoversion-md.md)]由于[!INCLUDE[btsWin2kSvr](../includes/btswin2ksvr-md.md)]。 Pathping.exe 发出的每个网络节点到 100 个 ping 请求突然增加，并计算返回多少 ping。 在局域网上应该不会丢失从 pathping.exe 实用工具的 ping 请求。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|                   **测试网络文件传输**                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          将复制的虚拟机之间有 100 MB 的文件和度量值以完成复制所需的时间长度。 在正常 100m 位 （兆位） 网络 100 MB （兆字节） 文件应复制在 10 到 20 秒内。 在正常 1g 比特网络中，有 100 MB 的文件应在约 3 到 5 秒内将复制。 这些参数之外的复制时间均表示有网络问题。 较差网络传输的一个常见原因发生时的网络适配器具有"自动检测到"这样可防止网络适配器充分利用可用带宽的 10 MB 半双工网络。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **度量值的 HYPER-V 主机操作系统上的网络利用率** | 使用下列性能监视器计数器来测量网络利用率的 HYPER-V 主机操作系统上：<br /><br /> **\Network 接口 (\*) \Bytes Total/sec** – 网络使用率的百分比计算 8 来将其转换为位乘以字节总数/秒，将结果乘以 100，则网络适配器被除的当前带宽。 使用以下阈值来评估网络带宽利用率：<br /><br /> -小于 40%的使用的接口 = 正常<br />： 使用的接口 41%-64%= 监视或注意<br />-使用的接口的 65 100%= 关键，性能将受到负面影响<br /><br /> **\Network 接口 (\*) \Output 队列长度**– 输出队列长度测量的网络适配器上等待的线程数。 如果有 2 个以上线程在等待上的网络适配器，则网络可能是瓶颈。 此常见原因是较差的网络延迟和/或在网络上的高冲突率。 使用以下阈值评估输出队列长度：<br /><br /> -0 = 正常<br />-1-2 = 监视或注意<br />-大于 2 = 严重，性能将受到负面影响。<br /><br /> 请确保该解决方案中的所有计算机 （物理和虚拟） 网络适配器都配置为使用最大传输单元 (MTU) 相同的值。 有关配置 MTU 值的详细信息，请参阅"附录 a: TCP/IP 配置参数"网址[ http://go.microsoft.com/fwlink/?LinkId=113716 ](http://go.microsoft.com/fwlink/?LinkId=113716)。<br /><br /> 如果测量输出队列长度为 2 或更大，请考虑将一个或多个物理网络适配器添加到托管虚拟机的物理计算机并将绑定到这些物理网络适配器的来宾操作系统使用的网络适配器。 |
|    **度量值在来宾操作系统上的网络利用率**    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       如果上面提到的性能监视器计数器所示的 HYPER-V 根分区上的网络适配器正在使用，请考虑使用"\Hyper-V 虚拟网络适配器 (\*) \Bytes/sec"性能监视器计数器以确定哪个虚拟网络适配器占用大多数网络利用率。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |

 有关网络性能分析的详细信息，请参阅"一章 15-度量.NET 应用程序性能"网址[ http://go.microsoft.com/fwlink/?LinkId=121073 ](http://go.microsoft.com/fwlink/?LinkId=121073)。  

## <a name="measuring-processor-performance"></a>测量处理器性能  
 使用以下方法来评估在 HYPER-V 虚拟机上安装来宾操作系统上的处理器性能：  

- **来宾操作系统的处理器使用率的度量值**传统上，处理器的性能可以测量使用"\Processor(*)\\%Processor Time"性能监视器计数器。 这不是准确计数器但评估的来宾操作系统的处理器使用率，因为 HYPER-V 测量并报告此值相对于分配给虚拟机的处理器的数目。 如果多个处理器分配给多于实际存在于物理计算机上运行的虚拟机中，为每个来宾操作系统返回的值"\Processor (\*)\\%Processor Time"性能监视器计数器很低，即使处理器使用率实际上是一个瓶颈。 这是因为虚拟处理器利用物理处理器以轮循机制的方式。 每个虚拟处理器会尝试并分配本身的整体系统资源的共享以便在 4 个物理处理器系统中，每个虚拟处理器将按默认尝试利用 25%的系统资源。 如果 8 个虚拟处理器以共同创建了这意味着虚拟处理器将尝试利用服务器的 CPU 容量的 200%。 在这种情况下，每个虚拟处理器将报告由低利用率"\Processor (\*)\\%Processor Time"（相对于其需要的级别） 的性能监视器计数器和过多的上下文之间进行切换虚拟处理器会为每个虚拟机的性能不佳。 在此方案中，请考虑减少分配给主机操作系统上的 HYPER-V 虚拟机的虚拟处理器的数量。HYPER-V 提供了虚拟机监控程序性能对象，以监视逻辑和虚拟处理器的性能。 "第 15 章-测量.NET 应用程序性能"处  。 例如，物理计算机上安装的 2 个四核处理器将关联到 8 个逻辑处理器。 虚拟处理器的虚拟机实际使用什么，并在虚拟处理器根和子分区中的所有执行都时发生。  

   HYPER-V 提供了虚拟机监控程序性能对象，以监视逻辑和虚拟处理器的性能。 "第 15 章-测量.NET 应用程序性能"处  。 例如，物理计算机上安装的 2 个四核处理器将关联到 8 个逻辑处理器。 虚拟处理器的虚拟机实际使用什么，并在虚拟处理器根和子分区中的所有执行都时发生。  

   若要准确测量来宾操作系统的处理器使用率，请使用"逻辑 processor （_total 的 HYPER-V 虚拟机监控程序） %总运行时间"上的 HYPER-V 主机操作系统的性能监视器计数器。 使用以下阈值来评估来宾操作系统系统处理器使用率使用"逻辑 processor （_total 的 HYPER-V 虚拟机监控程序） %总运行时间"性能监视器计数器：  

  - 使用小于 60%= 正常  

  - 60%-89 消耗 %= 监视或注意  

  - 90%-100%使用 = 严重，性能将受到负面影响  

    若要排查的来宾操作系统上的 HYPER-V 环境的处理器性能，最好是为主机操作系统所报告的值之间的平衡而努力"\Hyper-V 虚拟机监控程序逻辑 processor （_total)\\%总运行时间"(LPTR) 和"虚拟 processor （_total \Hyper-V 虚拟机监控程序)\\%总运行时间"(VPTR)。 如果 LPTR 是高还是低 VPTR 然后验证是否不超过物理计算机上以物理方式可分配给虚拟机的处理器越多。 使用"虚拟机监控程序虚拟 Processor(*) \Hyper-V\\来宾运行时间百分比"计数器，以确定哪些虚拟处理器占用 CPU 并解除分配虚拟处理器的虚拟机作为在适当配置的一对一映射虚拟处理器到逻辑处理器。 有关配置虚拟处理器到逻辑处理器的一对一映射的详细信息，请参阅中的"优化处理器性能"一节[清单： 优化 HYPER-V 上的性能](~/technical-guides/checklist-optimizing-performance-on-hyper-v.md)。 如果 VPTR 是高还是低 LPTR 请考虑分配给虚拟机的附加处理器，如果有可用逻辑处理器和额外的处理器支持的来宾操作系统。 在 VPTR 是高的情况下，LPTR 较低，没有可用逻辑处理器分配，但额外的处理器不支持的来宾操作系统，请考虑向外扩展通过将其他虚拟机添加到物理计算机和分配到这些虚拟机可用的处理器。 VPTR 和 LPTR 较高的情况下，在配置推送的物理计算机的限制，并应考虑向外扩展通过将另一台物理计算机和其他 HYPER-V 虚拟机添加到环境。 下面的流程图描述的 HYPER-V 环境中的处理器性能故障排除时，应使用的过程。  

    如果 VPTR 较高并且 LPTR 较低，请考虑分配给虚拟机的附加处理器，如果有可用逻辑处理器和额外的处理器支持的来宾操作系统。 在 VPTR 是高的情况下，LPTR 较低，没有可用逻辑处理器分配，但额外的处理器不支持的来宾操作系统，请考虑向外扩展通过将其他虚拟机添加到物理计算机和分配到这些虚拟机可用的处理器。 VPTR 和 LPTR 较高的情况下，在配置推送的物理计算机的限制，并应考虑向外扩展通过将另一台物理计算机和其他 HYPER-V 虚拟机添加到环境。 下面的流程图描述的 HYPER-V 环境中的处理器性能故障排除时，应使用的过程。  

    ![在超 CPU 性能故障排除&#45;V](../technical-guides/media/623fdcd6-e80b-4ba9-bf46-5d9b92b6612b.gif "623fdcd6-e80b-4ba9-bf46-5d9b92b6612b")  
    在 HYPER-V 环境中的 CPU 性能故障排除  

  > [!NOTE]  
  >  **来宾操作系统的处理器不具有组关联到物理处理器/核心**– 虚拟机监控程序确定如何物理资源使用。 在处理器利用率的情况下在虚拟机监控程序计划线程的窗体中物理处理器的来宾处理器时间。 这意味着虚拟机的处理器负载将分布在物理计算机的处理器。 此外，虚拟机不能超过配置的例如，如果一台虚拟机配置为使用 2 个逻辑处理器 8 处理器/核心的使用的物理计算机上运行的逻辑处理器数的处理器使用率则虚拟机不能超过配置的逻辑处理器 （在这种情况下 2 个处理器） 的数目的处理器能力。  

- **测量总处理器使用率的在 HYPER-V 环境中使用的 HYPER-V 性能监视计数器-** 为了测量处理器使用率，主机操作系统逻辑上被视为只是另一个来宾操作系统. 因此，"\Processor(*)\\%Processor Time"监视器计数器测量主机操作系统系统的处理器使用率。 若要测量总物理处理器使用率的主机操作系统和所有来宾操作系统，请使用"\Hyper-V 虚拟机监控程序逻辑 processor （_total)\\%总运行时间"性能监视器计数器。 此计数器测量由处理器运行这两个主机操作系统所用时间的总百分比和所有来宾操作系统。  

   使用以下阈值评估的 HYPER-V 环境使用的处理器总体利用率"\Hyper-V 虚拟机监控程序逻辑 processor （_total)\\%总运行时间"性能监视器计数器：  

  - 使用小于 60%= 正常  

  - 60%-89 消耗 %= 监视或注意  

  - 90%-100%使用 = 严重，性能将受到负面影响  

    有关处理器使用率的详细信息查看以下资源：  

  - "How To： 标识导致高用户模式 CPU 瓶颈为服务器应用程序在生产环境中的函数"处[ http://go.microsoft.com/fwlink/?LinkID=107047 ](http://go.microsoft.com/fwlink/?LinkID=107047)。  

  - "第 15 章-测量.NET 应用程序性能"处[ http://go.microsoft.com/fwlink/?LinkId=121073 ](http://go.microsoft.com/fwlink/?LinkId=121073)。
