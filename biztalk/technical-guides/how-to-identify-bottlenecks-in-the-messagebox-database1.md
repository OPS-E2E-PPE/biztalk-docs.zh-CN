---
title: 如何找出 MessageBox 数据库 1 的瓶颈 |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 1a039164-5ca6-4cbc-b307-c5d4ae800689
caps.latest.revision: 7
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 60a2c736c191bf38fe1b11d42b900f2d10aece8d
ms.sourcegitcommit: 381e83d43796a345488d54b3f7413e11d56ad7be
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/07/2019
ms.locfileid: "65400420"
---
# <a name="how-to-identify-bottlenecks-in-the-messagebox-database"></a><span data-ttu-id="24a73-102">如何找出 MessageBox 数据库的瓶颈</span><span class="sxs-lookup"><span data-stu-id="24a73-102">How to Identify Bottlenecks in the MessageBox Database</span></span>
<span data-ttu-id="24a73-103">若要找出 MessageBox 数据库的瓶颈，首先要确保 SQL Server 代理服务已启动。</span><span class="sxs-lookup"><span data-stu-id="24a73-103">To identify bottlenecks in the MessageBox database, first ensure that the SQL-Server-Agent Service is started.</span></span> <span data-ttu-id="24a73-104">将服务的启动状态从手动更改为自动，以便重新启动服务器，如果该服务将自动重新启动。</span><span class="sxs-lookup"><span data-stu-id="24a73-104">Change the Service startup state from Manual to Auto so that if the server is restarted, the service will automatically restart.</span></span>  
  
 <span data-ttu-id="24a73-105">默认情况下，BizTalk 服务会限制如果 Spool、 TrackingData 或 ApplicationQ 表增大。</span><span class="sxs-lookup"><span data-stu-id="24a73-105">By default, the BizTalk service will throttle if the Spool, TrackingData, or ApplicationQ tables grow.</span></span> <span data-ttu-id="24a73-106">这些表进行削减 SQL 代理作业，其中，如果未在运行将导致后台处理增长导致服务限流，到启动和保护数据库免受更大压力。</span><span class="sxs-lookup"><span data-stu-id="24a73-106">These tables are pruned by SQL-Agent jobs, which, if not running will cause the Spool to grow causing throttling to start and protect the database from additional pressure.</span></span> <span data-ttu-id="24a73-107">检查下列性能计数器的状态：</span><span class="sxs-lookup"><span data-stu-id="24a73-107">Check the status of the following performance counters:</span></span>  
  
- <span data-ttu-id="24a73-108">BizTalk:Message Agent (Host Name) Message Delivery Throttling State</span><span class="sxs-lookup"><span data-stu-id="24a73-108">BizTalk:Message Agent (Host Name) Message Delivery Throttling State</span></span>  
  
- <span data-ttu-id="24a73-109">BizTalk:Message Agent (Host Name) Message Publishing Throttling State</span><span class="sxs-lookup"><span data-stu-id="24a73-109">BizTalk:Message Agent (Host Name) Message Publishing Throttling State</span></span>  
  
  <span data-ttu-id="24a73-110">"0"表示没有发生限流。</span><span class="sxs-lookup"><span data-stu-id="24a73-110">A value of “0” indicates no throttling is occurring.</span></span> <span data-ttu-id="24a73-111">"6"表示由于数据库增长而阻止系统。</span><span class="sxs-lookup"><span data-stu-id="24a73-111">A value of “6” indicates the system is throttling due to database growth.</span></span> <span data-ttu-id="24a73-112">有关如何解释这些计数器的值的信息，请参阅[主机限制是什么？](http://go.microsoft.com/fwlink/?LinkID=154694)</span><span class="sxs-lookup"><span data-stu-id="24a73-112">For information about how to interpret the values of these counters, see [What is Host Throttling?](http://go.microsoft.com/fwlink/?LinkID=154694)</span></span> <span data-ttu-id="24a73-113">(http://go.microsoft.com/fwlink/?LinkID=154694)并[主机阻止性能计数器](http://go.microsoft.com/fwlink/?LinkID=155285)(http://go.microsoft.com/fwlink/?LinkID=155285) BizTalk Server 2010 文档中。</span><span class="sxs-lookup"><span data-stu-id="24a73-113">(http://go.microsoft.com/fwlink/?LinkID=154694) and [Host Throttling Performance Counters](http://go.microsoft.com/fwlink/?LinkID=155285) (http://go.microsoft.com/fwlink/?LinkID=155285) in the BizTalk Server 2010 documentation.</span></span>  
  
## <a name="spool-table-growth"></a><span data-ttu-id="24a73-114">后台处理表的增长</span><span class="sxs-lookup"><span data-stu-id="24a73-114">Spool table growth</span></span>  
 <span data-ttu-id="24a73-115">导致 Spool 增长的原因有多种。</span><span class="sxs-lookup"><span data-stu-id="24a73-115">The Spool can start growing for multiple reasons.</span></span> <span data-ttu-id="24a73-116">后台处理增长的原因之一是如果应用程序队列的增长。</span><span class="sxs-lookup"><span data-stu-id="24a73-116">One reason for Spool growth is if the Application Queues are growing.</span></span> <span data-ttu-id="24a73-117">其增长可能由于例如下游瓶颈和/或资源争用的原因。</span><span class="sxs-lookup"><span data-stu-id="24a73-117">They could grow due to reasons such as downstream bottlenecks and/or resource contention.</span></span>  
  
 <span data-ttu-id="24a73-118">如果应用程序队列很小，Spool 却很大，请验证够清除作业。</span><span class="sxs-lookup"><span data-stu-id="24a73-118">If the Application Queues are small and the Spool is still large, verify that the purge jobs are keeping up.</span></span> <span data-ttu-id="24a73-119">请确保 SQL 代理服务正在运行，然后验证下列作业是否成功完成：</span><span class="sxs-lookup"><span data-stu-id="24a73-119">Ensure that the SQL-Agent Service is running and then verify that the following jobs are successfully completing:</span></span>  
  
- <span data-ttu-id="24a73-120">MessageBox_Message_Cleanup_BizTalkMessageBoxDb</span><span class="sxs-lookup"><span data-stu-id="24a73-120">MessageBox_Message_Cleanup_BizTalkMessageBoxDb</span></span>  
  
- <span data-ttu-id="24a73-121">MessageBox_Parts_Cleanup_BizTalkMessageBoxDb</span><span class="sxs-lookup"><span data-stu-id="24a73-121">MessageBox_Parts_Cleanup_BizTalkMessageBoxDb</span></span>  
  
  <span data-ttu-id="24a73-122">如果 MessageZeroSum 表很大，则表示已处理消息。</span><span class="sxs-lookup"><span data-stu-id="24a73-122">If the MessageZeroSum table is large, it indicates that the messages have been processed.</span></span> <span data-ttu-id="24a73-123">这意味着，取消排队已成功完成，并且从应用程序队列表中删除数据行已标记为待删除。</span><span class="sxs-lookup"><span data-stu-id="24a73-123">This means that DeQueue has successfully completed and deleted data from the Application Queue tables and the rows have been flagged for deletion.</span></span> <span data-ttu-id="24a73-124">但清除作业不能及时删除数据。</span><span class="sxs-lookup"><span data-stu-id="24a73-124">However, the purge jobs are unable to keep up with deleting the data.</span></span> <span data-ttu-id="24a73-125">如果运行 SQL Server 的计算机遇到严重的 CPU 资源争用，影响清除作业能够跟上由于 CPU 资源不足，则可能发生此问题。</span><span class="sxs-lookup"><span data-stu-id="24a73-125">This can happen if the computer running SQL Server is experiencing severe CPU contention, affecting the ability of the purge jobs to keep up due to CPU starvation.</span></span>  
  
## <a name="application-queue-table-growth"></a><span data-ttu-id="24a73-126">应用程序队列表的增长</span><span class="sxs-lookup"><span data-stu-id="24a73-126">Application queue table growth</span></span>  
 <span data-ttu-id="24a73-127">应用程序队列承载正在进行的转换数据，处理后立即由 DeQueue 清除。</span><span class="sxs-lookup"><span data-stu-id="24a73-127">Application Queues host in-flight transition data that, once processed, are cleaned up by DeQueue.</span></span>  
  
 <span data-ttu-id="24a73-128">这些消息经过处理后，可以清理 Spool 表 （存有对这些行的引用）。</span><span class="sxs-lookup"><span data-stu-id="24a73-128">After these messages are processed, the Spool table (holding references to these rows) can be cleaned.</span></span>  
  
 <span data-ttu-id="24a73-129">例如，RxHostQ 将数据发布到业务流程 PxHostQ。</span><span class="sxs-lookup"><span data-stu-id="24a73-129">For example, the RxHostQ publishes data to the orchestration PxHostQ.</span></span> <span data-ttu-id="24a73-130">此队列将数据发布到发送 txhostq，它们每个引用后台处理表中的行。</span><span class="sxs-lookup"><span data-stu-id="24a73-130">This queue publishes data to the sending TxHostQ each referencing a row in the Spool table.</span></span> <span data-ttu-id="24a73-131">通过系统成功处理了特定 HostQ 的消息后，DeQueue 会删除这些行。</span><span class="sxs-lookup"><span data-stu-id="24a73-131">After the messages for a particular HostQ have successfully processed through the system, these rows are deleted by DeQueue.</span></span> <span data-ttu-id="24a73-132">删除这些行后，清除作业就可以清理 Spool（已不再被这些行引用）了。</span><span class="sxs-lookup"><span data-stu-id="24a73-132">After these rows are deleted, the Spool (which is no longer referenced by these rows) can then be cleaned by the purge jobs.</span></span>  
  
 <span data-ttu-id="24a73-133">应用程序队列的增长说明负责排出应用程序队列的主机实例不能跟上传入速率。</span><span class="sxs-lookup"><span data-stu-id="24a73-133">Application Queue growth indicates that the host instances responsible for draining the Application Queue are unable to keep up with the incoming rate.</span></span>  
  
 <span data-ttu-id="24a73-134">例如，由于负责处理业务流程的服务器争夺不到更多的 CPU 资源而无法加快处理速度，这就会导致业务流程应用程序队列 (PxHostQ) 增长。</span><span class="sxs-lookup"><span data-stu-id="24a73-134">For example, the orchestration application queue (PxHostQ) may grow because the server responsible for processing orchestrations is CPU bound and unable to process any faster.</span></span> <span data-ttu-id="24a73-135">但是，如果接收的服务器的速度很快，它可能可以比业务流程服务器可以处理应用程序队列增长导致更快地发布。</span><span class="sxs-lookup"><span data-stu-id="24a73-135">However, if the receiving server is fast it may publish faster than what the orchestration server can process leading to the Application Queue growth.</span></span>  
  
 <span data-ttu-id="24a73-136">业务流程队列增长的另一个原因可能是由于内存争用。</span><span class="sxs-lookup"><span data-stu-id="24a73-136">Another reason for orchestration queue growth could be due to memory contention.</span></span> <span data-ttu-id="24a73-137">如果很多长时间运行的业务流程实例同时实例化在内存中，内存膨胀间接导致限流，压缩线程池，直到内存压力得到缓解。</span><span class="sxs-lookup"><span data-stu-id="24a73-137">When many long running orchestration instances are concurrently instantiated in memory, memory bloat indirectly causes throttling to shrink the thread pool until memory pressure is relieved.</span></span>  
  
 <span data-ttu-id="24a73-138">为什么应用程序发送队列可能增长的原因是下游系统是否无法足够快地接收消息 （从 BizTalk Server 传出）。</span><span class="sxs-lookup"><span data-stu-id="24a73-138">A reason why the send application queue may grow is if the downstream system is unable to receive messages (outgoing from BizTalk Server) fast enough.</span></span> <span data-ttu-id="24a73-139">因此，消息将持续驻留在 BizTalk 系统导致应用程序队列增长。</span><span class="sxs-lookup"><span data-stu-id="24a73-139">Thus the messages will continue to reside within the BizTalk system causing Application Queue growth.</span></span> <span data-ttu-id="24a73-140">这可能导致限制，以从开始并且降低接收速率，影响系统的整体吞吐量。</span><span class="sxs-lookup"><span data-stu-id="24a73-140">This can cause throttling to start and reduce the receiving rate impacting the overall throughput of the system.</span></span>  
  
## <a name="trackingdata-table-growth"></a><span data-ttu-id="24a73-141">TrackingData 表的增长</span><span class="sxs-lookup"><span data-stu-id="24a73-141">TrackingData table growth</span></span>  
 <span data-ttu-id="24a73-142">MessageBox 数据库中的 TrackingData 表是侦听器会将运行状况和活动 (HAT) 和业务活动监视 (BAM) 跟踪的跟踪数据写入到其中一个转换表。</span><span class="sxs-lookup"><span data-stu-id="24a73-142">The TrackingData table in the MessageBox database is a transition table into which interceptors write tracking data for both Health and Activity (HAT) and Business Activity Monitoring (BAM) tracking.</span></span> <span data-ttu-id="24a73-143">如果禁用跟踪，则此表将为空。</span><span class="sxs-lookup"><span data-stu-id="24a73-143">If tracking is disabled, this table should be empty.</span></span> <span data-ttu-id="24a73-144">默认情况下，HAT 跟踪可用于管道和业务流程输入/输出事件。</span><span class="sxs-lookup"><span data-stu-id="24a73-144">By default, HAT-tracking is enabled for the pipelines and orchestrations In/Out events.</span></span>  
  
 <span data-ttu-id="24a73-145">如果启用了消息正文跟踪，请确保正在运行的 MessageBox 数据库服务器 （即，使用"允许主机跟踪"的主机）。</span><span class="sxs-lookup"><span data-stu-id="24a73-145">If Message Body Tracking is enabled, ensure that the MessageBox database server (that is, the host with "allow host tracking") is running.</span></span> <span data-ttu-id="24a73-146">确保运行具有"允许主机跟踪"的主机将减少瓶颈发生，因为主机将数据从 MessageBox 数据库中的 TrackingData 表移至 BizTalk 跟踪数据库表的可能性。</span><span class="sxs-lookup"><span data-stu-id="24a73-146">Ensuring that the host with "allow host tracking" is running will reduce the chance of a bottleneck occurring as the host moves data from TrackingData table in the MessageBox database to the BizTalk Tracking database tables.</span></span>  
  
 <span data-ttu-id="24a73-147">它可以通过启用自定义 HAT 跟踪，例如跟踪自定义事件，在升级属性和消息正文跟踪。</span><span class="sxs-lookup"><span data-stu-id="24a73-147">It is possible to track custom events by enabling custom HAT-tracking, for example, on promoted properties and message body tracking.</span></span> <span data-ttu-id="24a73-148">HAT 跟踪数据，除了 BAM 数据也写入 TrackingData 表。</span><span class="sxs-lookup"><span data-stu-id="24a73-148">In addition to HAT-tracking data, BAM data is also written to the TrackingData table.</span></span> <span data-ttu-id="24a73-149">跟踪数据解码服务 (TDDS，启用了跟踪主机实例上运行) 是负责将此数据从 MessageBox 数据库移至 BizTalk 跟踪和 BAM 主导入数据库。</span><span class="sxs-lookup"><span data-stu-id="24a73-149">The Tracking Data Decode Service (TDDS, which runs on the host instance on which tracking is enabled) is responsible for moving this data from the MessageBox database to the BizTalk Tracking and BAM Primary Import databases.</span></span> <span data-ttu-id="24a73-150">然后成功地移动数据后，TDDS 将删除此数据。</span><span class="sxs-lookup"><span data-stu-id="24a73-150">Then after the data is successfully moved, TDDS deletes this data.</span></span> <span data-ttu-id="24a73-151">消息正文跟踪数据另由 SQL 代理作业 TrackedMessages_Copy_BizTalkMsgBoxDb 来移动。</span><span class="sxs-lookup"><span data-stu-id="24a73-151">Message body tracking data is moved separately by a SQL-Agent job TrackedMessages_Copy_BizTalkMsgBoxDb.</span></span>  
  
 <span data-ttu-id="24a73-152">如果 TDDS 无法跟上的侦听器向 TrackingData 表写入数据的速率，此表将增长，导致服务限流，以启动。</span><span class="sxs-lookup"><span data-stu-id="24a73-152">If TDDS is unable to keep up with the rate at which the interceptors are writing data to the TrackingData table, this table will grow, causing throttling to start.</span></span> <span data-ttu-id="24a73-153">这会影响可承受吞吐量。</span><span class="sxs-lookup"><span data-stu-id="24a73-153">This impacts sustainable throughput.</span></span> <span data-ttu-id="24a73-154">若要降低出现此问题，请确保至少一个主机运行启用了跟踪。</span><span class="sxs-lookup"><span data-stu-id="24a73-154">To lessen this problem, ensure at least one host is running with tracking enabled.</span></span>  
  
 <span data-ttu-id="24a73-155">如果数据仍生成，请确保 BizTalk 跟踪数据库不增长失控。</span><span class="sxs-lookup"><span data-stu-id="24a73-155">If the data still builds up, ensure the BizTalk Tracking database is not growing out of control.</span></span> <span data-ttu-id="24a73-156">此外，请确保该存档和清除作业正在运行并且能够及时了解的传入数据的速率。</span><span class="sxs-lookup"><span data-stu-id="24a73-156">Also, ensure the archiving and purging job is running and is able to keep up with the rate at which data is arriving.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="24a73-157">默认情况下，清除作业是无法从 BizTalk 跟踪数据库表中删除数据，直到已存档此数据。</span><span class="sxs-lookup"><span data-stu-id="24a73-157">By default, the purge job is unable to delete data from the BizTalk Tracking database tables until this data has been archived.</span></span> <span data-ttu-id="24a73-158">如果不需要存档跟踪数据，则可以修改该作业，而不进行存档的步骤在清除 BizTalk 跟踪数据库[如何从 BizTalk 跟踪数据库中清除数据](http://go.microsoft.com/fwlink/?LinkID=153817)(http://go.microsoft.com/fwlink/?LinkID=153817)。</span><span class="sxs-lookup"><span data-stu-id="24a73-158">If you do not need to archive the tracking data, you can modify the job to purge the BizTalk Tracking database without archiving by following the steps at [How to Purge Data from the BizTalk Tracking Database](http://go.microsoft.com/fwlink/?LinkID=153817) (http://go.microsoft.com/fwlink/?LinkID=153817).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="24a73-159">请参阅</span><span class="sxs-lookup"><span data-stu-id="24a73-159">See Also</span></span>  
 [<span data-ttu-id="24a73-160">数据库层的瓶颈</span><span class="sxs-lookup"><span data-stu-id="24a73-160">Bottlenecks in the Database Tier</span></span>](../technical-guides/bottlenecks-in-the-database-tier.md)