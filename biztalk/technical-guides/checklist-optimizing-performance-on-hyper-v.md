---
title: 清单： 优化 HYPER-V 上的性能 |Microsoft Docs
ms.custom: ''
ms.date: 06/29/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 942a61eb-0fdd-4c8b-b0ad-d32951f0f631
caps.latest.revision: 23
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: bbd9ec3f47c12107c4ebfc32f109a5248b97a75f
ms.sourcegitcommit: 266308ec5c6a9d8d80ff298ee6051b4843c5d626
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 06/27/2018
ms.locfileid: "36975558"
---
# <a name="checklist-optimizing-performance-on-hyper-v"></a>清单： 优化 HYPER-V 上的性能
以下注意事项适用时运行 BizTalk Server 和/或[!INCLUDE[btsSQLServerNoVersion](../includes/btssqlservernoversion-md.md)]的 HYPER-V 虚拟机具有 BizTalk Server 数据库的实例。  

## <a name="allocate-110125-of-cpu-and-disk-resources-to-the-hyper-v-virtual-machines"></a>分配给 HYPER-V 虚拟机的 110%– 125%的 CPU 和磁盘资源  
 计划分配 110%到 125%的 CPU 资源和 105%-110%的解决方案所使用的 HYPER-V 虚拟机的物理硬件解决方案所需的磁盘资源。 通过使用其他资源配置的 HYPER-V 虚拟机，您需要确保它可以提供与物理硬件相媲美的性能，同时容纳所需的 HYPER-V 虚拟化技术的任何开销。  


|                                                                                      步骤                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    参考                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|                      作用域的硬件要求[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]解决方案。                       | -按照的"Planning the 环境的 BizTalk Server"部分中的指导[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]操作指南，网址[ http://go.microsoft.com/fwlink/?LinkId=122399 ](http://go.microsoft.com/fwlink/?LinkId=122399)确定解决方案的硬件要求的范围。<br />-到作用域的版本和所需的解决方案的 BizTalk 服务器数量查看 BizTalk Server 在规划注意事项"规划 BizTalk Server 层"中所述[ http://go.microsoft.com/fwlink/?LinkId=122401 ](http://go.microsoft.com/fwlink/?LinkId=122401)。<br />-若要确定范围的版本和数量[!INCLUDE[btsSQLServerNoVersion](../includes/btssqlservernoversion-md.md)]解决方案，将所需的计算机上查看的规划注意事项"规划数据库层"中所述的数据库[ http://go.microsoft.com/fwlink/?LinkId=122402 ](http://go.microsoft.com/fwlink/?LinkId=122402)和"性能在 HYPER-V 中运行 SQL Server 的系统开销"部分可在"运行 SQL Server 2008 in a HYPER-V 环境最佳实践和性能注意事项"白皮书[ http://go.microsoft.com/fwlink/?LinkId=144622 ](http://go.microsoft.com/fwlink/?LinkId=144622)。<br />-若要完成规划开发、 测试、 过渡和生产环境查看"规划开发、 测试、 过渡和生产环境"网址[ http://go.microsoft.com/fwlink/?LinkId=122403 ](http://go.microsoft.com/fwlink/?LinkId=122403)。 |
| 作用域 BizTalk Server 解决方案的硬件要求之后, 计划配置的 HYPER-V 计算机**110 – 125%** 的 CPU 和磁盘资源在可能的情况。 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            例如，如果解决方案所使用的物理 BizTalk Server 计算机的硬件要求被确定为 2 GB RAM，双核 CPU 运行在 2 GHZ 和 2 x 500 GB 的物理磁盘，则理想情况下，该解决方案使用的 HYPER-V 虚拟机应配置具有 2 个或更多个虚拟处理器运行 > = 2.2 GHZ，并更快的物理磁盘 （通常通过增加主轴数，或使用更快的磁盘）。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |

## <a name="optimize-hyper-v-performance"></a>优化 HYPER-V 的性能  
 使用以下常规准则配置 HYPER-V 以获得最佳性能。  

|步骤|参考|  
|----------|---------------|  
|应用的性能优化虚拟化服务器推荐的指导。 **注意：** 的测试方案中所述[测试 BizTalk Server 虚拟化性能](~/technical-guides/testing-biztalk-server-virtualization-performance.md)，已应用的配置选项所述"物理基础结构详细信息"和"虚拟化详细信息"部分[测试方案概述](~/technical-guides/test-scenario-overview.md)主题。|在"性能优化准则的 Windows Server 2008 R2"文档"的虚拟化服务器的性能优化"部分[ http://go.microsoft.com/fwlink/?LinkID=202087 ](http://go.microsoft.com/fwlink/?LinkID=202087)。|  
|关闭不会使用任何虚拟机连接窗口。|当双击虚拟机名称中的 HYPER-V 管理器时显示的虚拟机连接窗口使用无法否则利用的资源。|  
|关闭或最小化的 HYPER-V 管理器。|HYPER-V 管理器会通过不断轮询每个运行的虚拟机的 CPU 使用率和正常运行时间占用资源。 关闭或最小化的 HYPER-V 管理器将释放这些资源。|  

## <a name="optimize-performance-of-disk-memory-network-and-processor-in-a-hyper-v-environment"></a>优化磁盘、 内存、 网络和处理器的 HYPER-V 环境中的性能  
 使用以下准则来优化磁盘、 内存、 网络和处理器的 HYPER-V 虚拟环境中的性能。  

### <a name="optimize-processor-performance"></a>优化处理器性能  
 请遵循以下准则来优化来宾操作系统的 HYPER-V 虚拟环境中运行的处理器性能：  

- **配置虚拟处理器到为了获得最佳性能-可用逻辑处理器的 1 对 1 分配**运行时 CPU 密集型应用程序，最佳配置是 1 对 1 到来宾操作系统中的虚拟处理器比率逻辑处理器可供主机操作系统中。 任何其他配置如 2:1 或 1:2 会降低效率。 下图演示了到逻辑处理器可供主机操作系统的来宾操作系统中的虚拟处理器内核的 1 对 1 分配：  

   ![One to One Physical to Virtual Processor Ratio](../technical-guides/media/90f98f0d-a223-404c-b419-81369dc92970.gif "一对一物理到虚拟处理器比率")  
  虚拟与逻辑处理器比率  

- **请注意不同的来宾操作系统的虚拟处理器限制并进行相应的规划**可供 HYPER-V 虚拟机中运行的来宾操作系统的处理器内核数可能会影响整体承载的应用程序的性能。 因此，应考虑有关来宾操作系统将安装在 HYPER-V 虚拟机来托管 BizTalk Server 上和/或[!INCLUDE[btsSQLServerNoVersion](../includes/btssqlservernoversion-md.md)]承载 BizTalk Server 数据库的实例。 HYPER-V 可容纳以下指定的来宾操作系统的虚拟处理器数：  

|                                                                      操作系统                                                                       | 虚拟处理器限制 |
|-------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------|
| [!INCLUDE[btsWinSvr2k8R2](../includes/btswinsvr2k8r2-md.md)]的用户。 所有版本的[!INCLUDE[btsWinSvr2k8R2](../includes/btswinsvr2k8r2-md.md)]只有 64 位。 |            4            |
|                                               [!INCLUDE[btsWinSvr2k8](../includes/btswinsvr2k8-md.md)] 64 位                                               |            4            |
|                                               [!INCLUDE[btsWinSvr2k8](../includes/btswinsvr2k8-md.md)] 32 位                                               |            4            |
|                                                                      Windows 7 64 位                                                                       |            4            |
|                                                                      Windows 7 32 位                                                                       |            4            |
|                                                                    64 位 Windows Vista                                                                     |            2            |
|                                                                    Windows Vista 32 位                                                                    |            2            |

> [!NOTE]
>  有关 HYPER-V 支持的来宾操作系统的详细信息，请参阅[ http://go.microsoft.com/fwlink/?LinkID=118347 ](http://go.microsoft.com/fwlink/?LinkID=118347)。  

### <a name="optimize-disk-performance"></a>优化磁盘性能  
 请遵循以下准则来优化磁盘性能的来宾操作系统的 HYPER-V 虚拟环境中运行：  

|步骤|参考|  
|----------|---------------|  
|配置用于虚拟磁盘的 HYPER-V 虚拟机使用固定大小虚拟硬盘 (VHD) 选项。 固定大小 VHD 可提供接近的功能，例如群集的支持和快照的磁盘支持的灵活性以及物理磁盘的性能。|通过虚拟 IDE 控制器或虚拟 SCSI 控制器可访问的 HYPER-V 环境中的磁盘存储。 与以前版本的 Microsoft 虚拟化技术，是访问虚拟硬盘时，使用虚拟 IDE 控制器或虚拟 SCSI 控制器之间没有性能差异。 以下的磁盘存储选项是可用于在 HYPER-V 环境中使用：<br /><br /> -   **固定大小磁盘-** 固定大小虚拟硬盘 (VHD) 是一个数据块是在创建时定义的最大磁盘大小的物理磁盘上预先分配。 例如，如果您创建的 100 GB 的固定大小 VHD，HYPER-V 将分配所有 100 GB 的数据块存储，除了创建新的 VHD 时所需的 VHD 页眉和页脚的开销。<br />-   **动态扩展磁盘-** 动态扩展 VHD 是一个为其初始虚拟硬盘包含任何数据块。 而是动态分配空间，随着数据写入到 VHD，最多创建 VHD 时指定的最大大小。 例如，100 GB 动态扩展磁盘最初包含仅 VHD 标头，并且需要小于 2 MB 的物理存储空间。 虚拟机的情况下，新数据写入到动态扩展 VHD，会以 2 MB 到 VHD 文件，最多为 100 GB 的增量分配其他物理数据块。<br />-   **差异磁盘-** 差异磁盘是一种特殊类型的动态扩展的"父级"VHD 与关联的 VHD 文件。 在此父/子存储拓扑中，父磁盘保持不变，"子"差异磁盘仅对所做的任何写入操作。 任何读取的操作首先检查对差异磁盘，以查看更新的内容已写入到差异磁盘;如果内容不在差异磁盘，然后从父 VHD 读取内容。 差异磁盘可用于需要维护特定基准配置和想要轻松地测试和回滚然后更改到基线的方案。 可用于测试的父/子存储拓扑通过差异磁盘提供灵活性时，这不是性能的最佳配置因为没有与维护父/子拓扑相关的开销使用差异磁盘时需要。<br />-   **传递磁盘，即**传递磁盘功能，来宾操作系统来绕过 HYPER-V 主机文件系统和直接访问磁盘。 都提供给来宾操作系统可通过传递磁盘必须设置为"脱机"中的 HYPER-V 主机以确保，主机和来宾操作系统不要尝试同时访问该磁盘。 传递磁盘存储选项确实提供了相比其他磁盘的边际性能优势，但不支持的虚拟磁盘，例如虚拟机快照和聚类分析支持特定功能。 因此使用的传递磁盘功能建议不要在 BizTalk 或 SQL Server 环境中因为边际性能优势会超过偏移量为缺少的功能。<br /><br /> 有关磁盘存储选项中使用的 HYPER-V 提供的相对性能的详细信息，请参阅博客文章"HYPER-V 存储分析"，在[ http://go.microsoft.com/fwlink/?LinkID=132848 ](http://go.microsoft.com/fwlink/?LinkID=132848)。|  
|配置为使用 SCSI 控制器的数据卷的磁盘|此建议，因为如果安装 HYPER-V 集成服务，而无需安装 HYPER-V 集成服务中，模拟的 IDE 控制器可用，可以仅安装 SCSI 控制器。 使用 integration services 提供的 IDE 筛选器驱动程序执行的磁盘 I/O 是明显优于磁盘 I/O 性能提供与仿真的 IDE 控制器。 因此，若要确保获得最佳磁盘 I/O 性能的 HYPER-V 虚拟化环境中的数据文件，主机和来宾操作系统上安装集成服务并将数据卷的磁盘合成 SCSI 控制器的配置。 对于跨多个数据驱动器的高密集型存储 I/O 工作负荷，每个 VHD 应附加到单独的合成 SCSI 控制器以提高整体性能。 此外，每个 VHD 应存储在单独的物理磁盘上。 **重要说明：** 不将系统磁盘附加到 SCSI 控制器。 包含一个操作系统虚拟硬盘必须附加到 IDE 控制器。|  

### <a name="optimize-memory-performance"></a>优化内存性能  
 请遵循以下准则来优化的 HYPER-V 虚拟环境中运行的来宾操作系统的内存性能：  

|步骤|参考|  
|----------|---------------|  
|确保有足够的内存将托管的 HYPER-V 虚拟机的物理计算机上安装|可用物理内存通常是 HYPER-V 虚拟机上运行的 BizTalk Server 性能的最重要因素。 这是因为每个虚拟机必须驻留在非分页缓冲池内存中或不能分页到磁盘的内存。 因为非页面缓冲池内存不能分页到磁盘，托管虚拟机的物理计算机应具有的内存总量的可用物理内存分配的每个虚拟机以及下列：<br />     虚拟机监控程序的 300 MB 加上 32 MB 的第一个 GB 的 RAM 分配给每个虚拟机、 另一个 8 MB 的每个其他 GB 的 RAM 分配给每个虚拟机和主机的 512 MB根分区上运行的操作系统<br />     例如，如果 HYPER-V 虚拟机所分配到 2 GB 的内存中的 HYPER-V 管理器，当运行的 HYPER-V 虚拟机是大约 2388 MB 时使用的实际物理内存 (虚拟机分配的虚拟机监控程序 300 MB + 2 GB +32 MB + 8 MB = 2388 MB)。 虚拟机监控程序只需一次进行加载，因为初始化的后续虚拟机不会产生与加载虚拟机监控程序相关的留出 300 MB 开销。 因此，如果两个 HYPER-V 虚拟机是每个已分配的 2 GB 的内存中的 HYPER-V 管理器，使用这些 HYPER-V 虚拟机运行时的实际物理内存将为大约 4476 MB （虚拟机监控程序 300 MB + 4 GB 为分配的虚拟机 + 64 MB + 16 MB = 4476 MB)。 **注意：** 作为常规经验，计划分配为根分区提供服务，例如 I/O 虚拟化、 快照文件支持和子分区管理至少 512 MB 内存。<br />-   **使用 64 位来宾操作系统时可能**– 请考虑使用为每个来宾操作系统的 64 位操作系统。 这样应做因为默认情况下，32 位 Windows 操作系统仅可以解决最多 2 GB 的每个进程虚拟地址空间。 64 位操作系统的安装允许应用程序充分利用托管的 HYPER-V 虚拟机的物理计算机上安装的内存。|  

### <a name="optimize-network-performance"></a>优化网络性能  
 HYPER-V 虚拟机中支持合成和模拟的网络适配器，但是合成设备提供显著提高性能并减少 CPU 开销。 每个这些适配器连接到虚拟网络交换机，如果需要外部网络连接可以连接到物理网络适配器。 遵循本部分中的建议，以优化网络性能的来宾操作系统的 HYPER-V 虚拟环境中运行。  

> [!NOTE]
>  这些建议是从"性能优化准则的 Windows Server 2008 R2"白皮书可供下载的"性能优化的虚拟化服务器"部分[ http://go.microsoft.com/fwlink/?LinkID=202087 ](http://go.microsoft.com/fwlink/?LinkID=202087)。 有关如何优化在根分区中，包括中断裁决的网络适配器，请参阅本指南的"性能优化的网络子系统"部分。 应将应用在该部分中的 TCP tunings，如果需要，为子分区。  

|                                                                            步骤                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                                                 参考                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|                   若要使用专用虚拟网络在同一的 HYPER-V 主机计算机运行的 HYPER-V 虚拟机配置                   |                                                                                                                                                                                                                                                                                                                                  请遵循中的"配置的 HYPER-V 虚拟机相同的 HYPER-V 上运行的托管计算机以使用专用虚拟网络"部分建议[网络优化](~/technical-guides/network-optimizations.md)。                                                                                                                                                                                                                                                                                                                                  |
|                                                禁用 TCP 卸载虚拟机网卡                                                |                                                                                                                                                                                                                                                                                                                                                               请遵循中的"禁用 TCP 卸载的虚拟机网络卡"部分建议[网络优化](~/technical-guides/network-optimizations.md)。                                                                                                                                                                                                                                                                                                                                                               |
|                                      配置来宾操作系统为使用 HYPER-V 合成网络适配器。                                       |                                                                                                                                                   专为虚拟机以实现显著的合成网络适配器能减少 CPU 开销的 HYPER-V 功能相比到仿真的网络适配器，以模拟现有硬件的网络 I/O。 合成网络适配器之间的效率更高的数据传输使用共享的内存其在 VMBus 上的子和根分区进行通信。 <br />仿真的网络适配器应通过 VM 设置对话框中删除并替换为合成网络适配器。 来宾要求安装 VM 集成服务。                                                                                                                                                    |
|                          如果可用，则启用根分区中的物理网络适配器驱动程序的卸载功能。                          | 因为本机方案中，卸载与物理网络适配器中的功能减少 VM 方案中的网络 I/o 的 CPU 的使用率。 HYPER-V 当前使用 LSOv1 和 TCPv4 校验和卸载。 必须在根分区中的物理网络适配器的驱动程序中启用卸载功能。 有关在网络适配器的卸载功能的详细信息，请参阅"性能优化准则的 Windows Server 2008 R2"白皮书可用于"性能优化的虚拟化服务器"部分的"选择网络适配器"部分在下载[ http://go.microsoft.com/fwlink/?LinkID=202087 ](http://go.microsoft.com/fwlink/?LinkID=202087)。<br />驱动程序对于某些网络适配器禁用 LSOv1，但默认情况下启用 LSOv2。 使用驱动程序，系统管理员必须显式启用 LSOv1**属性**对话框的设备管理器中。 |
|                                        配置网络交换机中的拓扑的多个网络适配器使用。                                         |                                                                                                                                                                                                                                             HYPER-V 支持创建多个虚拟网络交换机，其中每个可以附加到的物理网络适配器必要。 在 VM 中的每个网络适配器可以连接到虚拟网络交换机。 如果物理服务器具有多个网络适配器，网络密集型负载的 Vm 可受益于连接到不同的虚拟交换机，以更好地使用物理网络适配器。                                                                                                                                                                                                                                             |
| 如果在多个物理网络卡安装在 HYPER-V 主机计算机，为一个逻辑处理器到每个网络卡的绑定设备中断。 |                                                                                                                                                                                            在某些工作负荷，绑定到一个逻辑处理器的单个网络适配器设备中断可以提高性能的 HYPER-V。 我们建议此高级优化，仅用于解决特定问题中完全使用的网络带宽。 系统管理员可以使用 IntPolicy 工具以将设备中断绑定到特定的处理器。 有关 IntPolicy 工具的详细信息，请参阅[ http://go.microsoft.com/fwlink/?LinkID=129773 ](http://go.microsoft.com/fwlink/?LinkID=129773)。                                                                                                                                                                                             |
|                                        如果可能，请启用 VLAN 标记的 HYPER-V 合成网络适配器。                                         |                                                                                                                                                                                                                                                 HYPER-V 合成网络适配器支持 VLAN 标记。 如果物理网络适配器支持的 NDIS_ENCAPSULATION_IEEE_802_3_P_AND_Q_IN_OOB 封装为大量发送和校验和卸载，它提供了显著提高网络性能。 如果没有此支持，HYPER-V 要求 VLAN 标记的数据包不能使用硬件卸载功能和可以减少网络性能。                                                                                                                                                                                                                                                 |
|                           高速网络适配器的 HYPER-V 主机计算机上为安装和配置最大性能。                           |                                                                                                                                                                                                                                                                                   -HYPER-V 主机计算机上安装 1 GB 网络适配器，请考虑使用和配置网络适配器而不是使用"自动协商"固定速度是非常重要的网络速度、 双工、 和流控制参数设置为相对应交换机上的设置对它们所连接到。                                                                                                                                                                                                                                                                                   |
|                                                 遵循有关优化网络性能的最佳做法。                                                  |                                                                                                                                                                本主题[网络优化](~/technical-guides/network-optimizations.md)提供了有关优化网络性能的常规指南。 虽然本主题不提供用于优化性能的特定建议[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]中的 HYPER-V 虚拟化环境的技术包括适用于任何[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]解决方案中，是否在物理硬件上或 HYPER-V 上运行虚拟化的环境。                                                                                                                                                                 |

## <a name="optimize-sql-server-performance"></a>优化 SQL Server 性能  
 请按照本主题中的建议[SQL Server 优化](~/technical-guides/sql-server-optimizations.md)以优化 SQL Server 的 BizTalk Server 解决方案的性能。 虽然本主题不提供用于优化性能的特定建议[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]中的 HYPER-V 虚拟化环境的技术包括适用于任何[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]解决方案中，是否在物理硬件上或 HYPER-V 上运行虚拟化的环境。  

## <a name="optimize-biztalk-server-solution"></a>优化 BizTalk Server 解决方案  
 请按照本主题中的建议[BizTalk Server 优化](~/technical-guides/biztalk-server-optimizations.md)优化 BizTalk Server 解决方案的性能。 虽然本主题不提供用于优化性能的特定建议[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]中的 HYPER-V 虚拟化环境的技术包括适用于任何[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]解决方案中，是否在物理硬件上或 HYPER-V 上运行虚拟化的环境。