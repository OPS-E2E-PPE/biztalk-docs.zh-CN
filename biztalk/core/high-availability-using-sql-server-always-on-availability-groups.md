---
title: 使用 SQL Server Always On 可用性组实现高可用性 |Microsoft Docs
description: 若要获取使用 SQL Server Always On 可用组 (AG)，包括系统要求和限制的高可用性 (HA) 解决方案的不同节点上的 BizTalk Server 数据库进行分组。 Always On AG 需要 Windows Server 故障转移群集 (WSFC)。
ms.custom: ''
ms.date: 07/8/2018
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 4511a578-77d2-49ee-99bd-f0406ad625d0
caps.latest.revision: 10
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: d163c035cdf45ede600509783040114a0eaa0a2b
ms.sourcegitcommit: 1f0306e812c95dc32c4496345c19f141612cb2c1
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/09/2018
ms.locfileid: "37913854"
---
# <a name="high-availability-using-sql-server-always-on-availability-groups---biztalk-server"></a><span data-ttu-id="4a0d9-104">使用 SQL Server Always On 可用性组的 BizTalk Server 的高可用性</span><span class="sxs-lookup"><span data-stu-id="4a0d9-104">High Availability using SQL Server Always On Availability Groups - BizTalk Server</span></span>
<span data-ttu-id="4a0d9-105">配置使用 SQL Server AlwaysOn 可用性组实现高可用性。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-105">Configure high availability using SQL Server AlwaysOn availability groups.</span></span>

> [!TIP]
> <span data-ttu-id="4a0d9-106">[设置 BizTalk Server 2016 使用可用性组实验室](https://skastberg.wordpress.com/2017/02/22/setting-up-my-biztalk-server-2016-using-availability-groups-lab/)提供由 Microsoft 现场工程师编写的分步指南。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-106">[Setting up BizTalk Server 2016 using availability groups LAB](https://skastberg.wordpress.com/2017/02/22/setting-up-my-biztalk-server-2016-using-availability-groups-lab/) provides a step-by-step guide written by a Microsoft field engineer.</span></span> <span data-ttu-id="4a0d9-107">它基于在实验室环境中，并包含一些意见。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-107">It is based on a lab environment, and includes some observations.</span></span> <span data-ttu-id="4a0d9-108">其签出。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-108">Check it out.</span></span>  
> 
> [!IMPORTANT]
> * <span data-ttu-id="4a0d9-109">可从 SQL Server 2016 always On 可用性组。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-109">Always On Availability Groups is available starting with SQL Server 2016.</span></span> <span data-ttu-id="4a0d9-110">如果使用以前的 SQL Server 版本，本主题不适用于您。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-110">If you are using a previous SQL Server version, this topic does not apply to you.</span></span> 
> * <span data-ttu-id="4a0d9-111">BizTalk Server 2016 支持同步提交模式;不支持异步提交模式。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-111">BizTalk Server 2016 supports synchronous-commit mode; asynchronous-commit mode is not supported.</span></span> <span data-ttu-id="4a0d9-112">对于灾难恢复，建议配置备份 BizTalk Server 作业，并使用日志传送。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-112">For disaster recovery, it is recommended to configure the Backup BizTalk Server job, and use log shipping.</span></span> <span data-ttu-id="4a0d9-113">请参阅[备份和还原 BizTalk Server 数据库](../core/backing-up-and-restoring-biztalk-server-databases.md)的具体详细信息。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-113">See [Backing Up and Restoring BizTalk Server Databases](../core/backing-up-and-restoring-biztalk-server-databases.md) for specific details.</span></span>
> 
>    <span data-ttu-id="4a0d9-114">[可用性模式](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/availability-modes-always-on-availability-groups)详细介绍与 Alwayson 可用性组的提交选项。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-114">[Availability Modes](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/availability-modes-always-on-availability-groups) details the commit options with Always On Availability Groups.</span></span> 


## <a name="background-and-history"></a><span data-ttu-id="4a0d9-115">背景和历史记录</span><span class="sxs-lookup"><span data-stu-id="4a0d9-115">Background and history</span></span>

<span data-ttu-id="4a0d9-116">BizTalk Server 严重依赖 SQL Server 实现数据持久性。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-116">BizTalk Server relies heavily on SQL Server for data persistence.</span></span> <span data-ttu-id="4a0d9-117">集成完全不同的业务应用程序，如接收、 处理或路由消息时，其他组件和 BizTalk Server 中的主机具有特定的角色。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-117">Other components and hosts in BizTalk Server have specific roles when integrating disparate business applications, such as receiving, processing, or routing messages.</span></span> <span data-ttu-id="4a0d9-118">数据库计算机捕获此工作，并将其保存到磁盘。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-118">The database computer captures this work, and persists it to disk.</span></span> 

<span data-ttu-id="4a0d9-119">BizTalk 使用 SQL Server 故障转移群集和日志传送来为其在本地数据库提供高可用性、 备份和还原和灾难恢复。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-119">BizTalk uses SQL Server Failover Clustering and Log Shipping to provide high availability, backup and restore, and disaster recovery for its on-premises databases.</span></span> <span data-ttu-id="4a0d9-120">在 Azure IaaS （Azure 虚拟机），以前版本的 SQL Server 不支持故障转移群集实例 （没有 MSDTC 支持）。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-120">In Azure IaaS (Azure virtual machines), previous versions of SQL Server do not support Failover Cluster Instances (no MSDTC support).</span></span> <span data-ttu-id="4a0d9-121">因此，BizTalk 不具有高可用性解决方案时使用 Azure Vm。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-121">As a result, BizTalk did not have a HA solution when using Azure VMs.</span></span>

<span data-ttu-id="4a0d9-122">从 SQL Server 2016 开始，SQL Server AlwaysOn 可用性组支持在本地和使用 Azure Vm 的 MSDTC。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-122">Starting with SQL Server 2016, SQL Server AlwaysOn Availability Groups supports MSDTC for on-premises and using Azure VMs.</span></span> <span data-ttu-id="4a0d9-123">因此，BizTalk 数据库的本地或在 Azure IaaS 方案中支持的 SQL Server 2016 AlwaysOn 功能。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-123">As a result, the SQL Server 2016 AlwaysOn feature is supported for BizTalk databases on-premises or in Azure IaaS scenarios.</span></span> 

## <a name="sql-server-2016-alwayson-availability-groups"></a><span data-ttu-id="4a0d9-124">SQL Server 2016 AlwaysOn 可用性组</span><span class="sxs-lookup"><span data-stu-id="4a0d9-124">SQL Server 2016 AlwaysOn Availability Groups</span></span> 
<span data-ttu-id="4a0d9-125">部署 AlwaysOn 可用性组需要 Windows Server 故障转移群集 (WSFC) 群集。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-125">Deploying AlwaysOn Availability Groups requires a Windows Server Failover Clustering (WSFC) cluster.</span></span> <span data-ttu-id="4a0d9-126">给定可用性组的每个可用性副本必须位于相同 WSFC 群集的不同节点上。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-126">Each availability replica of a given availability group must reside on a different node of the same WSFC cluster.</span></span> <span data-ttu-id="4a0d9-127">为您创建的每个可用性组创建一个 WSFC 资源组。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-127">A WSFC resource group is created for every availability group that you create.</span></span> <span data-ttu-id="4a0d9-128">WSFC 群集将监视此资源组，以便评估主副本的运行状况。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-128">The WSFC cluster monitors this resource group to evaluate the health of the primary replica.</span></span>  

<span data-ttu-id="4a0d9-129">下图显示的是一个包含一个主要副本和四个次要副本的可用性组。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-129">The following illustration shows an availability group that contains one primary replica and four secondary replicas.</span></span>  
 
 ![SQLAG_PrimaryReplica](../core/media/sqlag-primaryreplica.png)

<span data-ttu-id="4a0d9-131">客户端可以连接到使用可用性组侦听器为给定的可用性组的主副本。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-131">Clients can connect to the primary replica of a given availability group using an availability group listener.</span></span> <span data-ttu-id="4a0d9-132">可用性组侦听器提供了一组附加到给定的可用性组以便在客户端连接定向到相应的可用性副本的资源。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-132">An availability group listener provides a set of resources that are attached to a given availability group to direct client connections to the appropriate availability replica.</span></span> 

>[!IMPORTANT]
> <span data-ttu-id="4a0d9-133">SQL Server 2016 支持 Windows Server 2016 和 Windows Server 2012 R2 上的 MSDTC 与 AlwaysOn 可用性组 (AG)。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-133">SQL Server 2016 supports MSDTC with AlwaysOn Availability Groups (AG) on Windows Server 2016 and Windows Server 2012 R2.</span></span> <span data-ttu-id="4a0d9-134">**Windows Server 2012 R2**需要[3090973](https://support.microsoft.com/kb/3090973) Windows 修补程序安装。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-134">**Windows Server 2012 R2** requires  the [3090973](https://support.microsoft.com/kb/3090973) Windows hotfix  to be installed.</span></span> 
> <span data-ttu-id="4a0d9-135">**Windows Server 2016**要求[RemoteAccessEnabled 注册表项](https://support.microsoft.com/kb/3182294)启用。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-135">**Windows Server 2016** requires that the [RemoteAccessEnabled registry key](https://support.microsoft.com/kb/3182294) be enabled.</span></span>

<span data-ttu-id="4a0d9-136">对于 2016年之前的任何版本，SQL Server 不支持与 AlwaysOn 可用性组的 MSDTC。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-136">SQL Server does not support MSDTC with AlwaysOn AG for any versions prior to 2016.</span></span>  

<span data-ttu-id="4a0d9-137">SQL Server AlwaysOn 可用性组不支持同一个 SQL Server 实例上的数据库之间的 MSDTC。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-137">MSDTC between databases on same SQL Server instance is not supported with SQL Server AlwaysOn Availability Groups.</span></span> <span data-ttu-id="4a0d9-138">这意味着，可以在同一个 SQL server 实例上承载分布式事务中的任何两个 BizTalk 数据库。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-138">This means that no two BizTalk databases in a distributed transaction can be hosted on the same SQL server instance.</span></span> <span data-ttu-id="4a0d9-139">对于事务一致性，应在不同的 SQL server 实例上托管参与分布式事务中的 BizTalk 数据库。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-139">For transactional consistency, BizTalk databases participating in distributed transaction should be hosted on different SQL server instances.</span></span> <span data-ttu-id="4a0d9-140">请注意它并不重要的 SQL 实例是否在同一台计算机或不同的计算机上。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-140">Note that it does not matter whether SQL instances are on the same computer, or different computers.</span></span> 


## <a name="provide-high-availability-for-biztalk-databases-using-alwayson-availability-groups"></a><span data-ttu-id="4a0d9-141">为使用 AlwaysOn 可用性组的 BizTalk 数据库提供高可用性</span><span class="sxs-lookup"><span data-stu-id="4a0d9-141">Provide high availability for BizTalk databases using AlwaysOn Availability Groups</span></span> 
<span data-ttu-id="4a0d9-142">在 BizTalk Server 基本配置中，数据库就会将一个最少为 9 的数据库创建包括规则和 BAM。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-142">In the basic configuration of BizTalk Server, a minimum of 9 databases are created including Rules and BAM databases.</span></span> <span data-ttu-id="4a0d9-143">由于 MSDTC 可用性组限制前文所述，如下面的配置不能确保事务一致性。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-143">Due to the MSDTC limitation with Availability Groups mentioned previously, a configuration such as following does not ensure transactional consistency.</span></span> 

![SQLAG_NoTrans](../core/media/sqlag-notrans.gif)
 
<span data-ttu-id="4a0d9-145">我们建议使用 BizTalk Server 数据库可分为以下四个 SQL Server 实例：</span><span class="sxs-lookup"><span data-stu-id="4a0d9-145">We recommend that the BizTalk Server databases are grouped into the following four SQL Server instances:</span></span>
 
| <span data-ttu-id="4a0d9-146">实例</span><span class="sxs-lookup"><span data-stu-id="4a0d9-146">Instance</span></span> |<span data-ttu-id="4a0d9-147">角色</span><span class="sxs-lookup"><span data-stu-id="4a0d9-147">Role</span></span> |<span data-ttu-id="4a0d9-148">该组中的 BizTalk 数据库</span><span class="sxs-lookup"><span data-stu-id="4a0d9-148">BizTalk Databases in that group</span></span>  |
|--- | --- | ---|
|<span data-ttu-id="4a0d9-149">@shouldalert</span><span class="sxs-lookup"><span data-stu-id="4a0d9-149">1</span></span> |<span data-ttu-id="4a0d9-150">身份验证</span><span class="sxs-lookup"><span data-stu-id="4a0d9-150">Authentication</span></span> |<span data-ttu-id="4a0d9-151">SSODB</span><span class="sxs-lookup"><span data-stu-id="4a0d9-151">SSODB</span></span>|
|<span data-ttu-id="4a0d9-152">2</span><span class="sxs-lookup"><span data-stu-id="4a0d9-152">2</span></span> |<span data-ttu-id="4a0d9-153">管理</span><span class="sxs-lookup"><span data-stu-id="4a0d9-153">Management</span></span> |<span data-ttu-id="4a0d9-154">BizTalkMgmtDb</span><span class="sxs-lookup"><span data-stu-id="4a0d9-154">BizTalkMgmtDb</span></span>| 
|<span data-ttu-id="4a0d9-155">3</span><span class="sxs-lookup"><span data-stu-id="4a0d9-155">3</span></span> |<span data-ttu-id="4a0d9-156">运行时</span><span class="sxs-lookup"><span data-stu-id="4a0d9-156">Runtime</span></span> |<span data-ttu-id="4a0d9-157">BizTalkMsgBoxDb</span><span class="sxs-lookup"><span data-stu-id="4a0d9-157">BizTalkMsgBoxDb</span></span><br/> <span data-ttu-id="4a0d9-158">BizTalkRulesEngineDb</span><span class="sxs-lookup"><span data-stu-id="4a0d9-158">BizTalkRulesEngineDb</span></span><br/> <span data-ttu-id="4a0d9-159">BAMPrimaryImport</span><span class="sxs-lookup"><span data-stu-id="4a0d9-159">BAMPrimaryImport</span></span><br/><span data-ttu-id="4a0d9-160">BAMStarSchema</span><span class="sxs-lookup"><span data-stu-id="4a0d9-160">BAMStarSchema</span></span> <br/><span data-ttu-id="4a0d9-161">BAMAlertsApplication</span><span class="sxs-lookup"><span data-stu-id="4a0d9-161">BAMAlertsApplication</span></span> |
|<span data-ttu-id="4a0d9-162">4</span><span class="sxs-lookup"><span data-stu-id="4a0d9-162">4</span></span> |<span data-ttu-id="4a0d9-163">跟踪</span><span class="sxs-lookup"><span data-stu-id="4a0d9-163">Tracking</span></span> |<span data-ttu-id="4a0d9-164">BizTalkDTADb</span><span class="sxs-lookup"><span data-stu-id="4a0d9-164">BizTalkDTADb</span></span><br/><span data-ttu-id="4a0d9-165">EsbItineraryDb</span><span class="sxs-lookup"><span data-stu-id="4a0d9-165">EsbItineraryDb</span></span><br/><span data-ttu-id="4a0d9-166">EsbExceptionDb</span><span class="sxs-lookup"><span data-stu-id="4a0d9-166">EsbExceptionDb</span></span> | 
 
<span data-ttu-id="4a0d9-167">在向外扩展 MessageBox 方案 （使用多个 MessageBox 的配置） 中，没有多个 MessageBox 数据库，并且每个 MessageBox 数据库必须位于其自己的 SQL Server 实例上。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-167">In a scaled-out MessageBox scenario (a configuration with more than one MessageBox), there is more than one MessageBox database, and each MessageBox database must be on its own SQL Server instance.</span></span> 

<span data-ttu-id="4a0d9-168">BizTalk Server 还依赖于 SQL Server Analysis Services 和 BAM 分析和存档的 SQL Server Integration Services。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-168">BizTalk Server also depends on SQL Server Analysis Services and SQL Server Integration Services for BAM Analysis and Archiving.</span></span> <span data-ttu-id="4a0d9-169">Integration Services 或 Azure IaaS 中的 Analysis Services，SQL Server 不提供高可用性解决方案。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-169">SQL Server does not provide a high availability solution for Integration Services or Analysis Services in Azure IaaS.</span></span> <span data-ttu-id="4a0d9-170">因此建议为 BAMArchive 和 BAMAnalysis Analysis Services 数据库使用其他独立 SQL Server 实例。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-170">It is therefore recommended to use another standalone SQL Server instance for the BAMArchive and BAMAnalysis Analysis Services databases.</span></span> <span data-ttu-id="4a0d9-171">对于在本地安装，可以设置高可用性配置使用 SQL 故障转移群集实例。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-171">For on-premises installations, SQL Failover Clustering Instance can be used for setting up a high availability configuration.</span></span> 

<span data-ttu-id="4a0d9-172">此配置是，如下图所示，建议在可用性组中的 BizTalk 数据库：</span><span class="sxs-lookup"><span data-stu-id="4a0d9-172">This configuration is illustrated below, and recommended for BizTalk Databases in Availability Groups:</span></span>  

![SQLAG_Recommended](../core/media/sqlag-recommended.png)
 
<span data-ttu-id="4a0d9-174">SQL Server 数据库，以及 BizTalk Server 配置还会创建 SQL Server 安全登录名和 SQL 代理作业。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-174">Along with SQL Server databases, BizTalk Server configuration also creates SQL Server security logins and SQL Agent Jobs.</span></span> <span data-ttu-id="4a0d9-175">AlwaysOn 可用性组仅提供的功能来管理在可用性组的数据库。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-175">AlwaysOn Availability Groups only provide the ability to manage databases inside an Availability Group.</span></span> <span data-ttu-id="4a0d9-176">登录名和 BizTalk 的 SQL 代理作业需要创建并更新/手动管理所有可用性副本。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-176">Logins and SQL Agent Jobs for BizTalk need to be created and updated/managed manually on all the availability replicas.</span></span>  

> [!NOTE]
> <span data-ttu-id="4a0d9-177">SQL Server 2016 Service Pack 2 和同一可用性组中的多个数据库之间的更高版本支持 DTC 事务。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-177">SQL Server 2016 Service Pack 2 and newer supports DTC transactions between multiple databases within the same Availability Group.</span></span> <span data-ttu-id="4a0d9-178">BizTalk Server 支持与 CU5 启动此功能。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-178">BizTalk Server supports this functionality starting with CU5.</span></span>
> <span data-ttu-id="4a0d9-179">在配置 BizTalk Server 2016 的 SQL Server 2016 Service Pack 2 和更高版本时，所有 BizTalk Server 数据库可以都部署到单个可用性组。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-179">When configuring BizTalk Server 2016 with SQL Server 2016 Service Pack 2 and newer, all BizTalk Server databases can be deployed to a single Availability Group.</span></span>

<span data-ttu-id="4a0d9-180">下面列出的 SQL Server 安全登录名是与 BizTalk Server 相关联。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-180">The following list of SQL Server security logins are associated with BizTalk Server.</span></span> <span data-ttu-id="4a0d9-181">您可能必须为 BizTalk Server 应用程序创建其他登录名。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-181">You may have additional logins created for your BizTalk Server applications.</span></span> <span data-ttu-id="4a0d9-182">如果是这样，您需要复制它们承载 BizTalk 数据库的副本的 SQL Server 的每个实例上。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-182">If so, you need to replicate them on every instance of SQL Server hosting a replica of BizTalk databases.</span></span> 

1. <span data-ttu-id="4a0d9-183">BizTalk Application Users （一个或多个对应于每个进程内主机）</span><span class="sxs-lookup"><span data-stu-id="4a0d9-183">BizTalk Application Users (one or more corresponding to each in-proc Host)</span></span> 
2. <span data-ttu-id="4a0d9-184">BizTalk Isolated Host Users （一个或多个对应于每个独立的主机）</span><span class="sxs-lookup"><span data-stu-id="4a0d9-184">BizTalk Isolated Host Users (one or more corresponding to each Isolated Host)</span></span> 
3. <span data-ttu-id="4a0d9-185">BizTalk Server Administrators</span><span class="sxs-lookup"><span data-stu-id="4a0d9-185">BizTalk Server Administrators</span></span> 
4. <span data-ttu-id="4a0d9-186">BizTalk Server B2B Operators</span><span class="sxs-lookup"><span data-stu-id="4a0d9-186">BizTalk Server B2B Operators</span></span> 
5. <span data-ttu-id="4a0d9-187">BizTalk Server Operators</span><span class="sxs-lookup"><span data-stu-id="4a0d9-187">BizTalk Server Operators</span></span> 
6. <span data-ttu-id="4a0d9-188">SSO Administrators</span><span class="sxs-lookup"><span data-stu-id="4a0d9-188">SSO Administrators</span></span> 
7. <span data-ttu-id="4a0d9-189">BAM 警报用户</span><span class="sxs-lookup"><span data-stu-id="4a0d9-189">BAM Alerts User</span></span> 
8. <span data-ttu-id="4a0d9-190">BAM 管理 Web Services 用户</span><span class="sxs-lookup"><span data-stu-id="4a0d9-190">BAM Management Web Service User</span></span> 
9. <span data-ttu-id="4a0d9-191">规则引擎更新服务帐户</span><span class="sxs-lookup"><span data-stu-id="4a0d9-191">Rule Engine Update Service Account</span></span> 

<span data-ttu-id="4a0d9-192">如果已创建其他主机或者将在以后创建其他主机，将作为此过程的一部分创建的新 SQL 登录名。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-192">If you have created additional hosts or will create additional hosts later, there will be new SQL logins created as part of this process.</span></span> <span data-ttu-id="4a0d9-193">您必须确保在相应的副本上手动创建这些 SQL 登录名。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-193">You must make sure to create these SQL logins manually on the corresponding replicas.</span></span>

<span data-ttu-id="4a0d9-194">以下 SQL Server 代理作业与 BizTalk Server 相关联。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-194">The following SQL Server Agent jobs are associated with BizTalk Server.</span></span> <span data-ttu-id="4a0d9-195">每个服务器上安装的作业有所不同，具体视安装和配置的功能而定。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-195">The jobs installed on each server are different depending on which features are installed and configured.</span></span> <span data-ttu-id="4a0d9-196">BizTalk Server 配置期间创建这些作业大部分。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-196">Most of these jobs are created during BizTalk Server configuration.</span></span> <span data-ttu-id="4a0d9-197">部分作业是在配置日志传送时创建的。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-197">Several are created when configuring log shipping.</span></span> <span data-ttu-id="4a0d9-198">需要在其相应的 BizTalk 数据库的 SQL Server 托管副本的每个实例上复制这些作业。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-198">These jobs need to be replicated on each instance of SQL Server hosting replica of their corresponding BizTalk database.</span></span> <span data-ttu-id="4a0d9-199">这必须手动执行。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-199">This must be performed manually.</span></span> 

- <span data-ttu-id="4a0d9-200">BizTalkMgmtDb 的作业：</span><span class="sxs-lookup"><span data-stu-id="4a0d9-200">BizTalkMgmtDb jobs:</span></span> 
    - <span data-ttu-id="4a0d9-201">备份 BizTalk Server (BizTalkMgmtDb)</span><span class="sxs-lookup"><span data-stu-id="4a0d9-201">Backup BizTalk Server (BizTalkMgmtDb)</span></span> 
    - <span data-ttu-id="4a0d9-202">CleanupBTFExpiredEntriesJob_BizTalkMgmtDb</span><span class="sxs-lookup"><span data-stu-id="4a0d9-202">CleanupBTFExpiredEntriesJob_BizTalkMgmtDb</span></span> 
    - <span data-ttu-id="4a0d9-203">监视 BizTalk Server (BizTalkMgmtDb)</span><span class="sxs-lookup"><span data-stu-id="4a0d9-203">Monitor BizTalk Server (BizTalkMgmtDb)</span></span> 
- <span data-ttu-id="4a0d9-204">BizTalkMsgBoxDb 作业：</span><span class="sxs-lookup"><span data-stu-id="4a0d9-204">BizTalkMsgBoxDb jobs:</span></span> 
    - <span data-ttu-id="4a0d9-205">MessageBox_DeadProcesses_Cleanup_BizTalkMsgBoxDb</span><span class="sxs-lookup"><span data-stu-id="4a0d9-205">MessageBox_DeadProcesses_Cleanup_BizTalkMsgBoxDb</span></span> 
    - <span data-ttu-id="4a0d9-206">MessageBox_Message_Cleanup_BizTalkMsgBoxDb</span><span class="sxs-lookup"><span data-stu-id="4a0d9-206">MessageBox_Message_Cleanup_BizTalkMsgBoxDb</span></span>
    - <span data-ttu-id="4a0d9-207">MessageBox_Message_ManageRefCountLog_BizTalkMsgBoxDb</span><span class="sxs-lookup"><span data-stu-id="4a0d9-207">MessageBox_Message_ManageRefCountLog_BizTalkMsgBoxDb</span></span>
    - <span data-ttu-id="4a0d9-208">MessageBox_Parts_Cleanup_BizTalkMsgBoxDb</span><span class="sxs-lookup"><span data-stu-id="4a0d9-208">MessageBox_Parts_Cleanup_BizTalkMsgBoxDb</span></span> 
    - <span data-ttu-id="4a0d9-209">MessageBox_UpdateStats_BizTalkMsgBoxDb</span><span class="sxs-lookup"><span data-stu-id="4a0d9-209">MessageBox_UpdateStats_BizTalkMsgBoxDb</span></span> 
    - <span data-ttu-id="4a0d9-210">Operations_OperateOnInstances_OnMaster_BizTalkMsgBoxDb</span><span class="sxs-lookup"><span data-stu-id="4a0d9-210">Operations_OperateOnInstances_OnMaster_BizTalkMsgBoxDb</span></span> 
    - <span data-ttu-id="4a0d9-211">PurgeSubscriptionsJob_BizTalkMsgBoxDb</span><span class="sxs-lookup"><span data-stu-id="4a0d9-211">PurgeSubscriptionsJob_BizTalkMsgBoxDb</span></span> 
    - <span data-ttu-id="4a0d9-212">TrackedMessages_Copy_BizTalkMsgBoxDb</span><span class="sxs-lookup"><span data-stu-id="4a0d9-212">TrackedMessages_Copy_BizTalkMsgBoxDb</span></span> 
- <span data-ttu-id="4a0d9-213">有关其他 msgboxes 的作业</span><span class="sxs-lookup"><span data-stu-id="4a0d9-213">Jobs on additional msgboxes</span></span>
- <span data-ttu-id="4a0d9-214">BizTalkDTADb 作业：</span><span class="sxs-lookup"><span data-stu-id="4a0d9-214">BizTalkDTADb job:</span></span> 
    - <span data-ttu-id="4a0d9-215">DTA 清除和存档 (BizTalkDTADb)</span><span class="sxs-lookup"><span data-stu-id="4a0d9-215">DTA Purge and Archive (BizTalkDTADb)</span></span> 
- <span data-ttu-id="4a0d9-216">BizTalkRulesEngineDb 作业：</span><span class="sxs-lookup"><span data-stu-id="4a0d9-216">BizTalkRulesEngineDb job:</span></span> 
    - <span data-ttu-id="4a0d9-217">Rules_Database_Cleanup_BizTalkRuleEngineDb</span><span class="sxs-lookup"><span data-stu-id="4a0d9-217">Rules_Database_Cleanup_BizTalkRuleEngineDb</span></span> 
- <span data-ttu-id="4a0d9-218">BAMAlertsApplication 作业：</span><span class="sxs-lookup"><span data-stu-id="4a0d9-218">BAMAlertsApplication job:</span></span> 
    - <span data-ttu-id="4a0d9-219">0 或更多 DelAlertHistJob</span><span class="sxs-lookup"><span data-stu-id="4a0d9-219">0 or more DelAlertHistJob</span></span> 

<span data-ttu-id="4a0d9-220">与 SQL 故障转移群集实例，不同可用性组中所有副本都是活动、 正在运行，且可用。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-220">Unlike SQL Failover Clustering Instances, in Availability Groups all replicas are active, running, and available.</span></span> <span data-ttu-id="4a0d9-221">时在每个副本的故障转移会有重复的 SQL 代理作业，它们将对相应的副本，而不考虑它目前是否在主角色或辅助角色中运行。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-221">When SQL Agent jobs are duplicated on each replica for failover, they run against the corresponding replica, irrespective of whether it is currently in primary role or secondary role.</span></span> <span data-ttu-id="4a0d9-222">若要确保仅在当前主副本上执行这些作业，每个作业的每一步必须括在 IF 块中，如所示：</span><span class="sxs-lookup"><span data-stu-id="4a0d9-222">To make sure these jobs are executed only on the current primary replica, every step in every job must be enclosed within an IF block, as shown:</span></span> 

    ```
    IF (sys.fn_hadr_is_primary_replica(‘dbname’) = 1)  
    BEGIN  
    …  
    END
    ```
  
<span data-ttu-id="4a0d9-223">替换为`‘dbname’`与对其作业配置为运行相应的数据库名称。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-223">Replace `‘dbname’` with the corresponding database name against which the job is configured to run.</span></span> <span data-ttu-id="4a0d9-224">下面的示例演示在 BizTalkMsgBoxDb TrackedMessages_Copy_BizTalkMsgBoxDb 此更改：</span><span class="sxs-lookup"><span data-stu-id="4a0d9-224">The following example shows this change for TrackedMessages_Copy_BizTalkMsgBoxDb on BizTalkMsgBoxDb:</span></span> 
 
 ![SQLAG_AgentJob](../core/media/sqlag-agentjob.gif)

### <a name="configure-biztalk-when-availability-groups-are-already-set-up"></a><span data-ttu-id="4a0d9-226">如果可用性组已设置了，配置 BizTalk</span><span class="sxs-lookup"><span data-stu-id="4a0d9-226">Configure BizTalk when Availability Groups are already set up</span></span>

1. <span data-ttu-id="4a0d9-227">检查操作系统要求：</span><span class="sxs-lookup"><span data-stu-id="4a0d9-227">Check your OS requirements:</span></span> 
2. <span data-ttu-id="4a0d9-228">对所有**Windows Server 2012 R2**的计算机，安装[3090973 MSDTC 修补程序](https://support.microsoft.com/kb/3090973)（打开知识库文章）</span><span class="sxs-lookup"><span data-stu-id="4a0d9-228">On all **Windows Server 2012 R2** computers, install the [3090973 MSDTC hotfix](https://support.microsoft.com/kb/3090973) (opens a KB article)</span></span>
3. <span data-ttu-id="4a0d9-229">对所有**Windows Server 2016**的计算机，启用[RemoteAccessEnabled 注册表项](https://support.microsoft.com/kb/3182294)（打开知识库文章）</span><span class="sxs-lookup"><span data-stu-id="4a0d9-229">On all **Windows Server 2016** computers, enable the [RemoteAccessEnabled registry key](https://support.microsoft.com/kb/3182294) (opens a KB article)</span></span>
4. <span data-ttu-id="4a0d9-230">请确保具有至少四个不同的 SQL 实例将托管多个 BizTalk 数据库。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-230">Make sure to have at least four different SQL instances which will host the various BizTalk databases.</span></span> <span data-ttu-id="4a0d9-231">此外应在不同的 SQL 实例上设置辅助副本。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-231">The secondary replicas should also be set up on different SQL instances.</span></span> <span data-ttu-id="4a0d9-232">这会导致最少 8 个 SQL 实例 （1 主副本和 1 辅助副本的每个 4 个实例），且最少 4 个可用性组。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-232">This results in a minimum of 8 SQL instances (1 primary and 1 secondary replica for each of the 4 instances), and a minimum of 4 Availability Groups.</span></span> <span data-ttu-id="4a0d9-233">请参阅上的图中为此可用性组配置。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-233">See the above illustration for this Availability Group configuration.</span></span> <span data-ttu-id="4a0d9-234">请确保可用性组创建与**每数据库 DTC 支持**选项，因为这是无法更改更高版本。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-234">Make sure Availability Groups are created with the **Per Database DTC Support** option as this cannot be changed later.</span></span> 
5. <span data-ttu-id="4a0d9-235">当配置 BizTalk Server 并指定 SQL 服务器名称，而不是实际的计算机名称使用可用性组侦听器名称。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-235">When configuring BizTalk Server and specifying the SQL server name, use the Availability Group’s listener name instead of the actual machine name.</span></span> <span data-ttu-id="4a0d9-236">这在当前主副本上创建 BizTalk 数据库、 登录名和 SQL 代理作业。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-236">This creates the BizTalk databases, logins, and SQL Agent jobs on the current primary replica.</span></span> 
6. <span data-ttu-id="4a0d9-237">停止 BizTalk 处理 （主机实例、 SSO 服务、 IIS、 规则引擎更新服务、 BAMAlerts 服务等），并停止 SQL 代理作业。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-237">Stop BizTalk processing (Host Instances, SSO Service, IIS, Rules Engine Update Service, BAMAlerts Service, and so on), and stop the SQL Agent Jobs.</span></span> 
7. <span data-ttu-id="4a0d9-238">现在将 BIzTalk 数据库添加到相应的可用性组。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-238">Now add BIzTalk databases to the respective Availability Groups.</span></span> 
8. <span data-ttu-id="4a0d9-239">将正文中的 SQL 代理作业步骤`IF`块 （如前所述） 以确保它们运行仅当目标是主副本。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-239">Enclose body of SQL Agent job steps within `IF` block (mentioned previously) to make sure they run only if the target is the primary replica.</span></span> 
9. <span data-ttu-id="4a0d9-240">脚本才能将它们复制相应的副本上的登录名和 SQL 代理作业。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-240">Script Logins and SQL Agent Jobs to replicate them on corresponding replica.</span></span> 
10. <span data-ttu-id="4a0d9-241">复制 SQL DBMail 配置文件和 BAM 警报的相应 SQL 实例承载辅助副本上的帐户。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-241">Replicate SQL DBMail Profile and Account for BAM Alerts on corresponding SQL instances hosting the secondary replica.</span></span> 
11. <span data-ttu-id="4a0d9-242">如果要添加其他 messagebox 数据库或部署一个新 BAM 活动/视图更高版本，然后新 SQL 作业创建新的消息框数据库或当前主副本上的 BAM 警报数据库。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-242">If you are adding an additional message box database or deploying a new BAM activity/view later, then new SQL jobs are created for new message box databases or BAM Alerts database on the current primary replica.</span></span> <span data-ttu-id="4a0d9-243">请确保主副本上对其进行编辑，然后在相应的辅助副本上手动创建它们。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-243">Make sure to edit it on primary replica, and then create them manually on the corresponding secondary replicas.</span></span> 

<span data-ttu-id="4a0d9-244">也可以完成此配置使用承载主副本的 SQL 实例。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-244">This configuration can also be done using the SQL Instances hosting the primary replica.</span></span> <span data-ttu-id="4a0d9-245">在这种情况下，BizTalk 配置之后，运行`UpdateDatabase.vbs`和`UpdateRegistry.vbs`上述步骤后的 BizTalk 计算机上的脚本。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-245">In this case, after the BizTalk configuration, run the `UpdateDatabase.vbs` and `UpdateRegistry.vbs` scripts on the BizTalk machines after the above steps.</span></span> <span data-ttu-id="4a0d9-246">下一节中更详细地对此进行了讨论。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-246">This is discussed in more detail in the next section.</span></span>  
 
### <a name="move-existing-biztalk-databases-to-availability-groups"></a><span data-ttu-id="4a0d9-247">将现有 BizTalk 数据库移到可用性组</span><span class="sxs-lookup"><span data-stu-id="4a0d9-247">Move existing BizTalk databases to Availability Groups</span></span>

1. <span data-ttu-id="4a0d9-248">检查操作系统要求：</span><span class="sxs-lookup"><span data-stu-id="4a0d9-248">Check your OS requirements:</span></span> 
2. <span data-ttu-id="4a0d9-249">对所有**Windows Server 2012 R2**的计算机，安装[3090973 MSDTC 修补程序](https://support.microsoft.com/kb/3090973)（打开知识库文章）</span><span class="sxs-lookup"><span data-stu-id="4a0d9-249">On all **Windows Server 2012 R2** computers, install the [3090973 MSDTC hotfix](https://support.microsoft.com/kb/3090973) (opens a KB article)</span></span>
3. <span data-ttu-id="4a0d9-250">对所有**Windows Server 2016**的计算机，启用[RemoteAccessEnabled 注册表项](https://support.microsoft.com/kb/3182294)（打开知识库文章）</span><span class="sxs-lookup"><span data-stu-id="4a0d9-250">On all **Windows Server 2016** computers, enable the [RemoteAccessEnabled registry key](https://support.microsoft.com/kb/3182294) (opens a KB article)</span></span>
4. <span data-ttu-id="4a0d9-251">请确保具有至少四个不同的 SQL 实例将托管多个 BizTalk 数据库。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-251">Make sure to have at least four different SQL instances which will host the various BizTalk databases.</span></span> <span data-ttu-id="4a0d9-252">此外应在不同的 SQL 实例上设置辅助副本。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-252">The secondary replicas should also be set up on different SQL instances.</span></span> <span data-ttu-id="4a0d9-253">这会导致最少 8 个 SQL 实例 （1 主副本和 1 辅助副本的每个 4 个实例），且最少 4 个可用性组。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-253">This results in a minimum of 8 SQL instances (1 primary and 1 secondary replica for each of the 4 instances), and a minimum of 4 Availability Groups.</span></span> <span data-ttu-id="4a0d9-254">请参阅上的图中为此可用性组配置。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-254">See the above illustration for this Availability Group configuration.</span></span> <span data-ttu-id="4a0d9-255">请确保可用性组创建与**每数据库 DTC 支持**选项，因为这是无法更改更高版本。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-255">Make sure Availability Groups are created with **Per Database DTC Support** option as this cannot be changed later.</span></span>  
5. <span data-ttu-id="4a0d9-256">停止 BizTalk 处理和 SQL 代理作业。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-256">Stop BizTalk processing and SQL Agent Jobs.</span></span> 
6. <span data-ttu-id="4a0d9-257">执行完整备份所有 BizTalk 数据库。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-257">Perform full backup of all BizTalk Databases.</span></span> 
7. <span data-ttu-id="4a0d9-258">还原当前在主角色中可用性组中的 SQL 实例上的 BizTalk 数据库。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-258">Restore BizTalk databases on the SQL instances currently in the primary role in the Availability Group.</span></span> 
8. <span data-ttu-id="4a0d9-259">编写脚本的登录名和 SQL 代理作业当前在主角色中可用性组中的相应 SQL 实例上。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-259">Script Logins and SQL Agent jobs on corresponding SQL Instances currently in the primary role in the Availability Group.</span></span>  
9. <span data-ttu-id="4a0d9-260">运行`UpdateDatabase.vbs`和`UpdateRegistry.vbs`脚本使用以下步骤在 BizTalk 机上的。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-260">Run the `UpdateDatabase.vbs` and `UpdateRegistry.vbs` scripts on the BizTalk machines using the following steps.</span></span> <span data-ttu-id="4a0d9-261">输入作为输入的更新信息 xml 中的新服务器名称的可用性组侦听器。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-261">Enter the Availability Group Listener as the new server name in the input update info xml.</span></span>  
    1. <span data-ttu-id="4a0d9-262">在 BizTalk Server 上停止所有 BizTalk 服务和企业 SSO 服务。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-262">Stop all BizTalk services and Enterprise SSO services on BizTalk Server.</span></span> <span data-ttu-id="4a0d9-263">SQL Server 上停止 SQL 代理服务。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-263">Stop SQL Agent Service on SQL Server.</span></span> 
    2. <span data-ttu-id="4a0d9-264">在 BizTalk Server 上编辑 SampleUpdateInfo.xml 以下文件夹中：</span><span class="sxs-lookup"><span data-stu-id="4a0d9-264">On BizTalk Server, edit SampleUpdateInfo.xml in the following folder:</span></span> 
 
        <span data-ttu-id="4a0d9-265">32 位计算机： `%SystemRoot%\Program Files\Microsoft BizTalk Server 20xx\Schema\Restore`</span><span class="sxs-lookup"><span data-stu-id="4a0d9-265">32-bit computer: `%SystemRoot%\Program Files\Microsoft BizTalk Server 20xx\Schema\Restore`</span></span>
 
        <span data-ttu-id="4a0d9-266">64 位计算机： `%SystemRoot%\Program Files (x86)\Microsoft BizTalk Server 20xx\Bins32\Schema\Restore`</span><span class="sxs-lookup"><span data-stu-id="4a0d9-266">64-bit computer: `%SystemRoot%\Program Files (x86)\Microsoft BizTalk Server 20xx\Bins32\Schema\Restore`</span></span>
 
            1. Replace "SourceServer" with the source server name (old SQL Server hosting old databases).  
            2. Replace "DestinationServer" with the name of the destination server, which should be the availability group listener name.  
            3. If you have the BAMAnalysis, BAM databases or RuleEngineDB, uncomment the appropriate sections. 

    3. <span data-ttu-id="4a0d9-267">打开命令提示符，并转到：</span><span class="sxs-lookup"><span data-stu-id="4a0d9-267">Open a command prompt, and go to:</span></span> 
 
        <span data-ttu-id="4a0d9-268">32 位计算机： `%SystemRoot%\Program Files\Microsoft BizTalk Server 20xx\Schema\Restore`</span><span class="sxs-lookup"><span data-stu-id="4a0d9-268">32-bit computer: `%SystemRoot%\Program Files\Microsoft BizTalk Server 20xx\Schema\Restore`</span></span> 
 
        <span data-ttu-id="4a0d9-269">64 位计算机： `%SystemRoot%\Program Files (x86)\Microsoft BizTalk Server 20xx\Bins32\Schema\Restore`</span><span class="sxs-lookup"><span data-stu-id="4a0d9-269">64-bit computer: `%SystemRoot%\Program Files (x86)\Microsoft BizTalk Server 20xx\Bins32\Schema\Restore`</span></span> 
 
        <span data-ttu-id="4a0d9-270">在命令提示符下运行：</span><span class="sxs-lookup"><span data-stu-id="4a0d9-270">At the command prompt, run:</span></span>  
    `cscript UpdateDatabase.vbs SampleUpdateInfo.xml`  
 
        <span data-ttu-id="4a0d9-271">在 BizTalk 组中只有一台服务器上运行 UpdateDatabase.vbs。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-271">Run UpdateDatabase.vbs on only one server in the BizTalk group.</span></span> 

    4. <span data-ttu-id="4a0d9-272">将已编辑的 SampleUpdateInfo.xml 文件复制到此 BizTalk 组中每个 BizTalk Server 计算机上的以下文件夹：</span><span class="sxs-lookup"><span data-stu-id="4a0d9-272">Copy the edited SampleUpdateInfo.xml file to the following folder on every BizTalk Server computer in this BizTalk group:</span></span> 
 
        <span data-ttu-id="4a0d9-273">32 位计算机： `%SystemRoot%\Program Files\Microsoft BizTalk Server 20xx\Schema\Restore`</span><span class="sxs-lookup"><span data-stu-id="4a0d9-273">32-bit computer: `%SystemRoot%\Program Files\Microsoft BizTalk Server 20xx\Schema\Restore`</span></span> 
 
        <span data-ttu-id="4a0d9-274">64 位计算机： `%SystemRoot%\Program Files (x86)\Microsoft BizTalk Server 20xx\Bins32\Schema\Restore`</span><span class="sxs-lookup"><span data-stu-id="4a0d9-274">64-bit computer: `%SystemRoot%\Program Files (x86)\Microsoft BizTalk Server 20xx\Bins32\Schema\Restore`</span></span> 
 
    5. <span data-ttu-id="4a0d9-275">BizTalk Server 组中每台计算机，打开命令提示符，并转到：</span><span class="sxs-lookup"><span data-stu-id="4a0d9-275">On each computer in the BizTalk Server group, open a command prompt, and go to:</span></span> 
 
        <span data-ttu-id="4a0d9-276">32 位计算机： `%SystemRoot%\Program Files\Microsoft BizTalk Server 20xx\Schema\Restore`</span><span class="sxs-lookup"><span data-stu-id="4a0d9-276">32-bit computer: `%SystemRoot%\Program Files\Microsoft BizTalk Server 20xx\Schema\Restore`</span></span>
 
        <span data-ttu-id="4a0d9-277">64 位计算机： `%SystemRoot%\Program Files (x86)\Microsoft BizTalk Server 20xx\Bins32\Schema\Restore`</span><span class="sxs-lookup"><span data-stu-id="4a0d9-277">64-bit computer: `%SystemRoot%\Program Files (x86)\Microsoft BizTalk Server 20xx\Bins32\Schema\Restore`</span></span> 
 
        <span data-ttu-id="4a0d9-278">在命令提示符下运行：</span><span class="sxs-lookup"><span data-stu-id="4a0d9-278">At the command prompt, run:</span></span>  
    `cscript UpdateRegistry.vbs SampleUpdateInfo.xml` 
 
        <span data-ttu-id="4a0d9-279">在 BizTalk 组中的每个服务器上运行 UpdateRegistry.vbs。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-279">Run UpdateRegistry.vbs on every server in the BizTalk group.</span></span> 
 
10. <span data-ttu-id="4a0d9-280">现在，将数据库移到其各自的可用性组。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-280">Now move the databases to their respective Availability Groups.</span></span> 
11. <span data-ttu-id="4a0d9-281">复制 SQL DBMail 配置文件和帐户为 BAM 警报上 SQL 实例承载 BAMAlerts 数据库的副本。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-281">Replicate the SQL DBMail Profile and Account for BAM Alerts on the SQL instances hosting the replica of the BAMAlerts database.</span></span> 
12. <span data-ttu-id="4a0d9-282">将 IF 块来确保仅当目标是主它们运行中的 SQL 代理作业步骤的正文。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-282">Enclose the body of SQL Agent job steps within an IF block to make sure they run only if the target is the primary.</span></span> 
13. <span data-ttu-id="4a0d9-283">脚本才能将它们复制相应的副本上的登录名和 SQL 代理作业。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-283">Script Logins and SQL Agent Jobs to replicate them on the corresponding replica.</span></span> <span data-ttu-id="4a0d9-284">UpdateDatabase 脚本还会更新 Operations_OperateOnInstances_OnMaster_BizTalkMsgBoxDb 和 TrackedMessages_Copy_BizTalkMsgBoxDb 作业中的服务器名称。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-284">The UpdateDatabase script also updates the server name in the Operations_OperateOnInstances_OnMaster_BizTalkMsgBoxDb and TrackedMessages_Copy_BizTalkMsgBoxDb jobs.</span></span> <span data-ttu-id="4a0d9-285">仅在运行 UpdateDatabase 脚本后，因此脚本 SQL 代理作业。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-285">So script the SQL Agent Jobs only after running the UpdateDatabase script.</span></span> 

## <a name="requirements"></a><span data-ttu-id="4a0d9-286">要求</span><span class="sxs-lookup"><span data-stu-id="4a0d9-286">Requirements</span></span> 
* <span data-ttu-id="4a0d9-287">BizTalk Server 2016 企业版</span><span class="sxs-lookup"><span data-stu-id="4a0d9-287">BizTalk Server 2016 Enterprise</span></span>
* <span data-ttu-id="4a0d9-288">SQL Server 2016 Enterprise 或 SQL Server 2016 Standard (请参阅**已知限制**本主题中)</span><span class="sxs-lookup"><span data-stu-id="4a0d9-288">SQL Server 2016 Enterprise or SQL Server 2016 Standard (see **Known limitations** in this topic)</span></span>
* <span data-ttu-id="4a0d9-289">Windows Server 2012 R2 或 Windows Server 2016</span><span class="sxs-lookup"><span data-stu-id="4a0d9-289">Windows Server 2012 R2 or Windows Server 2016</span></span> 

### <a name="availability-group-listener-configured-with-non-default-port-1433"></a><span data-ttu-id="4a0d9-290">使用非默认配置的可用性组侦听器端口 (1433)</span><span class="sxs-lookup"><span data-stu-id="4a0d9-290">Availability Group Listener configured with non-default port (1433)</span></span> 
<span data-ttu-id="4a0d9-291">使用 SQL 别名在 BizTalk Server 的计算机上。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-291">Use SQL alias on BizTalk Server machines.</span></span> 

### <a name="support-availability-group-multi-subnet-failovers"></a><span data-ttu-id="4a0d9-292">支持可用性组多子网故障转移</span><span class="sxs-lookup"><span data-stu-id="4a0d9-292">Support Availability Group Multi-Subnet Failovers</span></span> 
<span data-ttu-id="4a0d9-293">BizTalk Server 使用 Microsoft OLE DB 的数据库连接不支持**MultiSubnetFailover**连接选项。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-293">BizTalk Server uses Microsoft OLE DB for database connections, which does not support the **MultiSubnetFailover** connection option.</span></span> <span data-ttu-id="4a0d9-294">BizTalk Server 不支持`MultiSubnetFailover (=TRUE)`连接选项，这可能会导致在多子网故障转移期间更高版本的恢复时间。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-294">BizTalk Server does not support the `MultiSubnetFailover (=TRUE)` connection option, and this may cause higher recovery time during multi-subnet failover.</span></span> 

### <a name="read-only-routing"></a><span data-ttu-id="4a0d9-295">只读路由</span><span class="sxs-lookup"><span data-stu-id="4a0d9-295">Read-Only Routing</span></span> 
<span data-ttu-id="4a0d9-296">只读路由是指 SQL Server 能够将可用性组侦听器的传入连接路由到配置为允许只读工作负荷的辅助副本。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-296">Read-only routing refers to the ability of SQL Server to route incoming connections for an availability group listener to a secondary replica that is configured to allow read-only workloads.</span></span> 

<span data-ttu-id="4a0d9-297">BizTalk 不使用只读路由的任何其数据库的连接。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-297">BizTalk does not use Read-Only Routing for any of the connections to its databases.</span></span> <span data-ttu-id="4a0d9-298">这意味着可用性副本上可用性组中的"可读辅助副本"选项 BizTalk 数据库连接不产生任何影响。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-298">This means the “Readable Secondary” option on Availability Replicas in the availability group does not have any impact on BizTalk database connections.</span></span> 

### <a name="behavior-of-biztalk-host-instances-during-sql-server-failover"></a><span data-ttu-id="4a0d9-299">SQL Server 故障转移期间 BizTalk 主机实例的行为</span><span class="sxs-lookup"><span data-stu-id="4a0d9-299">Behavior of BizTalk Host Instances during SQL Server Failover</span></span> 
<span data-ttu-id="4a0d9-300">如果 SQL Server 可用性组发生故障转移，可用性组上的 BizTalk Server 数据库将暂时不可用。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-300">If the SQL Server availability group experiences a failover, the BizTalk Server databases on the availability group are temporarily unavailable.</span></span> 

#### <a name="behavior-of-in-process-host-instances-during-sql-server-failover"></a><span data-ttu-id="4a0d9-301">SQL Server 故障转移期间进程内主机实例的行为</span><span class="sxs-lookup"><span data-stu-id="4a0d9-301">Behavior of In-Process Host Instances during SQL Server Failover</span></span> 
<span data-ttu-id="4a0d9-302">如果 BizTalk Server 数据库不可用，然后 BizTalk Server 主机的进程内实例被回收直到还原到 SQL Server 的连接。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-302">If the BizTalk Server databases are unavailable, then an in-process instance of a BizTalk Server host is recycled until the connection to the SQL Server is restored.</span></span> <span data-ttu-id="4a0d9-303">一旦还原到 SQL Server 数据库的连接，文档处理正常恢复。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-303">Once the connection to the SQL Server databases is restored, document processing resumes normally.</span></span>
 
#### <a name="behavior-of-isolated-host-instances-during-sql-server-failover"></a><span data-ttu-id="4a0d9-304">SQL Server 故障转移期间独立主机实例的行为</span><span class="sxs-lookup"><span data-stu-id="4a0d9-304">Behavior of Isolated Host Instances During SQL Server Failover</span></span> 
<span data-ttu-id="4a0d9-305">如果 BizTalk Server 数据库不可用，则 BizTalk Server 主机的独立的实例暂停，并在 BizTalk Server 应用程序日志中生成如下错误：</span><span class="sxs-lookup"><span data-stu-id="4a0d9-305">If the BizTalk Server databases are unavailable, then an isolated instance of a BizTalk Server host pauses, and an error similar to the following is generated in the BizTalk Server Application log:</span></span> 

    All receive locations are being temporarily disabled because either the MessageBox or Configuration database is not available. When these databases become available, the receive locations will be automatically enabled.
 
<span data-ttu-id="4a0d9-306">一旦还原到 SQL Server 数据库的连接，类似于以下的信息性消息写入到 BizTalk Server 应用程序日志和文档处理然后正常恢复：</span><span class="sxs-lookup"><span data-stu-id="4a0d9-306">Once the connection to the SQL Server databases is restored, an informational message similar to the following is written to the BizTalk Server Application log, and then document processing resumes normally:</span></span> 

    All receive locations are being enabled because both the MessageBox and Configuration databases are back online.

#### <a name="log-shipping-for-disaster-recovery"></a><span data-ttu-id="4a0d9-307">日志传送灾难恢复</span><span class="sxs-lookup"><span data-stu-id="4a0d9-307">Log Shipping for Disaster Recovery</span></span> 
<span data-ttu-id="4a0d9-308">BizTalk Server 实现数据库备用功能通过数据库使用日志传送。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-308">BizTalk Server implements database standby capabilities through the use of database log shipping.</span></span> <span data-ttu-id="4a0d9-309">BizTalk Server 日志传送可以自动备份和还原的数据库和事务日志文件，从而允许在备用服务器恢复数据库处理在的生产数据库服务器无法正常工作。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-309">BizTalk Server log shipping automates the backup and restore of databases and their transaction log files, allowing a standby server to resume database processing in the event that the production database server fails.</span></span> 

<span data-ttu-id="4a0d9-310">**可用性组中的辅助数据库不是备份。**</span><span class="sxs-lookup"><span data-stu-id="4a0d9-310">**Secondary databases in availability group are not backups.**</span></span> <span data-ttu-id="4a0d9-311">继续备份 BizTalk 数据库和其事务日志使用 BizTalk Server 日志传送作业。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-311">Continue to backup BizTalk databases and their transaction logs using BizTalk Server Log Shipping jobs.</span></span> <span data-ttu-id="4a0d9-312">实现 BizTalk 日志传送的方式可确保始终针对每个数据库的当前主副本执行备份。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-312">The way BizTalk Log Shipping is implemented ensures that backups are always performed against the current primary replica of every database.</span></span> <span data-ttu-id="4a0d9-313">BizTalk Server 日志传送作业不遵循上可用性组的备份首选项设置。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-313">The backup preference setting on the availability group is not honored by the BizTalk Server Log Shipping jobs.</span></span> 

<span data-ttu-id="4a0d9-314">如果要添加到 BizTalk 数据库备份作业的其他 BizTalk 数据库，请务必的可用性组侦听器名称用作数据库服务器为其设置备份时。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-314">If you are adding other BizTalk databases to the BizTalk Databases Backup job, be sure to use the Availability Group Listener name as the database server for them when setting up the Backup.</span></span>  
 
## <a name="references"></a><span data-ttu-id="4a0d9-315">References</span><span class="sxs-lookup"><span data-stu-id="4a0d9-315">References</span></span> 
 
* [<span data-ttu-id="4a0d9-316">为 BizTalk Server 数据库提供高可用性</span><span class="sxs-lookup"><span data-stu-id="4a0d9-316">Providing High Availability for BizTalk Server Databases</span></span>](../core/providing-high-availability-for-biztalk-server-databases.md)  
* [<span data-ttu-id="4a0d9-317">对 Microsoft Azure 虚拟机的 Microsoft 服务器软件支持</span><span class="sxs-lookup"><span data-stu-id="4a0d9-317">Microsoft server software support for Microsoft Azure virtual machines</span></span>](https://support.microsoft.com/kb/2721672)  
* [<span data-ttu-id="4a0d9-318">SQL Server 数据库镜像、卷影复制服务和 AlwaysOn</span><span class="sxs-lookup"><span data-stu-id="4a0d9-318">SQL Server database mirroring, Volume Shadow Copy service and AlwaysOn</span></span>](../core/sql-server-database-mirroring-volume-shadow-copy-service-and-alwayson.md)  
* [<span data-ttu-id="4a0d9-319">AlwaysOn 可用性组 (SQL Server) 概述</span><span class="sxs-lookup"><span data-stu-id="4a0d9-319">Overview of AlwaysOn Availability Groups (SQL Server)</span></span>](https://msdn.microsoft.com/library/ff877884.aspx)  
* [<span data-ttu-id="4a0d9-320">跨数据库事务支持数据库镜像或 AlwaysOn 可用性组 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="4a0d9-320">Cross-Database Transactions Support For Database Mirroring or AlwaysOn Availability Groups (SQL Server)</span></span>](https://msdn.microsoft.com/library/ms366279.aspx)  
* [<span data-ttu-id="4a0d9-321">当 SQL Server 收到来自 Windows Server 2012 R2 中的 MSDTC 事务结果时，不能调用重新登记</span><span class="sxs-lookup"><span data-stu-id="4a0d9-321">Reenlist can't be called when SQL Server receives transaction outcome from MSDTC in Windows Server 2012 R2</span></span>](https://support.microsoft.com/kb/3090973)  
* [<span data-ttu-id="4a0d9-322">备份和还原 BizTalk Server 数据库</span><span class="sxs-lookup"><span data-stu-id="4a0d9-322">Backing Up and Restoring BizTalk Server Databases</span></span>](../core/backing-up-and-restoring-biztalk-server-databases.md)  
* [<span data-ttu-id="4a0d9-323">如何移动 BizTalk Server 数据库</span><span class="sxs-lookup"><span data-stu-id="4a0d9-323">How to Move the BizTalk Server Databases</span></span>](../core/how-to-move-the-biztalk-server-databases.md)  
* [<span data-ttu-id="4a0d9-324">如何还原数据库</span><span class="sxs-lookup"><span data-stu-id="4a0d9-324">How to Restore Your Databases</span></span>](../core/how-to-restore-your-databases.md)   
* [<span data-ttu-id="4a0d9-325">多子网可用性组中的连接超时</span><span class="sxs-lookup"><span data-stu-id="4a0d9-325">Connection Timeouts in Multi-subnet Availability Group</span></span>](https://blogs.msdn.microsoft.com/alwaysonpro/2014/06/03/connection-timeouts-in-multi-subnet-availability-group/)  
 
## <a name="known-limitations"></a><span data-ttu-id="4a0d9-326">已知的限制</span><span class="sxs-lookup"><span data-stu-id="4a0d9-326">Known limitations</span></span> 

<span data-ttu-id="4a0d9-327">这些限制适用于 BizTalk Server，SQL Server AlwaysOn 可用性组和 Azure 虚拟机。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-327">These limitations are for BizTalk Server, SQL Server AlwaysOn Availability Group, and Azure Virtual Machines.</span></span> <span data-ttu-id="4a0d9-328">这些限制可能或不可能在将来获得解决。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-328">These limitations may or may not get addressed in future.</span></span> 

* <span data-ttu-id="4a0d9-329">可用性组中不会管理登录名、 SQL 代理作业、 SQL DB 邮件配置文件和帐户。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-329">Logins, SQL Agent Jobs, the SQL DB Mail profile, and accounts are not managed within Availability Groups.</span></span> <span data-ttu-id="4a0d9-330">这需要手动进行修改以确保它们对主副本运行的作业中。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-330">This requires manual modification in Jobs to make sure they run against the primary replica.</span></span> 
* <span data-ttu-id="4a0d9-331">SQL Server Analysis Services 和 SQL Server Integration Services 将不参与可用性组。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-331">SQL Server Analysis Services and SQL Server Integration Services do not participate in Availability Groups.</span></span> <span data-ttu-id="4a0d9-332">如果没有此支持从 SQL Server，没有这些 Azure 虚拟机中的 HA 解决方案。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-332">Without this support from SQL Server, there is no HA solution for these in Azure Virtual Machines.</span></span> <span data-ttu-id="4a0d9-333">BizTalk Server BAM 功能都依赖于这些服务。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-333">BizTalk Server’s BAM capabilities are dependent on these services.</span></span> 
* <span data-ttu-id="4a0d9-334">在 SQL Server 2016 SP2 之前, 可用性组不支持在同一 SQL 实例的数据库之间 MSDTC。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-334">Prior to SQL Server 2016 SP2, Availability Groups don't support MSDTC between databases on the same SQL instance.</span></span> <span data-ttu-id="4a0d9-335">因此，需要最少 8 个 SQL 实例来配置 BizTalk。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-335">Therefore, a minimum 8 SQL instances are required to configure BizTalk.</span></span> 

  <span data-ttu-id="4a0d9-336">从 SQL Server 2016 SP2 开始*并*BizTalk Server 2016 [CU5](https://support.microsoft.com/help/2555976/service-pack-and-cumulative-update-list-for-biztalk-server)，BizTalk 数据库可以使用相同的 SQL Server 实例。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-336">Starting with SQL Server 2016 SP2 *and* BizTalk Server 2016 [CU5](https://support.microsoft.com/help/2555976/service-pack-and-cumulative-update-list-for-biztalk-server), the BizTalk databases can use the same SQL Server instance.</span></span> 

* <span data-ttu-id="4a0d9-337">若要解决 MSDTC 可以使用最少两台服务器托管四个 SQL 实例每个配置可用性组，BizTalk 数据库的限制。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-337">To address MSDTC limitations with Availability Groups, BizTalk databases can be configured using a minimum of two servers hosting four SQL instances each.</span></span> <span data-ttu-id="4a0d9-338">此外可以使用[与 Azure 负载均衡器的多个 IP 地址](https://docs.microsoft.com/azure/load-balancer/load-balancer-multivip-overview)。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-338">You can also use [multiple IP addresses with the Azure Load Balancer](https://docs.microsoft.com/azure/load-balancer/load-balancer-multivip-overview).</span></span> <span data-ttu-id="4a0d9-339">因此，如果你想要在一台服务器上的端口 1433年上使用四个默认 SQL 实例，您需要四个 IP 地址。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-339">So if you want to use four default SQL instances on port 1433 on a single server, you need four IP addresses.</span></span> <span data-ttu-id="4a0d9-340">如果仅限于一个 IP 地址，并且你想要托管在同一服务器上的多个 SQL 实例，则在确保针对每个 SQL 实例使用自定义端口。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-340">If you are restricted to one IP address, and you want to host multiple SQL instances on the same server, then be sure to use a custom port for each SQL instance.</span></span> 

  <span data-ttu-id="4a0d9-341">从 SQL Server 2016 SP2 开始*并*BizTalk Server 2016 [CU5](https://support.microsoft.com/help/2555976/service-pack-and-cumulative-update-list-for-biztalk-server)，BizTalk Server 数据库可以使用相同的 SQL Server 实例。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-341">Starting with SQL Server 2016 SP2 *and* BizTalk Server 2016 [CU5](https://support.microsoft.com/help/2555976/service-pack-and-cumulative-update-list-for-biztalk-server), the BizTalk Server databases can use the same SQL Server instance.</span></span> 

* <span data-ttu-id="4a0d9-342">BizTalk Server 不能使用只读路由。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-342">BizTalk Server cannot use Read-Only Routing.</span></span> 
* <span data-ttu-id="4a0d9-343">BizTalk Server 不会设置`MultiSubnetFailover`连接属性。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-343">BizTalk Server does not set the `MultiSubnetFailover` connection property.</span></span> 
* <span data-ttu-id="4a0d9-344">使用日志传送的 BizTalk 备份作业将始终针对主副本而不考虑对可用性组设置的备份首选项。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-344">BizTalk Backup Jobs using Log Shipping will always target the primary replica irrespective of the backup preference set on the Availability Group.</span></span> 
* <span data-ttu-id="4a0d9-345">SQL Server 2016 Standard 仅支持一个单一数据库中每个 SQL AlwaysOn 可用性组。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-345">SQL Server 2016 Standard supports only one single database in each SQL AlwaysOn AG.</span></span> <span data-ttu-id="4a0d9-346">由于 BizTalk 使用多个数据库，通常建议为 SQL Server Enterprise edition。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-346">Since BizTalk uses many databases, SQL Server Enterprise edition is typically recommended.</span></span>
* <span data-ttu-id="4a0d9-347">如果使用 Azure Vm，建议使用专用 MSDTC 对于固定的 TCP/IP 端口。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-347">If using Azure VMs, it's recommended to use a dedicated fixed TCP/IP port for MSDTC.</span></span> <span data-ttu-id="4a0d9-348">当使用固定的 TCP/IP 端口时，不会限制您通常与较早的操作系统; 一起使用的 RPC 端口范围它可帮助简化你的防火墙和负载均衡器规则。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-348">When using a fixed TCP/IP port, you aren't limiting your RPC port range typically used with older operating systems; and it helps simplify your firewall and load balancer rules.</span></span> <span data-ttu-id="4a0d9-349">若要避免与已知的较低端口冲突，请考虑使用更高版本的固定的端口 (如 > 20000)。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-349">To avoid conflicts with known lower ports, consider using a higher fixed port (such as >20000).</span></span> <span data-ttu-id="4a0d9-350">[配置 DTC 单个端口支持](https://msdn.microsoft.com/library/windows/desktop/dd573191(v=vs.85).aspx)描述`ServerTcpPort`注册表项。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-350">[Configuring DTC Single Port Support](https://msdn.microsoft.com/library/windows/desktop/dd573191(v=vs.85).aspx) describes the `ServerTcpPort` registry key.</span></span> <span data-ttu-id="4a0d9-351">除了 MSDTC 的固定端口，还使用主要的 RPC 端口 135。</span><span class="sxs-lookup"><span data-stu-id="4a0d9-351">In addition to the fixed port for MSDTC, the main RPC port 135 is also used.</span></span> 
