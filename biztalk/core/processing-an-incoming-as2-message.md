---
title: 处理传入 AS2 消息 |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 998ff334-71e2-4686-b2b7-44940a0ebed1
caps.latest.revision: 32
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 2fe8392cf09aebe3437b45b6d298a9bccfd44032
ms.sourcegitcommit: 381e83d43796a345488d54b3f7413e11d56ad7be
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/07/2019
ms.locfileid: "65299873"
---
# <a name="processing-an-incoming-as2-message"></a><span data-ttu-id="6c90e-102">处理传入 AS2 消息</span><span class="sxs-lookup"><span data-stu-id="6c90e-102">Processing an Incoming AS2 Message</span></span>
<span data-ttu-id="6c90e-103">AS2 接收通过 AS2 管道可处理传入的消息。</span><span class="sxs-lookup"><span data-stu-id="6c90e-103">The AS2 receive pipelines process an incoming message over AS2.</span></span> <span data-ttu-id="6c90e-104">AS2EdiReceive 接收管道处理 EDI 编码的消息，使用 EDI 拆装器。</span><span class="sxs-lookup"><span data-stu-id="6c90e-104">The AS2EdiReceive receive pipeline processes an EDI-encoded message, using the EDI Disassembler.</span></span> <span data-ttu-id="6c90e-105">AS2Receive 接收管道处理非 EDI 编码的消息，使用 AS2 拆装器。</span><span class="sxs-lookup"><span data-stu-id="6c90e-105">The AS2Receive receive pipeline processes a non-EDI-encoded message, using the AS2 Disassembler.</span></span> <span data-ttu-id="6c90e-106">两个管道处理 AS2 消息的负载，并以不同的方式; 生成 MDN但是，这两个接收管道使用 AS2 解码器来处理 AS2 消息。</span><span class="sxs-lookup"><span data-stu-id="6c90e-106">The two pipelines process the payload of the AS2 message and generate an MDN differently; however, both receive pipelines use the AS2 Decoder to process the AS2 message.</span></span>  
  
 <span data-ttu-id="6c90e-107">在 AS2EdiReceivePipeline 中处理带有 EDI 负载的 AS2 消息时，它将完成之前执行 EDI 处理收到的消息的 AS2 处理。</span><span class="sxs-lookup"><span data-stu-id="6c90e-107">When the AS2EdiReceivePipeline processes an AS2 message with an EDI payload, it completes the AS2 processing of the received message before performing the EDI processing.</span></span> <span data-ttu-id="6c90e-108">当管道生成 EDI 确认的 AS2 消息的 EDI 负载时，它必须因为由 AS2 响应关闭连接以异步方式返回 EDI 确认。</span><span class="sxs-lookup"><span data-stu-id="6c90e-108">When the pipeline generates an EDI acknowledgment for the EDI payload of an AS2 message, it must return the EDI acknowledgment asynchronously, because the connection is closed by the AS2 response.</span></span>  
  
## <a name="the-receive-port"></a><span data-ttu-id="6c90e-109">接收端口</span><span class="sxs-lookup"><span data-stu-id="6c90e-109">The Receive Port</span></span>  
 <span data-ttu-id="6c90e-110">HTTP 接收端口用于接收带有 EDI 或非 EDI 负载的 AS2 消息。</span><span class="sxs-lookup"><span data-stu-id="6c90e-110">An HTTP receive port is used to receive an AS2 message with an EDI or non-EDI payload.</span></span> <span data-ttu-id="6c90e-111">如果必须同步返回 MDN，接收端口必须是请求-响应端口。</span><span class="sxs-lookup"><span data-stu-id="6c90e-111">If an MDN must be returned synchronously, then the receive port must be a request-response port.</span></span>  
  
 <span data-ttu-id="6c90e-112">可以同步或异步返回 MDN。</span><span class="sxs-lookup"><span data-stu-id="6c90e-112">An MDN can be returned synchronously or asynchronously.</span></span> <span data-ttu-id="6c90e-113">这由 AS2 消息处理设置-通知-to 标头，除非**使用的验证和 MDN 的协议设置而非消息标头**的单向AS2协议选项卡中选择属性**协议属性**对话框。</span><span class="sxs-lookup"><span data-stu-id="6c90e-113">This is determined by the Disposition-notification-to header of the AS2 message, unless the **Use agreement settings for validation and MDN instead of message header** property is selected in the one-way AS2 agreement tab of the **Agreement Properties** dialog box.</span></span> <span data-ttu-id="6c90e-114">如果选择属性，则 MDN 返回的方式由**请求异步 MDN**属性中的**发送方 MDN 设置**的单向 AS2 协议选项卡页**协议属性**对话框。</span><span class="sxs-lookup"><span data-stu-id="6c90e-114">If the property is selected, the way the MDN is returned is determined by the **Request asynchronous MDN** property in the **Sender MDN Settings** page of the one-way AS2 agreement tab of the **Agreement Properties** dialog box.</span></span> <span data-ttu-id="6c90e-115">有关详细信息，请参阅[AS2 消息](../core/as2-messages.md)并[MDN 消息](../core/mdn-messages.md)。</span><span class="sxs-lookup"><span data-stu-id="6c90e-115">For more information, see [AS2 Messages](../core/as2-messages.md) and [MDN Messages](../core/mdn-messages.md).</span></span>  
  
 <span data-ttu-id="6c90e-116">如果将同步返回 MDN，MDN 通过发送端口返回双向接收位置。</span><span class="sxs-lookup"><span data-stu-id="6c90e-116">If the MDN will be returned synchronously, the MDN is returned over the send port of the two-way receive location.</span></span> <span data-ttu-id="6c90e-117">此 MDN 可用作 HTTP 响应，例如，200OK 指示成功接收的消息。</span><span class="sxs-lookup"><span data-stu-id="6c90e-117">This MDN serves as the HTTP response, for example, a 200OK indicating successful reception of the message.</span></span>  
  
 <span data-ttu-id="6c90e-118">如果将以异步方式返回 MDN，MDN 必须通过单独的发送端口返回。</span><span class="sxs-lookup"><span data-stu-id="6c90e-118">If the MDN will be returned asynchronously, the MDN must be returned over a separate send port.</span></span> <span data-ttu-id="6c90e-119">如果使用动态发送端口，则 MDN 将发送到处理设置-通知-to 标头中包含的地址。</span><span class="sxs-lookup"><span data-stu-id="6c90e-119">If a dynamic send port is used, the MDN will be sent to the address contained in Disposition-notification-to header.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="6c90e-120">双向接收端口用于接收的 AS2 消息不应该用于接收 MDN 消息。</span><span class="sxs-lookup"><span data-stu-id="6c90e-120">The two-way receive port used to receive AS2 messages should not be used to receive MDN messages.</span></span> <span data-ttu-id="6c90e-121">应接收 MDN 消息使用静态单向接收端口。</span><span class="sxs-lookup"><span data-stu-id="6c90e-121">MDN messages should be received on a static one-way receive port.</span></span> <span data-ttu-id="6c90e-122">使用请求/响应接收端口以异步方式返回 MDN 将阻止 200OK 消息来响应传入 MDN，从而导致不必要的 MDN 传输返回。</span><span class="sxs-lookup"><span data-stu-id="6c90e-122">Using a request/response receive port for an MDN returned asynchronously would prevent a 200OK message from being returned in response to the incoming MDN, thereby causing unnecessary retries of the MDN transmission.</span></span>  
  
## <a name="how-the-as2-receive-pipelines-work"></a><span data-ttu-id="6c90e-123">AS2 接收管道的工作方式</span><span class="sxs-lookup"><span data-stu-id="6c90e-123">How the AS2 Receive Pipelines Work</span></span>  
 <span data-ttu-id="6c90e-124">AS2 接收管道的步骤执行在处理传入 AS2 消息如下所示：</span><span class="sxs-lookup"><span data-stu-id="6c90e-124">The steps that the AS2 receive pipelines performs in processing an incoming AS2 message are as follows:</span></span>  
  
- <span data-ttu-id="6c90e-125">进行匹配 AS2 来确定发送参与方的消息的 AS2 头部中 AS2 的值的值从-从列表中**标识符**的单向 AS2 协议选项卡页**协议属性**对话框。</span><span class="sxs-lookup"><span data-stu-id="6c90e-125">Determines the sending party by matching the AS2-From value in the AS2 header of the message with the value for AS2-From list in the **Identifiers** page of the one-way AS2 agreement tab of the **Agreement Properties** dialog box.</span></span> <span data-ttu-id="6c90e-126">如果失败，尝试确定发送方通过匹配 AS2-From 上下文属性设置为将传入消息与参与方的名称。</span><span class="sxs-lookup"><span data-stu-id="6c90e-126">If that fails, attempts to determine the sending party by matching the AS2-From context property that is set for the incoming message with the name of a party.</span></span> <span data-ttu-id="6c90e-127">如果找到匹配项，并**使用的验证和 MDN 的协议设置而非消息标头**的单向 AS2 协议选项卡中选择属性**协议属性**对话框中， [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]将使用与参与方的协议来处理 AS2 消息相关联的 AS2 属性。</span><span class="sxs-lookup"><span data-stu-id="6c90e-127">If a match is found, and the **Use agreement settings for validation and MDN instead of message header** property is selected in the one-way AS2 agreement tab of the **Agreement Properties** dialog box, [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] will use the AS2 properties associated with the agreement for the party for processing the AS2 message.</span></span> <span data-ttu-id="6c90e-128">如果不选择该属性，则接收管道将传入消息中使用 AS2 标头标记。</span><span class="sxs-lookup"><span data-stu-id="6c90e-128">If the property is not selected, the receive pipeline will use the AS2 header tags in the incoming message.</span></span> <span data-ttu-id="6c90e-129">如果找不到协议，管道将中止处理，挂起消息，会引发异常。</span><span class="sxs-lookup"><span data-stu-id="6c90e-129">If the agreement is not found, the pipeline aborts processing, suspends the message, and raises an exception.</span></span>  
  
  > [!NOTE]
  >  <span data-ttu-id="6c90e-130">**使用的验证和 MDN 的协议设置而非消息标头**属性允许你验证传入消息具有签名、 加密和压缩属性 (如果在指定了这些属性中的协议**验证**的单向协议选项卡)，如果不能，挂起消息并发布错误。</span><span class="sxs-lookup"><span data-stu-id="6c90e-130">The **Use agreement settings for validation and MDN instead of message header** property allows you to validate that an incoming message has signing, encryption, and compression properties (if those properties are specified in the agreement in the **Validation** tab of the one-way agreement), and if not, to suspend the message and post an error.</span></span> <span data-ttu-id="6c90e-131">必须与发送参与方的协议协商这些更改。</span><span class="sxs-lookup"><span data-stu-id="6c90e-131">These changes must be negotiated with the agreement for the sending party.</span></span> <span data-ttu-id="6c90e-132">有关详细信息请参阅[配置 AS2 属性](../core/configuring-as2-properties.md)。</span><span class="sxs-lookup"><span data-stu-id="6c90e-132">For more information see [Configuring AS2 Properties](../core/configuring-as2-properties.md).</span></span>  
  
- <span data-ttu-id="6c90e-133">如果确定发送参与方的协议，但出现错误时接收管道尝试处理 AS2 消息，该管道将将上下文属性 MessageDestination 设置为 SuspendQueue AS2 消息。</span><span class="sxs-lookup"><span data-stu-id="6c90e-133">If the agreement for the sending party is determined, but an error arises when the receive pipeline attempts to process the AS2 message, the pipeline will set the context property MessageDestination on the AS2 message to SuspendQueue.</span></span> <span data-ttu-id="6c90e-134">接收管道然后将在 MessageBox 中挂起消息。</span><span class="sxs-lookup"><span data-stu-id="6c90e-134">The receive pipeline will then suspend the message in the MessageBox.</span></span> <span data-ttu-id="6c90e-135">接收管道还将设置`EdiIntAS.IsAS2FailedMessage`上下文属性设为 True。</span><span class="sxs-lookup"><span data-stu-id="6c90e-135">The receive pipeline will also set the `EdiIntAS.IsAS2FailedMessage` context property to True.</span></span> <span data-ttu-id="6c90e-136">如果通过设置启用了 MDN**请求 MDN**中**发送方 MDN 设置**的单向 AS2 协议选项卡页**协议属性**对话框中，管道将然后将相应的 MDN 返回给发件人。</span><span class="sxs-lookup"><span data-stu-id="6c90e-136">If an MDN is enabled by setting **Request MDN** in the **Sender MDN Settings** page of the one-way AS2 agreement tab of the **Agreement Properties** dialog box, the pipeline will then return the appropriate MDN to the sender.</span></span> <span data-ttu-id="6c90e-137">管道将始终尝试返回 MDN，如果它请求。</span><span class="sxs-lookup"><span data-stu-id="6c90e-137">The pipeline will always attempt to return an MDN if it is requested.</span></span>  
  
- <span data-ttu-id="6c90e-138">确定消息是否有重复，如果**检查重复消息**中选择选项**验证**的单向 AS2 协议选项卡页**协议属性**对话框。</span><span class="sxs-lookup"><span data-stu-id="6c90e-138">Determines if the message is a duplicate, if the **Check for duplicate messages within** option is selected in the **Validation** page of the one-way AS2 agreement tab of the **Agreement Properties** dialog box.</span></span> <span data-ttu-id="6c90e-139">重复消息检测通过匹配 AS2-From、as2-To 和以前收到的消息上的值对入站消息的消息 ID 值。</span><span class="sxs-lookup"><span data-stu-id="6c90e-139">Duplicate message detection is accomplished by matching the AS2-From, AS2-To, and Message-ID values on the inbound message to values on messages previously received.</span></span> <span data-ttu-id="6c90e-140">如果所有三个值匹配，接收管道将的值设置`EdiIntAs.IsAS2MessageDuplicate`上下文属性设为 true。</span><span class="sxs-lookup"><span data-stu-id="6c90e-140">If all three values match, the receive pipeline will set the value of the `EdiIntAs.IsAS2MessageDuplicate` context property to true.</span></span> <span data-ttu-id="6c90e-141">如果**挂起重复消息**上的选项也**验证**页上，将会挂起该消息并记录一个错误。</span><span class="sxs-lookup"><span data-stu-id="6c90e-141">If the **Suspend duplicate messages** option is also selected on the **Validation** page, the message will be suspended and an error logged.</span></span>  
  
- <span data-ttu-id="6c90e-142">如果有的话，每个附件的检索文件名，并将其升级为上下文属性。</span><span class="sxs-lookup"><span data-stu-id="6c90e-142">Retrieves the file name, if any, of each attachment and promotes this to the context properties.</span></span>  
  
- <span data-ttu-id="6c90e-143">创建消息的副本 （以传输格式），并将该副本存储在不可否认接收数据库中，如果在单向 AS2 协议属性中启用。</span><span class="sxs-lookup"><span data-stu-id="6c90e-143">Makes a copy of the message (in wire format), and stores the copy in the non-repudiation receipt database, if enabled in the one-way AS2 agreement properties.</span></span>  
  
- <span data-ttu-id="6c90e-144">执行 MIME 处理，其中包括验证签名和解密 （基于标头标记） 的消息。</span><span class="sxs-lookup"><span data-stu-id="6c90e-144">Performs MIME processing, including verifying the signature and decrypting the message (based upon the header tags).</span></span>  
  
- <span data-ttu-id="6c90e-145">如果它已压缩，解压缩收到的消息。</span><span class="sxs-lookup"><span data-stu-id="6c90e-145">Decompresses the received message, if it was compressed.</span></span>  
  
- <span data-ttu-id="6c90e-146">生成 HTTP 响应，追加到 MDN 中同步请求-响应模式，或以异步模式作为独立响应发送。</span><span class="sxs-lookup"><span data-stu-id="6c90e-146">Generates an HTTP response, appended to the MDN in synchronous request-response mode, or sent as a standalone response in asynchronous mode.</span></span>  
  
- <span data-ttu-id="6c90e-147">如果请求，将生成 MDN 响应。</span><span class="sxs-lookup"><span data-stu-id="6c90e-147">Generates an MDN response, if requested.</span></span> <span data-ttu-id="6c90e-148">如果，则管道将生成基于协议属性 MDN**使用的验证和 MDN 的协议设置而非消息标头**设置属性，或从上下文属性，如果未设置该属性。</span><span class="sxs-lookup"><span data-stu-id="6c90e-148">The pipeline will generate an MDN based upon agreement properties, if the **Use agreement settings for validation and MDN instead of message header** property is set, or from context properties, if that property is not set.</span></span> <span data-ttu-id="6c90e-149">如果配置设置和传入消息中的标头不一致，则管道将生成一个负值 MDN。</span><span class="sxs-lookup"><span data-stu-id="6c90e-149">If the configuration settings and the headers in the incoming message are inconsistent, the pipeline will generate a negative MDN.</span></span>  
  
- <span data-ttu-id="6c90e-150">EDI 拆装器在 AS2EdiReceive 接收管道生成 EDI 确认，如果消息是 EDI 编码，并且已启用确认。</span><span class="sxs-lookup"><span data-stu-id="6c90e-150">The EDI Disassembler in the AS2EdiReceive receive pipeline generates an EDI acknowledgment, if the message was EDI-encoded and an acknowledgment was enabled.</span></span> <span data-ttu-id="6c90e-151">管道会将 EDI 确认路由到 MessageBox，动态发送端口将从其提取并以异步方式将其发送出去。</span><span class="sxs-lookup"><span data-stu-id="6c90e-151">The pipeline will route the EDI acknowledgment to the MessageBox, from which a dynamic send port will pick it up and send it out asynchronously.</span></span> <span data-ttu-id="6c90e-152">EDI 确认会始终发送以异步方式通过 AS2 传输，因为 MDN 或 HTTP 响应同步发送。</span><span class="sxs-lookup"><span data-stu-id="6c90e-152">EDI acknowledgments are always sent out asynchronously over AS2 transport, because either an MDN or an HTTP response is sent out synchronously.</span></span>  
  
- <span data-ttu-id="6c90e-153">创建 MDN 的副本并将其存储在不可否认接收数据库中，如果在单向 AS2 协议属性中启用。</span><span class="sxs-lookup"><span data-stu-id="6c90e-153">Makes a copy of the MDN, and stores it in the non-repudiation receipt database, if enabled in the one-way AS2 agreement properties.</span></span>  
  
- <span data-ttu-id="6c90e-154">创建副本的已解码的消息，并将该副本存储在不可否认接收数据库中，如果在单向 AS2 协议属性中启用。</span><span class="sxs-lookup"><span data-stu-id="6c90e-154">Makes a copy of the decoded message, and stores the copy in the non-repudiation receipt database, if enabled in the one-way AS2 agreement properties.</span></span>  
  
  <span data-ttu-id="6c90e-155">如果出现 AS2 错误，不进行其他处理会对收到的消息。</span><span class="sxs-lookup"><span data-stu-id="6c90e-155">If an AS2 error occurs, no further processing will occur on the received message.</span></span> <span data-ttu-id="6c90e-156">但是，接收管道仍将生成 MDN 响应。</span><span class="sxs-lookup"><span data-stu-id="6c90e-156">However, the receive pipeline will still generate an MDN response.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="6c90e-157">请参阅</span><span class="sxs-lookup"><span data-stu-id="6c90e-157">See Also</span></span>  
 <span data-ttu-id="6c90e-158">[BizTalk Server 如何接收 AS2 消息](../core/how-biztalk-server-receives-as2-messages.md) </span><span class="sxs-lookup"><span data-stu-id="6c90e-158">[How BizTalk Server Receives AS2 Messages](../core/how-biztalk-server-receives-as2-messages.md) </span></span>  
 <span data-ttu-id="6c90e-159">[AS2 消息](../core/as2-messages.md) </span><span class="sxs-lookup"><span data-stu-id="6c90e-159">[AS2 Messages](../core/as2-messages.md) </span></span>  
 [<span data-ttu-id="6c90e-160">MDN 消息</span><span class="sxs-lookup"><span data-stu-id="6c90e-160">MDN Messages</span></span>](../core/mdn-messages.md)