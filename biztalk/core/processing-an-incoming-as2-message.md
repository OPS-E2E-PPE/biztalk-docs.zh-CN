---
title: "处理传入 AS2 消息 |Microsoft 文档"
ms.custom: 
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: 998ff334-71e2-4686-b2b7-44940a0ebed1
caps.latest.revision: "32"
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: b221ea3697180c27e347250570b0e96105a50f08
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/20/2017
---
# <a name="processing-an-incoming-as2-message"></a><span data-ttu-id="2971a-102">处理传入 AS2 消息</span><span class="sxs-lookup"><span data-stu-id="2971a-102">Processing an Incoming AS2 Message</span></span>
<span data-ttu-id="2971a-103">AS2 接收管道可处理通过 AS2 传入的消息。</span><span class="sxs-lookup"><span data-stu-id="2971a-103">The AS2 receive pipelines process an incoming message over AS2.</span></span> <span data-ttu-id="2971a-104">AS2EdiReceive 接收管道使用 EDI 拆装器处理 EDI 编码的消息。</span><span class="sxs-lookup"><span data-stu-id="2971a-104">The AS2EdiReceive receive pipeline processes an EDI-encoded message, using the EDI Disassembler.</span></span> <span data-ttu-id="2971a-105">AS2Receive 接收管道使用 AS2 拆装器处理非 EDI 编码的消息。</span><span class="sxs-lookup"><span data-stu-id="2971a-105">The AS2Receive receive pipeline processes a non-EDI-encoded message, using the AS2 Disassembler.</span></span> <span data-ttu-id="2971a-106">这两个管道采用不同的方式来处理 AS2 消息负载和生成 MDN；不过，两个接收管道都使用 AS2 解码器来处理 AS2 消息。</span><span class="sxs-lookup"><span data-stu-id="2971a-106">The two pipelines process the payload of the AS2 message and generate an MDN differently; however, both receive pipelines use the AS2 Decoder to process the AS2 message.</span></span>  
  
 <span data-ttu-id="2971a-107">在 AS2EdiReceive 管道处理带有 EDI 负载的传入 AS2 消息时，该管道会先完成对已接收消息的 AS2 处理，然后执行 EDI 处理。</span><span class="sxs-lookup"><span data-stu-id="2971a-107">When the AS2EdiReceivePipeline processes an AS2 message with an EDI payload, it completes the AS2 processing of the received message before performing the EDI processing.</span></span> <span data-ttu-id="2971a-108">如果该管道为 AS2 消息的 EDI 负载生成一个 EDI 确认，则它必须异步返回该 EDI 确认，因为连接已由 AS2 响应关闭。</span><span class="sxs-lookup"><span data-stu-id="2971a-108">When the pipeline generates an EDI acknowledgment for the EDI payload of an AS2 message, it must return the EDI acknowledgment asynchronously, because the connection is closed by the AS2 response.</span></span>  
  
## <a name="the-receive-port"></a><span data-ttu-id="2971a-109">接收端口</span><span class="sxs-lookup"><span data-stu-id="2971a-109">The Receive Port</span></span>  
 <span data-ttu-id="2971a-110">HTTP 接收端口用于接收带有 EDI 或非 EDI 负载的 AS2 消息。</span><span class="sxs-lookup"><span data-stu-id="2971a-110">An HTTP receive port is used to receive an AS2 message with an EDI or non-EDI payload.</span></span> <span data-ttu-id="2971a-111">如果必须同步返回 MDN，则接收端口必须是请求-响应端口。</span><span class="sxs-lookup"><span data-stu-id="2971a-111">If an MDN must be returned synchronously, then the receive port must be a request-response port.</span></span>  
  
 <span data-ttu-id="2971a-112">可同步或异步返回 MDN。</span><span class="sxs-lookup"><span data-stu-id="2971a-112">An MDN can be returned synchronously or asynchronously.</span></span> <span data-ttu-id="2971a-113">这由 AS2 消息中，处理设置-通知-to 标头，除非**使用验证和 MDN 的协议设置，而不是消息标头**的单向AS2协议选项卡中选择属性**协议属性**对话框。</span><span class="sxs-lookup"><span data-stu-id="2971a-113">This is determined by the Disposition-notification-to header of the AS2 message, unless the **Use agreement settings for validation and MDN instead of message header** property is selected in the one-way AS2 agreement tab of the **Agreement Properties** dialog box.</span></span> <span data-ttu-id="2971a-114">如果选择属性，则返回 MDN 的方式由**请求异步 MDN**中的属性**发件人 MDN 设置**的单向 AS2 协议选项卡页**协议属性**对话框。</span><span class="sxs-lookup"><span data-stu-id="2971a-114">If the property is selected, the way the MDN is returned is determined by the **Request asynchronous MDN** property in the **Sender MDN Settings** page of the one-way AS2 agreement tab of the **Agreement Properties** dialog box.</span></span> <span data-ttu-id="2971a-115">有关详细信息，请参阅[AS2 消息](../core/as2-messages.md)和[MDN 消息](../core/mdn-messages.md)。</span><span class="sxs-lookup"><span data-stu-id="2971a-115">For more information, see [AS2 Messages](../core/as2-messages.md) and [MDN Messages](../core/mdn-messages.md).</span></span>  
  
 <span data-ttu-id="2971a-116">如果将同步返回 MDN，则 MDN 将通过双向接收位置的发送端口返回。</span><span class="sxs-lookup"><span data-stu-id="2971a-116">If the MDN will be returned synchronously, the MDN is returned over the send port of the two-way receive location.</span></span> <span data-ttu-id="2971a-117">此 MDN 将用作 HTTP 响应，例如，200OK 指示成功接收消息。</span><span class="sxs-lookup"><span data-stu-id="2971a-117">This MDN serves as the HTTP response, for example, a 200OK indicating successful reception of the message.</span></span>  
  
 <span data-ttu-id="2971a-118">如果将以异步方式返回 MDN，则 MDN 必须通过一个单独的发送端口返回。</span><span class="sxs-lookup"><span data-stu-id="2971a-118">If the MDN will be returned asynchronously, the MDN must be returned over a separate send port.</span></span> <span data-ttu-id="2971a-119">如果使用一个动态发送端口，则 MDN 将发送到 Disposition-notification-To 标头中所包含的地址。</span><span class="sxs-lookup"><span data-stu-id="2971a-119">If a dynamic send port is used, the MDN will be sent to the address contained in Disposition-notification-to header.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="2971a-120">用于接收 AS2 消息的双向接收端口不得用于接收 MDN 消息，</span><span class="sxs-lookup"><span data-stu-id="2971a-120">The two-way receive port used to receive AS2 messages should not be used to receive MDN messages.</span></span> <span data-ttu-id="2971a-121">而应使用静态单向接收端口来接收 MDN 消息。</span><span class="sxs-lookup"><span data-stu-id="2971a-121">MDN messages should be received on a static one-way receive port.</span></span> <span data-ttu-id="2971a-122">对异步返回的 MDN 使用请求/响应接收端口将会阻止返回 200OK 消息来响应传入 MDN，从而导致不必要的 MDN 重新传输。</span><span class="sxs-lookup"><span data-stu-id="2971a-122">Using a request/response receive port for an MDN returned asynchronously would prevent a 200OK message from being returned in response to the incoming MDN, thereby causing unnecessary retries of the MDN transmission.</span></span>  
  
## <a name="how-the-as2-receive-pipelines-work"></a><span data-ttu-id="2971a-123">AS2 接收管道的工作原理</span><span class="sxs-lookup"><span data-stu-id="2971a-123">How the AS2 Receive Pipelines Work</span></span>  
 <span data-ttu-id="2971a-124">AS2 接收管道处理传入 AS2 消息的步骤如下：</span><span class="sxs-lookup"><span data-stu-id="2971a-124">The steps that the AS2 receive pipelines performs in processing an incoming AS2 message are as follows:</span></span>  
  
-   <span data-ttu-id="2971a-125">通过匹配 AS2 确定发送方-中消息的 AS2 标头值与 AS2 的值从-从列表中**标识符**的单向 AS2 协议选项卡页**协议属性**对话框。</span><span class="sxs-lookup"><span data-stu-id="2971a-125">Determines the sending party by matching the AS2-From value in the AS2 header of the message with the value for AS2-From list in the **Identifiers** page of the one-way AS2 agreement tab of the **Agreement Properties** dialog box.</span></span> <span data-ttu-id="2971a-126">如果通过上述方式无法确定，则通过将为传入消息设置的 AS2-From 上下文属性与参与方的名称进行匹配来尝试确定发送参与方。</span><span class="sxs-lookup"><span data-stu-id="2971a-126">If that fails, attempts to determine the sending party by matching the AS2-From context property that is set for the incoming message with the name of a party.</span></span> <span data-ttu-id="2971a-127">如果找到匹配项，则与**使用验证和 MDN 的协议设置，而不是消息标头**的单向 AS2 协议选项卡中选择属性**协议属性**对话框中， [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]将使用方的协议与关联用于处理 AS2 消息的 AS2 属性。</span><span class="sxs-lookup"><span data-stu-id="2971a-127">If a match is found, and the **Use agreement settings for validation and MDN instead of message header** property is selected in the one-way AS2 agreement tab of the **Agreement Properties** dialog box, [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] will use the AS2 properties associated with the agreement for the party for processing the AS2 message.</span></span> <span data-ttu-id="2971a-128">如果没有选择该属性，则接收管道将使用传入消息中的 AS2 标头标记。</span><span class="sxs-lookup"><span data-stu-id="2971a-128">If the property is not selected, the receive pipeline will use the AS2 header tags in the incoming message.</span></span> <span data-ttu-id="2971a-129">如果未找到协议，则接收管道将中止处理，挂起消息并引发异常。</span><span class="sxs-lookup"><span data-stu-id="2971a-129">If the agreement is not found, the pipeline aborts processing, suspends the message, and raises an exception.</span></span>  
  
    > [!NOTE]
    >  <span data-ttu-id="2971a-130">**使用验证和 MDN 的协议设置，而不是消息标头**属性允许您验证传入消息具有签名、 加密和压缩属性 (如果未指定这些属性中的协议**验证**单向协议的选项卡)，如果不是，若要挂起消息并发布错误。</span><span class="sxs-lookup"><span data-stu-id="2971a-130">The **Use agreement settings for validation and MDN instead of message header** property allows you to validate that an incoming message has signing, encryption, and compression properties (if those properties are specified in the agreement in the **Validation** tab of the one-way agreement), and if not, to suspend the message and post an error.</span></span> <span data-ttu-id="2971a-131">必须与发送参与方的协议协商这些更改。</span><span class="sxs-lookup"><span data-stu-id="2971a-131">These changes must be negotiated with the agreement for the sending party.</span></span> <span data-ttu-id="2971a-132">有关详细信息请参阅[配置 AS2 属性](../core/configuring-as2-properties.md)。</span><span class="sxs-lookup"><span data-stu-id="2971a-132">For more information see [Configuring AS2 Properties](../core/configuring-as2-properties.md).</span></span>  
  
-   <span data-ttu-id="2971a-133">如果发送参与方的协议已确定，但在接收管道尝试处理 AS2 消息时出现错误，则该管道会将 AS2 消息的上下文属性 MessageDestination 设置为 SuspendQueue。</span><span class="sxs-lookup"><span data-stu-id="2971a-133">If the agreement for the sending party is determined, but an error arises when the receive pipeline attempts to process the AS2 message, the pipeline will set the context property MessageDestination on the AS2 message to SuspendQueue.</span></span> <span data-ttu-id="2971a-134">然后，接收管道将挂起 MessageBox 中的消息。</span><span class="sxs-lookup"><span data-stu-id="2971a-134">The receive pipeline will then suspend the message in the MessageBox.</span></span> <span data-ttu-id="2971a-135">接收管道还会将 `EdiIntAS.IsAS2FailedMessage` 上下文属性设置为 True。</span><span class="sxs-lookup"><span data-stu-id="2971a-135">The receive pipeline will also set the `EdiIntAS.IsAS2FailedMessage` context property to True.</span></span> <span data-ttu-id="2971a-136">如果通过设置启用了 MDN**请求 MDN**中**发件人 MDN 设置**的单向 AS2 协议选项卡页**协议属性**对话框中，管道将然后返回到发件人的相应 MDN。</span><span class="sxs-lookup"><span data-stu-id="2971a-136">If an MDN is enabled by setting **Request MDN** in the **Sender MDN Settings** page of the one-way AS2 agreement tab of the **Agreement Properties** dialog box, the pipeline will then return the appropriate MDN to the sender.</span></span> <span data-ttu-id="2971a-137">如果已请求 MDN，则该管道将始终尝试返回 MDN。</span><span class="sxs-lookup"><span data-stu-id="2971a-137">The pipeline will always attempt to return an MDN if it is requested.</span></span>  
  
-   <span data-ttu-id="2971a-138">确定消息是否有重复，如果**检查中的重复消息**中选择选项**验证**的单向 AS2 协议选项卡页**协议属性**对话框。</span><span class="sxs-lookup"><span data-stu-id="2971a-138">Determines if the message is a duplicate, if the **Check for duplicate messages within** option is selected in the **Validation** page of the one-way AS2 agreement tab of the **Agreement Properties** dialog box.</span></span> <span data-ttu-id="2971a-139">通过将入站消息上的 AS2-From、AS2-To 和 Message-ID 值与以前收到的消息上的值相匹配，可实现重复消息的检测。</span><span class="sxs-lookup"><span data-stu-id="2971a-139">Duplicate message detection is accomplished by matching the AS2-From, AS2-To, and Message-ID values on the inbound message to values on messages previously received.</span></span> <span data-ttu-id="2971a-140">如果所有三个值都匹配，则接收管道会将 `EdiIntAs.IsAS2MessageDuplicate` 上下文属性的值设置为 True。</span><span class="sxs-lookup"><span data-stu-id="2971a-140">If all three values match, the receive pipeline will set the value of the `EdiIntAs.IsAS2MessageDuplicate` context property to true.</span></span> <span data-ttu-id="2971a-141">如果**挂起重复消息**上的选项也**验证**页上，将挂起消息和错误记录。</span><span class="sxs-lookup"><span data-stu-id="2971a-141">If the **Suspend duplicate messages** option is also selected on the **Validation** page, the message will be suspended and an error logged.</span></span>  
  
-   <span data-ttu-id="2971a-142">检索每个附件的文件名（如果有），并将其升级为上下文属性。</span><span class="sxs-lookup"><span data-stu-id="2971a-142">Retrieves the file name, if any, of each attachment and promotes this to the context properties.</span></span>  
  
-   <span data-ttu-id="2971a-143">以传输格式创建消息的副本，并将该副本存储在不可否认接收数据库中（如果在单向 AS2 协议属性中启用了相应选项）。</span><span class="sxs-lookup"><span data-stu-id="2971a-143">Makes a copy of the message (in wire format), and stores the copy in the non-repudiation receipt database, if enabled in the one-way AS2 agreement properties.</span></span>  
  
-   <span data-ttu-id="2971a-144">执行 MIME 处理，其中包括验证签名并对消息进行解密（基于标头标记）。</span><span class="sxs-lookup"><span data-stu-id="2971a-144">Performs MIME processing, including verifying the signature and decrypting the message (based upon the header tags).</span></span>  
  
-   <span data-ttu-id="2971a-145">如果已接收消息是经过压缩的消息，则对其进行解压缩。</span><span class="sxs-lookup"><span data-stu-id="2971a-145">Decompresses the received message, if it was compressed.</span></span>  
  
-   <span data-ttu-id="2971a-146">生成 HTTP 响应，该响应将以同步请求-响应模式追加到 MDN 中，或以异步模式作为独立响应发送。</span><span class="sxs-lookup"><span data-stu-id="2971a-146">Generates an HTTP response, appended to the MDN in synchronous request-response mode, or sent as a standalone response in asynchronous mode.</span></span>  
  
-   <span data-ttu-id="2971a-147">如果需要，则生成 MDN 响应。</span><span class="sxs-lookup"><span data-stu-id="2971a-147">Generates an MDN response, if requested.</span></span> <span data-ttu-id="2971a-148">如果，管道将生成基于协议属性 MDN**使用验证和 MDN 的协议设置，而不是消息标头**设置属性，或从上下文属性中，如果未设置该属性。</span><span class="sxs-lookup"><span data-stu-id="2971a-148">The pipeline will generate an MDN based upon agreement properties, if the **Use agreement settings for validation and MDN instead of message header** property is set, or from context properties, if that property is not set.</span></span> <span data-ttu-id="2971a-149">如果传入消息中的配置设置和标头不一致，则管道将生成一个负值 MDN。</span><span class="sxs-lookup"><span data-stu-id="2971a-149">If the configuration settings and the headers in the incoming message are inconsistent, the pipeline will generate a negative MDN.</span></span>  
  
-   <span data-ttu-id="2971a-150">如果是 EDI 编码的消息并且已启用确认，则 AS2EdiReceive 接收管道中的 EDI 拆装器会生成 EDI 确认。</span><span class="sxs-lookup"><span data-stu-id="2971a-150">The EDI Disassembler in the AS2EdiReceive receive pipeline generates an EDI acknowledgment, if the message was EDI-encoded and an acknowledgment was enabled.</span></span> <span data-ttu-id="2971a-151">该管道会将 EDI 确认路由到 MessageBox，而动态发送端口将从 MessageBox 中提取并异步发送 EDI 确认。</span><span class="sxs-lookup"><span data-stu-id="2971a-151">The pipeline will route the EDI acknowledgment to the MessageBox, from which a dynamic send port will pick it up and send it out asynchronously.</span></span> <span data-ttu-id="2971a-152">EDI 确认会始终通过 AS2 传输类型异步发送，因为 MDN 或 HTTP 响应是同步发送的。</span><span class="sxs-lookup"><span data-stu-id="2971a-152">EDI acknowledgments are always sent out asynchronously over AS2 transport, because either an MDN or an HTTP response is sent out synchronously.</span></span>  
  
-   <span data-ttu-id="2971a-153">创建 MDN 的副本，并将其存储在不可否认接收数据库中（如果在单向 AS2 协议属性中启用了相应选项）。</span><span class="sxs-lookup"><span data-stu-id="2971a-153">Makes a copy of the MDN, and stores it in the non-repudiation receipt database, if enabled in the one-way AS2 agreement properties.</span></span>  
  
-   <span data-ttu-id="2971a-154">创建解码后的消息的副本，并将该副本存储在不可否认接收数据库中（如果在单向 AS2 协议属性中启用了相应选项）。</span><span class="sxs-lookup"><span data-stu-id="2971a-154">Makes a copy of the decoded message, and stores the copy in the non-repudiation receipt database, if enabled in the one-way AS2 agreement properties.</span></span>  
  
 <span data-ttu-id="2971a-155">如果出现 AS2 错误，则不会对接收的消息进行进一步的处理。</span><span class="sxs-lookup"><span data-stu-id="2971a-155">If an AS2 error occurs, no further processing will occur on the received message.</span></span> <span data-ttu-id="2971a-156">然而，接收管道仍将生成 MDN 响应。</span><span class="sxs-lookup"><span data-stu-id="2971a-156">However, the receive pipeline will still generate an MDN response.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="2971a-157">另请参阅</span><span class="sxs-lookup"><span data-stu-id="2971a-157">See Also</span></span>  
 <span data-ttu-id="2971a-158">[BizTalk Server 接收 AS2 消息的方式](../core/how-biztalk-server-receives-as2-messages.md) </span><span class="sxs-lookup"><span data-stu-id="2971a-158">[How BizTalk Server Receives AS2 Messages](../core/how-biztalk-server-receives-as2-messages.md) </span></span>  
 <span data-ttu-id="2971a-159">[AS2 消息](../core/as2-messages.md) </span><span class="sxs-lookup"><span data-stu-id="2971a-159">[AS2 Messages](../core/as2-messages.md) </span></span>  
 [<span data-ttu-id="2971a-160">MDN 消息</span><span class="sxs-lookup"><span data-stu-id="2971a-160">MDN Messages</span></span>](../core/mdn-messages.md)