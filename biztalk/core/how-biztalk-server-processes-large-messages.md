---
title: BizTalk Server 如何处理大消息 |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 62c070be-dff5-4349-9e36-dd3a7caf1752
caps.latest.revision: 33
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 0e9d2d31163dcb49861b1cdb6331579502960b6e
ms.sourcegitcommit: 381e83d43796a345488d54b3f7413e11d56ad7be
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/07/2019
ms.locfileid: "65387479"
---
# <a name="how-biztalk-server-processes-large-messages"></a><span data-ttu-id="ddab1-102">BizTalk Server 如何处理大消息</span><span class="sxs-lookup"><span data-stu-id="ddab1-102">How BizTalk Server Processes Large Messages</span></span>
## <a name="what-is-a-large-message"></a><span data-ttu-id="ddab1-103">什么是大消息？</span><span class="sxs-lookup"><span data-stu-id="ddab1-103">What is a large message?</span></span>  
 <span data-ttu-id="ddab1-104">遗憾的是，此问题的答案而不能局限于特定的消息大小直接，取决于您的 Microsoft 的特定瓶颈[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]系统。</span><span class="sxs-lookup"><span data-stu-id="ddab1-104">Unfortunately, the answer to this question isn't tied directly to a specific message size, but rather, depends on specific bottlenecks in your Microsoft [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] system.</span></span> <span data-ttu-id="ddab1-105">与大消息相关的问题可以分为以下类别：</span><span class="sxs-lookup"><span data-stu-id="ddab1-105">The problems associated with large messages can be divided into the following categories:</span></span>  
  
-   <span data-ttu-id="ddab1-106">**内存不足错误**某些类型的消息处理-例如映射、 验证和属性升级的整个消息加载到内存中。</span><span class="sxs-lookup"><span data-stu-id="ddab1-106">**Out of memory errors** Certain types of message processing - such as mapping, validation, and property promotion - load the entire message into memory.</span></span> <span data-ttu-id="ddab1-107">如果在内存中消息的大小超出了可用资源，则会发生内存不足错误。</span><span class="sxs-lookup"><span data-stu-id="ddab1-107">If the size of the message in memory exceeds available resources, then an out of memory error occurs.</span></span> <span data-ttu-id="ddab1-108">属于此类别的消息大小阈值是未加载到内存中的消息大小阈值要低得多。</span><span class="sxs-lookup"><span data-stu-id="ddab1-108">The size threshold for messages that fall into this category is much lower than the size threshold for messages that are not loaded into memory.</span></span> <span data-ttu-id="ddab1-109">例如，10 MB 平面文件，是解析为 XML，然后映射可能会增长到原来的 10 或更多占用多于 100 MB 的内存，而 100 MB 的 XML 文档，它是未解析或映射实际上只占用 1 MB 的内存，因为它保存到 MessageBox 数据库中。</span><span class="sxs-lookup"><span data-stu-id="ddab1-109">For example, a 10 MB flat file that is parsed into XML and then mapped may grow by a factor of 10 or more to consume over 100 MB of memory, whereas a 100 MB XML document that is not parsed or mapped may actually only consume 1 MB of memory as it is streamed to the MessageBox database.</span></span>  
  
-   <span data-ttu-id="ddab1-110">**未加载到内存中的消息的性能问题**不需要加载到内存的消息保存到 MessageBox 数据库使用.NET XmlReader 接口。</span><span class="sxs-lookup"><span data-stu-id="ddab1-110">**Performance problems for messages that are not loaded into memory** Messages that are not required to be loaded into memory are streamed to the MessageBox database using the .NET XmlReader interface.</span></span> <span data-ttu-id="ddab1-111">虽然它们不受约束必须加载到内存的消息的大小限制，有几个重要因素影响 BizTalk Server 如何处理消息传输到 MessageBox 数据库。</span><span class="sxs-lookup"><span data-stu-id="ddab1-111">While they are not subject to the size limitations on messages that must be loaded into memory, there are some important factors that impact how BizTalk Server processes messages that are streamed to the MessageBox database.</span></span>  
  
## <a name="factors-that-affect-the-processing-of-large-messages"></a><span data-ttu-id="ddab1-112">因素会影响处理大消息</span><span class="sxs-lookup"><span data-stu-id="ddab1-112">Factors that affect the processing of large messages</span></span>  
 <span data-ttu-id="ddab1-113">原始消息大小、 消息格式和消息处理所有的类型会影响 BizTalk Server 如何处理大消息。</span><span class="sxs-lookup"><span data-stu-id="ddab1-113">The original message size, message format, and type of message processing all affect how BizTalk Server processes large messages.</span></span>  
  
- <span data-ttu-id="ddab1-114">**原始消息大小**由 BizTalk Server 接收的消息的大小是多大消息时，将 BizTalk Server 处理的最明显的指示。</span><span class="sxs-lookup"><span data-stu-id="ddab1-114">**Original message size** The size of the message received by BizTalk Server is the most visible indication of how large the message will be when it is processed by BizTalk Server.</span></span> <span data-ttu-id="ddab1-115">如果整个消息加载到内存比消息流式传输到 MessageBox 数据库，一条消息的原始大小有很多更大的影响性能。</span><span class="sxs-lookup"><span data-stu-id="ddab1-115">The original size of a message has a much greater impact on performance if the entire message is loaded into memory than if the message is streamed to the MessageBox database.</span></span>  
  
- <span data-ttu-id="ddab1-116">**消息格式**消息接收到 BizTalk Server 在两种主要格式之一：XML 文件或平面文件。</span><span class="sxs-lookup"><span data-stu-id="ddab1-116">**Message format** Messages are received into BizTalk Server in one of two primary formats: XML files or flat files.</span></span>  
  
  -   <span data-ttu-id="ddab1-117">**XML 文件**使 BizTalk Server 以执行任何处理而不是直通路由的消息，消息必须采用 XML 文件格式。</span><span class="sxs-lookup"><span data-stu-id="ddab1-117">**XML files** In order for BizTalk Server to perform any processing on a message other than pass through routing, the message must be in the XML file format.</span></span> <span data-ttu-id="ddab1-118">如果要处理的文件以 XML 格式接收，则大多数情况下，他们将保留其原始大小。</span><span class="sxs-lookup"><span data-stu-id="ddab1-118">If the files to be processed are received in XML format then they will retain their original size for the most part.</span></span>  
  
  -   <span data-ttu-id="ddab1-119">**平面文件**BizTalk Server 可以执行任何处理而不是直通路由之前，必须为 XML 格式解析平面文件。</span><span class="sxs-lookup"><span data-stu-id="ddab1-119">**Flat files** Flat files must be parsed into an XML format before BizTalk Server can perform any processing other than pass through routing.</span></span> <span data-ttu-id="ddab1-120">将平面文件解析到一个 XML 文件可以极大地增加文件的大小。</span><span class="sxs-lookup"><span data-stu-id="ddab1-120">Parsing a flat file into an XML file can greatly increase the size of the file.</span></span> <span data-ttu-id="ddab1-121">平面文件不包含有关其数据的描述性信息的 XML 标记。</span><span class="sxs-lookup"><span data-stu-id="ddab1-121">Flat files do not contain XML tags with descriptive information about their data.</span></span> <span data-ttu-id="ddab1-122">XML 文件，但是，包装其所有数据在描述性 XML 标记。</span><span class="sxs-lookup"><span data-stu-id="ddab1-122">XML files, on the other hand, wrap all of their data in descriptive XML tags.</span></span> <span data-ttu-id="ddab1-123">在某些情况下分析可以将大小增加的平面文件的文件的 XML 标记中包含的 10 个或多个，具体取决于多少描述性数据的因素。</span><span class="sxs-lookup"><span data-stu-id="ddab1-123">In some scenarios parsing can increase the size of a flat file by a factor of 10 or more, depending on how much descriptive data is contained in the XML tags for the file.</span></span>  
  
  -   <span data-ttu-id="ddab1-124">**平面文件文档包装在 XML 文档中的单个 CDATA 部分节点**这种类型的文档是 XML 和平面文件的组合，并且可能会产生问题，因为 BizTalk Server 必须将整个包装的平面文件文档加载到内存之前处理它。</span><span class="sxs-lookup"><span data-stu-id="ddab1-124">**Flat file documents wrapped in a single CDATA section node in an XML document** This type of document is a combination of both XML and flat file and can be problematic because BizTalk Server must load the entire wrapped flat file document into memory before processing it.</span></span>  
  
- <span data-ttu-id="ddab1-125">**消息的处理类型**在 BizTalk Server 中，有两种类型的消息处理：仅路由和映射。</span><span class="sxs-lookup"><span data-stu-id="ddab1-125">**Type of message processing** In BizTalk Server, there are two types of message processing: Routing only and Mapping.</span></span> <span data-ttu-id="ddab1-126">绑定到的消息处理的类型的性能变量执行包括消息大小以及是否将消息加载到内存。</span><span class="sxs-lookup"><span data-stu-id="ddab1-126">The performance variables tied to the type of message processing that is performed are message size and whether the message is loaded into memory.</span></span>  
  
  - <span data-ttu-id="ddab1-127">**仅路由**如果 BizTalk Server 仅用于仅消息路由基于升级的消息属性，则消息进行流式处理到 Messagebox 数据库中使用.NET XmlReader 接口和消息部分都不是单独加载到内存。</span><span class="sxs-lookup"><span data-stu-id="ddab1-127">**Routing only** If BizTalk Server is only used only for routing messages based upon promoted message properties, then the message is streamed into the Messagebox database using the .NET XmlReader interface, and message parts are not individually loaded into memory.</span></span> <span data-ttu-id="ddab1-128">在此方案中，内存不足错误不是问题和主要考虑因素是需要非常大的消息 (大于 100 MB) 写入 Messagebox 数据库的时间量。</span><span class="sxs-lookup"><span data-stu-id="ddab1-128">In this scenario, out of memory errors are not an issue and the primary consideration is the amount of time that is required to write very large messages (over 100 MB) into the Messagebox database.</span></span> <span data-ttu-id="ddab1-129">执行仅路由时，BizTalk Server 开发团队已成功测试了处理的消息最多 1 GB 的大小。</span><span class="sxs-lookup"><span data-stu-id="ddab1-129">The BizTalk Server development team has successfully tested the processing of messages up to 1 GB in size when performing routing only.</span></span>  
  
     <span data-ttu-id="ddab1-130">确定在此方案中性能的主要因素是**大消息片段大小**用于将数据分段到数据库。</span><span class="sxs-lookup"><span data-stu-id="ddab1-130">The primary factor that determines performance in this scenario is the **Large message fragment size** used to fragment the data into the database.</span></span> <span data-ttu-id="ddab1-131">**大消息片段大小**上是一个可配置选项**BizTalk 组属性**配置页上，默认值为 102400 字节 (100 KB)。</span><span class="sxs-lookup"><span data-stu-id="ddab1-131">The **Large message fragment size** is a configurable option on the **BizTalk Group Properties** configuration page and has a default value of 102400 bytes (100 KB).</span></span> <span data-ttu-id="ddab1-132">增加此值可减少流式传输到 MessageBox 数据库中的一条消息所需的往返的次数。</span><span class="sxs-lookup"><span data-stu-id="ddab1-132">Increasing this value reduces the number of round trips required to stream a message into the MessageBox database.</span></span>  
  
  - <span data-ttu-id="ddab1-133">**映射**使用映射转换文档可能是占用大量内存的操作。</span><span class="sxs-lookup"><span data-stu-id="ddab1-133">**Mapping** Transforming a document with a map can be a memory-intensive operation.</span></span> <span data-ttu-id="ddab1-134">当通过映射转换文档时，BizTalk Server 将消息传递到.Net XSLCompileTransform 类，以加载 XSL 样式表。</span><span class="sxs-lookup"><span data-stu-id="ddab1-134">When a document is transformed by a map, BizTalk Server passes the message to the .Net XSLCompileTransform class, which loads the XSL style sheet.</span></span> <span data-ttu-id="ddab1-135">Load 方法成功完成后，调用 Transform 方法可以同时从多个线程。</span><span class="sxs-lookup"><span data-stu-id="ddab1-135">After the Load method completes successfully, the Transform method can be called simultaneously from multiple threads.</span></span> <span data-ttu-id="ddab1-136">[XslCompiledTransform 类](http://go.microsoft.com/fwlink/p/?LinkID=282683)XSLCompiledTransform 类提供了详细信息。</span><span class="sxs-lookup"><span data-stu-id="ddab1-136">[XslCompiledTransform Class](http://go.microsoft.com/fwlink/p/?LinkID=282683) provides more information on the XSLCompiledTransform class.</span></span>  
  
     [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] <span data-ttu-id="ddab1-137">通过实现在转换过程将文档加载到内存的可配置的消息大小阈值可显著提高大型文档的内存管理。</span><span class="sxs-lookup"><span data-stu-id="ddab1-137">significantly improves memory management for large documents by implementing a configurable message size threshold for loading documents into memory during transforms.</span></span> <span data-ttu-id="ddab1-138">低于此阈值大小的任何消息处理在内存中;任何消息，高于此阈值大小且缓冲到文件系统，从而减少内存需求。</span><span class="sxs-lookup"><span data-stu-id="ddab1-138">Any message with a size below this threshold is handled in memory; any message with a size above this threshold is buffered to the file system to reduce memory requirements.</span></span> <span data-ttu-id="ddab1-139">默认消息大小阈值为 1 MB。</span><span class="sxs-lookup"><span data-stu-id="ddab1-139">The default message size threshold is 1 MB.</span></span>  
  
## <a name="guidelines-for-processing-large-messages"></a><span data-ttu-id="ddab1-140">处理大消息的指导原则</span><span class="sxs-lookup"><span data-stu-id="ddab1-140">Guidelines for processing large messages</span></span>  
 <span data-ttu-id="ddab1-141">请遵循以下准则来提高性能，处理大消息在 BizTalk Server 中的时：</span><span class="sxs-lookup"><span data-stu-id="ddab1-141">Follow these guidelines to improve performance when processing large messages in BizTalk Server:</span></span>  
  
1. <span data-ttu-id="ddab1-142">调整消息大小阈值，高于此文档将缓冲到文件系统映射过程。</span><span class="sxs-lookup"><span data-stu-id="ddab1-142">Adjust the message size threshold above which documents are buffered to the file system during mapping.</span></span> <span data-ttu-id="ddab1-143">若要修改大小阈值，请创建一个名为**TransformThreshold**中 BizTalk Server 注册表的以下位置：</span><span class="sxs-lookup"><span data-stu-id="ddab1-143">To modify the size threshold, create a DWORD value named **TransformThreshold** at the following location in the BizTalk Server registry:</span></span>  
  
   ```  
   HKLM\Software\Microsoft\BizTalk Server\3.0\Administration\TransformThreshold  
   ```  
  
    <span data-ttu-id="ddab1-144">创建此值后，输入要设置为新阈值的字节数的十进制值。</span><span class="sxs-lookup"><span data-stu-id="ddab1-144">After you have created this value, enter a decimal value with the number of bytes to set the new threshold to.</span></span> <span data-ttu-id="ddab1-145">例如，输入十进制值 2097152 可增加到 2 MB 的消息大小阈值 （从 1 MB 的默认值）。</span><span class="sxs-lookup"><span data-stu-id="ddab1-145">For example, enter a decimal value of 2097152 to increase the message size threshold to 2 MB (from the default of 1 MB).</span></span> <span data-ttu-id="ddab1-146">增大此值在具有大量的可用内存来提高吞吐量的系统上。</span><span class="sxs-lookup"><span data-stu-id="ddab1-146">Increase this value on systems with a large amount of available memory to improve throughput.</span></span> <span data-ttu-id="ddab1-147">将文档缓存到磁盘，从而节约内存在整体吞吐量会产生费用。</span><span class="sxs-lookup"><span data-stu-id="ddab1-147">Buffering documents to disk conserves memory at a cost to overall throughput.</span></span>  
  
   > [!NOTE]
   >  <span data-ttu-id="ddab1-148">默认情况下，在映射期间缓冲到文件系统中的文档会写入到 *%temp%* BizTalk Server 计算机的目录。</span><span class="sxs-lookup"><span data-stu-id="ddab1-148">By default, documents that are buffered to the file system during mapping are written to the *%temp%* directory of the BizTalk Server computer.</span></span> <span data-ttu-id="ddab1-149">更改的设置 *%temp%* 环境变量为非系统磁盘，以提高大型消息缓存到文件系统映射过程时的性能。</span><span class="sxs-lookup"><span data-stu-id="ddab1-149">Change the setting for the *%temp%* environment variable to a non-system disk to improve performance when buffering large messages to the file system during mapping.</span></span>  
  
2. <span data-ttu-id="ddab1-150">最小化使用业务流程中的映射：</span><span class="sxs-lookup"><span data-stu-id="ddab1-150">Minimize the use of maps in orchestrations:</span></span>  
  
   -   <span data-ttu-id="ddab1-151">如果使用映射来提取或设置与一起使用的属性在业务流程中的业务逻辑使用可分辨的字段，或升级属性进行替代。</span><span class="sxs-lookup"><span data-stu-id="ddab1-151">If you are using a map to extract or set properties used with business logic in an orchestration, use distinguished fields or promoted properties instead.</span></span> <span data-ttu-id="ddab1-152">提取或设置一个带有地图的值时在文档加载到内存。</span><span class="sxs-lookup"><span data-stu-id="ddab1-152">When extracting or setting values with a map the document is loaded into memory.</span></span> <span data-ttu-id="ddab1-153">当使用可分辨字段或升级的属性时，业务流程引擎访问消息上下文，并不会将文档加载到内存中。</span><span class="sxs-lookup"><span data-stu-id="ddab1-153">When using distinguished fields or promoted properties, the Orchestration engine accesses the message context and does not load the document into memory.</span></span>  
  
   -   <span data-ttu-id="ddab1-154">如果您使用映射将多个字段聚合为一个字段，请使用可分辨的字段或升级的属性与业务流程变量累积的结果集。</span><span class="sxs-lookup"><span data-stu-id="ddab1-154">If you are using a map to aggregate several fields into one field, use distinguished fields or promoted properties with an orchestration variable to accumulate the result set.</span></span>  
  
   -   <span data-ttu-id="ddab1-155">不要配置具有多个输入转换形状的业务流程。</span><span class="sxs-lookup"><span data-stu-id="ddab1-155">Do not configure an orchestration with multiple inputs to transform shapes.</span></span> <span data-ttu-id="ddab1-156">包含多个输入转换形状的业务流程将不会流入到文件系统映射时。</span><span class="sxs-lookup"><span data-stu-id="ddab1-156">An orchestration that contains multiple inputs to transform shapes will not stream to the file system while mapping.</span></span> <span data-ttu-id="ddab1-157">此限制将导致整个映射加载到内存中，如果文档大小超过指定的 TransformThreshold 注册表值的文档。</span><span class="sxs-lookup"><span data-stu-id="ddab1-157">This limitation will cause the entire document that is being mapped to load into memory if the document size exceeds the specified TransformThreshold registry value.</span></span> <span data-ttu-id="ddab1-158">一个可能与此问题的解决方法是，将转换在接收端口级别，以便该业务流程不会接受多个转换形状的单个输入。</span><span class="sxs-lookup"><span data-stu-id="ddab1-158">One possible workaround to this issue would be to apply transforms at the receive port level so that the orchestration never accepts more than a single input to transform shapes.</span></span>  
  
3. <span data-ttu-id="ddab1-159">调整**大消息片段大小**属性上公开**BizTalk 组属性**配置页：</span><span class="sxs-lookup"><span data-stu-id="ddab1-159">Adjust the **Large message fragment size** property exposed on the **BizTalk Group Properties** configuration page:</span></span>  
  
    <span data-ttu-id="ddab1-160">如果收到的消息的内存中大小超过指定的字节数**大消息片段大小**则消息将拆分为指定大小的片段并片段写入 MessageBox 下按如下所示在 Microsoft 分布式事务处理协调器 (MSDTC) 事务的上下文：</span><span class="sxs-lookup"><span data-stu-id="ddab1-160">If the in-memory size of a received message exceeds the number of bytes specified for **Large message fragment size** then the message is split into fragments of the specified size and the fragments are written into the MessageBox under the context of a Microsoft Distributed Transaction Coordinator (MSDTC) transaction as follows:</span></span>  
  
   1.  <span data-ttu-id="ddab1-161">如果现有的 MSDTC 事务的上下文正在发布传入消息，然后使用此事务的消息片段写入 MessageBox 时。</span><span class="sxs-lookup"><span data-stu-id="ddab1-161">If the incoming message is being published under the context of an existing MSDTC transaction, then this transaction is used when writing the message fragments to the MessageBox.</span></span> <span data-ttu-id="ddab1-162">例如，如果配置为需要事务，则写入消息时，将使用现有事务的事务性适配器正在发布传入消息片段到 MessageBox。</span><span class="sxs-lookup"><span data-stu-id="ddab1-162">For example if the incoming message is being published by a transactional adapter configured to require transactions then the existing transaction would be used when writing the message fragments to the MessageBox.</span></span>  
  
   2.  <span data-ttu-id="ddab1-163">如果现有的 MSDTC 事务的上下文不正在发布传入消息，然后被创建新的 MSDTC 事务以写入消息片段。</span><span class="sxs-lookup"><span data-stu-id="ddab1-163">If the incoming message is not being published under the context of an existing MSDTC transaction, then a new MSDTC transaction is created to write the message fragments.</span></span>  
  
   -   <span data-ttu-id="ddab1-164">值增加**大消息片段大小**来降低的频率与大消息被分割为碎片，并减少创建关联的 MSDTC 事务的发生率。</span><span class="sxs-lookup"><span data-stu-id="ddab1-164">Increase the value for **Large message fragment size** to reduce the frequency with which large messages are fragmented and reduce the incidence of creating the associated MSDTC transactions.</span></span> <span data-ttu-id="ddab1-165">这样应做因为过多使用 MSDTC 事务将极大地影响系统性能。</span><span class="sxs-lookup"><span data-stu-id="ddab1-165">This should be done because excessive use of MSDTC transactions is expensive from a performance standpoint.</span></span> <span data-ttu-id="ddab1-166">请注意，增加此值还可以增加使用的可用内存量。</span><span class="sxs-lookup"><span data-stu-id="ddab1-166">Note that increasing this value may also increase the amount of available memory that is used.</span></span>  
  
   -   <span data-ttu-id="ddab1-167">如果花费的时间超过 60 分钟才能将消息写入到 MessageBox，则事务超时时，会发生错误，并使写入消息的尝试失败的最大允许 MSDTC 事务超时，并将回滚。</span><span class="sxs-lookup"><span data-stu-id="ddab1-167">If it takes longer than the maximum allowable MSDTC transaction timeout of 60 minutes to write a message to the MessageBox, then the transaction times out, an error results, and the attempt to write the message fails and is rolled back.</span></span> <span data-ttu-id="ddab1-168">**大消息片段大小**值应足够大才能在处理非常大的消息时避免出现此问题。</span><span class="sxs-lookup"><span data-stu-id="ddab1-168">The **Large message fragment size** value should be increased enough to avoid this problem when processing very large messages.</span></span> <span data-ttu-id="ddab1-169">具体取决于可用内存，此值应提高到 1000000 字节的最大值。</span><span class="sxs-lookup"><span data-stu-id="ddab1-169">Depending on available memory, this value should be increased up to a maximum value of 1000000 bytes.</span></span>  
  
   -   <span data-ttu-id="ddab1-170">在消息中的每个消息片段将创建一个或多个 SQL Server 数据库锁定对 MessageBox 数据库。</span><span class="sxs-lookup"><span data-stu-id="ddab1-170">Each message fragment in a message creates one or more SQL Server database locks against the MessageBox database.</span></span> <span data-ttu-id="ddab1-171">当锁的数目超过数十万时，很可能 SQL Server 将启动生成"内存不足"错误。</span><span class="sxs-lookup"><span data-stu-id="ddab1-171">When the number of locks exceeds several hundred thousand, it is possible that SQL Server will start generating “out of lock” errors.</span></span> <span data-ttu-id="ddab1-172">如果出现此问题，请增加**大消息片段大小**以减少针对 MessageBox 数据库所做的 SQL Server 数据库锁的数目。</span><span class="sxs-lookup"><span data-stu-id="ddab1-172">If this problem occurs, increase the **Large message fragment size** to reduce the number of SQL Server database locks made against the MessageBox database.</span></span>  
  
4. <span data-ttu-id="ddab1-173">请考虑保存 MessageBox 数据库上的 SQL Server 的 64 位版本，如果遇到"内存不足"错误。</span><span class="sxs-lookup"><span data-stu-id="ddab1-173">Consider housing your MessageBox database on a 64-bit version of SQL Server if you are experiencing "out of lock" errors.</span></span> <span data-ttu-id="ddab1-174">可用锁的数目是 64 位版本的 SQL Server 上高得多。</span><span class="sxs-lookup"><span data-stu-id="ddab1-174">The number of available locks is significantly higher on the 64-bit version of SQL Server.</span></span>  
  
5. <span data-ttu-id="ddab1-175">调整**大消息阈值**属性上公开**BizTalk 组属性**配置页：</span><span class="sxs-lookup"><span data-stu-id="ddab1-175">Adjust the **Large message threshold** property exposed on the **BizTalk Group Properties** configuration page:</span></span>  
  
    <span data-ttu-id="ddab1-176">为消息批次处理时，如果消息批的内存中大小达到指定的字节数**大消息阈值**则将消息批的已处理部分写入 MessageBox 之前处理消息批的其余部分。</span><span class="sxs-lookup"><span data-stu-id="ddab1-176">As a message batch is processed, if the in-memory size of a message batch reaches the number of bytes specified for **Large message threshold** then the portion of the message batch that has been processed is written to the MessageBox before the remainder of the message batch is processed.</span></span> <span data-ttu-id="ddab1-177">这是在 MSDTC 事务上下文，如下所示：</span><span class="sxs-lookup"><span data-stu-id="ddab1-177">This is done under the context of an MSDTC transaction as follows:</span></span>  
  
   1. <span data-ttu-id="ddab1-178">如果现有的 MSDTC 事务的上下文在发布消息批，则消息批的处理的部分写入 MessageBox 时也使用此事务。</span><span class="sxs-lookup"><span data-stu-id="ddab1-178">If the message batch is being published under the context of an existing MSDTC transaction, then this transaction is used when writing the processed portion of the message batch to the MessageBox.</span></span> <span data-ttu-id="ddab1-179">例如，如果配置为需要事务，然后在现有事务的事务性适配器正在发布传入消息批次将消息批的处理的部分写入 MessageBox 时使用。</span><span class="sxs-lookup"><span data-stu-id="ddab1-179">For example if the incoming message batch is being published by a transactional adapter configured to require transactions then the existing transaction would be used when writing the processed portion of the message batch to the MessageBox.</span></span>  
  
   2. <span data-ttu-id="ddab1-180">如果现有的 MSDTC 事务的上下文不在发布消息批，然后必须创建一个新的 MSDTC 事务将消息批的部分写入 MessageBox。</span><span class="sxs-lookup"><span data-stu-id="ddab1-180">If the message batch is not being published under the context of an existing MSDTC transaction, then a new MSDTC transaction must be created to write the portions of the message batch to the MessageBox.</span></span> <span data-ttu-id="ddab1-181">使用 MSDTC 事务以确保给定的消息批的部分的所有成功写入到 MessageBox 数据库。</span><span class="sxs-lookup"><span data-stu-id="ddab1-181">The MSDTC transaction is used to ensure that all of the portions of a given message batch are successfully written to the MessageBox database.</span></span>  
  
      <span data-ttu-id="ddab1-182">**大消息阈值**设置为直接应用于消息批，但由于消息批可设置为值 1，因此**大消息阈值**设置还可间接应用于单个消息。</span><span class="sxs-lookup"><span data-stu-id="ddab1-182">The **Large message threshold** setting is directly applicable to message batches but since a message batch can be set to a value of one, the **Large message threshold** setting can also be indirectly applicable to individual messages.</span></span> <span data-ttu-id="ddab1-183">例如当一个消息的消息批超过指定时**大消息阈值**参数则**大消息阈值**实际上仅适用于批处理中的单个消息。</span><span class="sxs-lookup"><span data-stu-id="ddab1-183">For example when a message batch of one message exceeds the specified **Large message threshold** parameter then the **Large message threshold** in effect applies only to the single message in the batch.</span></span>  
  
   -   <span data-ttu-id="ddab1-184">**大消息阈值**应调整参数以缓解用于分批放到 MessageBox 的消息批的 MSDTC 事务的创建。</span><span class="sxs-lookup"><span data-stu-id="ddab1-184">The **Large message threshold** parameter should be adjusted to mitigate the creation of MSDTC transactions used to apportion message batches to the MessageBox.</span></span> <span data-ttu-id="ddab1-185">这样应做因为过多使用 MSDTC 事务将极大地影响系统性能。</span><span class="sxs-lookup"><span data-stu-id="ddab1-185">This should be done because the excessive use of MSDTC transactions is expensive from a performance standpoint.</span></span> <span data-ttu-id="ddab1-186">使用以下计算来确定哪些的最小值**大消息阈值**设置应以避免创建不必要的 MSDTC 事务：</span><span class="sxs-lookup"><span data-stu-id="ddab1-186">Use the following calculation to determine what the minimum value for the **Large message threshold** setting should be to avoid unnecessarily creating MSDTC transactions:</span></span>  
  
       ```  
       Batch Size * Average size (in bytes) of each message in the batch after being processed by the receive pipeline < Large message threshold  
       ```  
  
        <span data-ttu-id="ddab1-187">当以字节为单位的消息批的总大小不超过指定的值**大消息阈值**则无需为 BizTalk 启动 MSDTC 事务将消息分批放到 MessageBox数据库。</span><span class="sxs-lookup"><span data-stu-id="ddab1-187">As long as the total size in bytes of a message batch does not exceed the specified value for **Large message threshold** then there is no need for BizTalk to initiate an MSDTC transaction to apportion the message batch to the MessageBox database.</span></span>