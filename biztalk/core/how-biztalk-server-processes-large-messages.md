---
title: BizTalk Server 如何处理大消息 |Microsoft 文档
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 62c070be-dff5-4349-9e36-dd3a7caf1752
caps.latest.revision: 33
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 26ecae241e1e41fdb67204c7975741a240979c2d
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/20/2017
ms.locfileid: "22249629"
---
# <a name="how-biztalk-server-processes-large-messages"></a><span data-ttu-id="de2b2-102">BizTalk Server 如何处理大消息</span><span class="sxs-lookup"><span data-stu-id="de2b2-102">How BizTalk Server Processes Large Messages</span></span>
## <a name="what-is-a-large-message"></a><span data-ttu-id="de2b2-103">什么是大消息？</span><span class="sxs-lookup"><span data-stu-id="de2b2-103">What is a large message?</span></span>  
 <span data-ttu-id="de2b2-104">遗憾的是，此问题的答案不而直接与特定的消息大小，绑定，取决于你的 Microsoft 的特定瓶颈[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]系统。</span><span class="sxs-lookup"><span data-stu-id="de2b2-104">Unfortunately, the answer to this question isn't tied directly to a specific message size, but rather, depends on specific bottlenecks in your Microsoft [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] system.</span></span> <span data-ttu-id="de2b2-105">与大消息关联的问题可分为以下几类：</span><span class="sxs-lookup"><span data-stu-id="de2b2-105">The problems associated with large messages can be divided into the following categories:</span></span>  
  
-   <span data-ttu-id="de2b2-106">**内存不足错误**某些类型的消息处理的映射、 验证和属性提升-如加载到内存中的整个消息。</span><span class="sxs-lookup"><span data-stu-id="de2b2-106">**Out of memory errors** Certain types of message processing - such as mapping, validation, and property promotion - load the entire message into memory.</span></span> <span data-ttu-id="de2b2-107">如果内存中的消息大小超出了可用资源，则会发生内存不足错误。</span><span class="sxs-lookup"><span data-stu-id="de2b2-107">If the size of the message in memory exceeds available resources, then an out of memory error occurs.</span></span> <span data-ttu-id="de2b2-108">与未加载到内存中的消息的大小阈值相比，属于此类别的消息的大小阈值要小得多。</span><span class="sxs-lookup"><span data-stu-id="de2b2-108">The size threshold for messages that fall into this category is much lower than the size threshold for messages that are not loaded into memory.</span></span> <span data-ttu-id="de2b2-109">例如，已解析为 XML 并已进行映射的 10 MB 平面文件可能按 10 或更大的因子增大，从而占用多于 100 MB 的内存，然而未进行解析或映射的 100 MB 的 XML 文档实际只需占用 1 MB 的内存，因为它是保存到 MessageBox 数据库中的。</span><span class="sxs-lookup"><span data-stu-id="de2b2-109">For example, a 10 MB flat file that is parsed into XML and then mapped may grow by a factor of 10 or more to consume over 100 MB of memory, whereas a 100 MB XML document that is not parsed or mapped may actually only consume 1 MB of memory as it is streamed to the MessageBox database.</span></span>  
  
-   <span data-ttu-id="de2b2-110">**不加载到内存的消息的性能问题**不一定要加载到内存的消息进行流式处理到 MessageBox 数据库使用的.NET XmlReader 接口。</span><span class="sxs-lookup"><span data-stu-id="de2b2-110">**Performance problems for messages that are not loaded into memory** Messages that are not required to be loaded into memory are streamed to the MessageBox database using the .NET XmlReader interface.</span></span> <span data-ttu-id="de2b2-111">尽管保存到 MessageBox 数据库的消息不会受限于必须加载到内存中的消息所受到的大小限制，但仍然存在某些重要的因素将影响 BizTalk Server 处理此类消息方式。</span><span class="sxs-lookup"><span data-stu-id="de2b2-111">While they are not subject to the size limitations on messages that must be loaded into memory, there are some important factors that impact how BizTalk Server processes messages that are streamed to the MessageBox database.</span></span>  
  
## <a name="factors-that-affect-the-processing-of-large-messages"></a><span data-ttu-id="de2b2-112">影响处理大消息的因素</span><span class="sxs-lookup"><span data-stu-id="de2b2-112">Factors that affect the processing of large messages</span></span>  
 <span data-ttu-id="de2b2-113">原始消息大小、消息格式以及消息的处理类型都会影响 BizTalk Server 处理大消息的方式。</span><span class="sxs-lookup"><span data-stu-id="de2b2-113">The original message size, message format, and type of message processing all affect how BizTalk Server processes large messages.</span></span>  
  
-   <span data-ttu-id="de2b2-114">**原始消息大小**BizTalk Server 接收的消息的大小是多大消息将 BizTalk Server 处理时的最明显指示。</span><span class="sxs-lookup"><span data-stu-id="de2b2-114">**Original message size** The size of the message received by BizTalk Server is the most visible indication of how large the message will be when it is processed by BizTalk Server.</span></span> <span data-ttu-id="de2b2-115">在整个消息加载到内存的情况下，消息的原始大小对性能的影响比在消息保存到 MessageBox 数据库的情况下对性能的影响要大得多。</span><span class="sxs-lookup"><span data-stu-id="de2b2-115">The original size of a message has a much greater impact on performance if the entire message is loaded into memory than if the message is streamed to the MessageBox database.</span></span>  
  
-   <span data-ttu-id="de2b2-116">**消息格式**到 BizTalk Server 中两个主要格式之一接收消息： XML 文件或平面文件。</span><span class="sxs-lookup"><span data-stu-id="de2b2-116">**Message format** Messages are received into BizTalk Server in one of two primary formats: XML files or flat files.</span></span>  
  
    -   <span data-ttu-id="de2b2-117">**XML 文件**顺序 BizTalk Server 来执行任何处理以外传递路由的消息，消息必须为 XML 文件格式。</span><span class="sxs-lookup"><span data-stu-id="de2b2-117">**XML files** In order for BizTalk Server to perform any processing on a message other than pass through routing, the message must be in the XML file format.</span></span> <span data-ttu-id="de2b2-118">如果要处理的文件是以 XML 格式接收的，则这些文件将在很大程度上保留其原始大小。</span><span class="sxs-lookup"><span data-stu-id="de2b2-118">If the files to be processed are received in XML format then they will retain their original size for the most part.</span></span>  
  
    -   <span data-ttu-id="de2b2-119">**平面文件**BizTalk Server 可以执行路由传递以外的任何处理之前，必须将平面文件解析为 XML 格式。</span><span class="sxs-lookup"><span data-stu-id="de2b2-119">**Flat files** Flat files must be parsed into an XML format before BizTalk Server can perform any processing other than pass through routing.</span></span> <span data-ttu-id="de2b2-120">将平面文件解析为 XML 文件将极大地增加文件大小。</span><span class="sxs-lookup"><span data-stu-id="de2b2-120">Parsing a flat file into an XML file can greatly increase the size of the file.</span></span> <span data-ttu-id="de2b2-121">因为平面文件不包含带有关于其数据的描述性信息的 XML 标记。</span><span class="sxs-lookup"><span data-stu-id="de2b2-121">Flat files do not contain XML tags with descriptive information about their data.</span></span> <span data-ttu-id="de2b2-122">另一方面，XML 文件还在描述性 XML 标记中包装了其所有数据。</span><span class="sxs-lookup"><span data-stu-id="de2b2-122">XML files, on the other hand, wrap all of their data in descriptive XML tags.</span></span> <span data-ttu-id="de2b2-123">在某些情况下，解析操作会按 10 或更大的因子增加平面文件的大小，具体取决于该文件的 XML 标记中包含的描述性数据的数量。</span><span class="sxs-lookup"><span data-stu-id="de2b2-123">In some scenarios parsing can increase the size of a flat file by a factor of 10 or more, depending on how much descriptive data is contained in the XML tags for the file.</span></span>  
  
    -   <span data-ttu-id="de2b2-124">**平面文件文档包装在 XML 文档中的单个 CDATA 部分节点**此类型的文档是 XML 和平面文件的组合，并且可能会产生问题，因为 BizTalk Server 必须将整个已包装的平面文件文档加载到之前的内存处理它。</span><span class="sxs-lookup"><span data-stu-id="de2b2-124">**Flat file documents wrapped in a single CDATA section node in an XML document** This type of document is a combination of both XML and flat file and can be problematic because BizTalk Server must load the entire wrapped flat file document into memory before processing it.</span></span>  
  
-   <span data-ttu-id="de2b2-125">**消息处理的类型**在 BizTalk Server 中，有两种类型的消息处理： 仅用于路由和映射。</span><span class="sxs-lookup"><span data-stu-id="de2b2-125">**Type of message processing** In BizTalk Server, there are two types of message processing: Routing only and Mapping.</span></span> <span data-ttu-id="de2b2-126">与要执行的消息处理类型相关联的性能变量包括消息大小以及消息是否加载到内存中。</span><span class="sxs-lookup"><span data-stu-id="de2b2-126">The performance variables tied to the type of message processing that is performed are message size and whether the message is loaded into memory.</span></span>  
  
    -   <span data-ttu-id="de2b2-127">**仅用于路由**如果 BizTalk Server 仅用于仅基于提升的消息属性的消息路由消息进行流式处理到 Messagebox 数据库使用的.NET XmlReader 接口，然后消息部分都不是单独加载到内存中。</span><span class="sxs-lookup"><span data-stu-id="de2b2-127">**Routing only** If BizTalk Server is only used only for routing messages based upon promoted message properties, then the message is streamed into the Messagebox database using the .NET XmlReader interface, and message parts are not individually loaded into memory.</span></span> <span data-ttu-id="de2b2-128">在此方案中，不会发生内存不足错误，而需要注意的主要问题是将超大的消息（大于 100 MB）写入 Messagebox 数据库所需的时间。</span><span class="sxs-lookup"><span data-stu-id="de2b2-128">In this scenario, out of memory errors are not an issue and the primary consideration is the amount of time that is required to write very large messages (over 100 MB) into the Messagebox database.</span></span> <span data-ttu-id="de2b2-129">BizTalk Server 开发小组已成功测试了在执行仅路由处理时可处理高达 1 GB 的消息。</span><span class="sxs-lookup"><span data-stu-id="de2b2-129">The BizTalk Server development team has successfully tested the processing of messages up to 1 GB in size when performing routing only.</span></span>  
  
         <span data-ttu-id="de2b2-130">确定在此方案中的性能的主要因素是**大型消息片段大小**用于片段到数据库的数据。</span><span class="sxs-lookup"><span data-stu-id="de2b2-130">The primary factor that determines performance in this scenario is the **Large message fragment size** used to fragment the data into the database.</span></span> <span data-ttu-id="de2b2-131">**大型消息片段大小**上是可配置选项**BizTalk 组属性**配置页并且 102400 字节 (100 KB) 的默认值。</span><span class="sxs-lookup"><span data-stu-id="de2b2-131">The **Large message fragment size** is a configurable option on the **BizTalk Group Properties** configuration page and has a default value of 102400 bytes (100 KB).</span></span> <span data-ttu-id="de2b2-132">增大此值会减少将消息保存到 MessageBox 数据库所需的往返次数。</span><span class="sxs-lookup"><span data-stu-id="de2b2-132">Increasing this value reduces the number of round trips required to stream a message into the MessageBox database.</span></span>  
  
    -   <span data-ttu-id="de2b2-133">**映射**转换具有地图的文档可以是内存密集型操作。</span><span class="sxs-lookup"><span data-stu-id="de2b2-133">**Mapping** Transforming a document with a map can be a memory-intensive operation.</span></span> <span data-ttu-id="de2b2-134">通过映射转换文档时，BizTalk Server 会将消息传递到 .Net XSLCompileTransform 类，以加载 XSL 样式表。</span><span class="sxs-lookup"><span data-stu-id="de2b2-134">When a document is transformed by a map, BizTalk Server passes the message to the .Net XSLCompileTransform class, which loads the XSL style sheet.</span></span> <span data-ttu-id="de2b2-135">在 Load 方法成功完成后，可从多个线程同时调用 Transform 方法。</span><span class="sxs-lookup"><span data-stu-id="de2b2-135">After the Load method completes successfully, the Transform method can be called simultaneously from multiple threads.</span></span> <span data-ttu-id="de2b2-136">[XslCompiledTransform 类](http://go.microsoft.com/fwlink/p/?LinkID=282683)XSLCompiledTransform 类提供了详细信息。</span><span class="sxs-lookup"><span data-stu-id="de2b2-136">[XslCompiledTransform Class](http://go.microsoft.com/fwlink/p/?LinkID=282683) provides more information on the XSLCompiledTransform class.</span></span>  
  
         [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]<span data-ttu-id="de2b2-137"> 通过在转换过程中对将文档加载到内存的操作应用可配置消息大小阈值，显著地提高了大文档的内存管理。</span><span class="sxs-lookup"><span data-stu-id="de2b2-137"> significantly improves memory management for large documents by implementing a configurable message size threshold for loading documents into memory during transforms.</span></span> <span data-ttu-id="de2b2-138">所有大小低于此阈值的消息都可在内存中进行处理；而任何大小高于此阈值的消息都将缓冲到文件系统中以减少对内存的需求。</span><span class="sxs-lookup"><span data-stu-id="de2b2-138">Any message with a size below this threshold is handled in memory; any message with a size above this threshold is buffered to the file system to reduce memory requirements.</span></span> <span data-ttu-id="de2b2-139">默认的消息大小阈值为 1 MB。</span><span class="sxs-lookup"><span data-stu-id="de2b2-139">The default message size threshold is 1 MB.</span></span>  
  
## <a name="guidelines-for-processing-large-messages"></a><span data-ttu-id="de2b2-140">处理大消息的准则</span><span class="sxs-lookup"><span data-stu-id="de2b2-140">Guidelines for processing large messages</span></span>  
 <span data-ttu-id="de2b2-141">遵循这些准则，在 BizTalk Server 中处理大消息时可提高性能：</span><span class="sxs-lookup"><span data-stu-id="de2b2-141">Follow these guidelines to improve performance when processing large messages in BizTalk Server:</span></span>  
  
1.  <span data-ttu-id="de2b2-142">调整消息大小阈值，在映射期间，高于此阈值的文档将缓冲到文件系统中。</span><span class="sxs-lookup"><span data-stu-id="de2b2-142">Adjust the message size threshold above which documents are buffered to the file system during mapping.</span></span> <span data-ttu-id="de2b2-143">若要修改大小阈值，创建一个名为的 DWORD 值**TransformThreshold**在 BizTalk Server 注册表中的以下位置：</span><span class="sxs-lookup"><span data-stu-id="de2b2-143">To modify the size threshold, create a DWORD value named **TransformThreshold** at the following location in the BizTalk Server registry:</span></span>  
  
    ```  
    HKLM\Software\Microsoft\BizTalk Server\3.0\Administration\TransformThreshold  
    ```  
  
     <span data-ttu-id="de2b2-144">创建此值后，请输入一个要设置为新阈值的字节数的十进制值。</span><span class="sxs-lookup"><span data-stu-id="de2b2-144">After you have created this value, enter a decimal value with the number of bytes to set the new threshold to.</span></span> <span data-ttu-id="de2b2-145">例如，输入十进制值 2097152 可将消息大小阈值从默认的 1 MB 增大至 2 MB。</span><span class="sxs-lookup"><span data-stu-id="de2b2-145">For example, enter a decimal value of 2097152 to increase the message size threshold to 2 MB (from the default of 1 MB).</span></span> <span data-ttu-id="de2b2-146">在具有大量可用内存的系统上增大此值可提高吞吐量。</span><span class="sxs-lookup"><span data-stu-id="de2b2-146">Increase this value on systems with a large amount of available memory to improve throughput.</span></span> <span data-ttu-id="de2b2-147">将文档缓存到磁盘可以节省内存，但是会对总体吞吐量造成影响。</span><span class="sxs-lookup"><span data-stu-id="de2b2-147">Buffering documents to disk conserves memory at a cost to overall throughput.</span></span>  
  
    > [!NOTE]
    >  <span data-ttu-id="de2b2-148">默认情况下，在映射期间缓冲到文件系统的文档写入到 *%temp%* BizTalk Server 计算机的目录。</span><span class="sxs-lookup"><span data-stu-id="de2b2-148">By default, documents that are buffered to the file system during mapping are written to the *%temp%* directory of the BizTalk Server computer.</span></span> <span data-ttu-id="de2b2-149">更改的设置 *%temp%* 到非系统磁盘，以在映射期间缓冲到文件系统的大消息时提高性能的环境变量。</span><span class="sxs-lookup"><span data-stu-id="de2b2-149">Change the setting for the *%temp%* environment variable to a non-system disk to improve performance when buffering large messages to the file system during mapping.</span></span>  
  
2.  <span data-ttu-id="de2b2-150">在业务流程中尽量减少使用映射：</span><span class="sxs-lookup"><span data-stu-id="de2b2-150">Minimize the use of maps in orchestrations:</span></span>  
  
    -   <span data-ttu-id="de2b2-151">如果你在业务流程中正使用映射来提取或设置用于业务逻辑的属性，请使用可分辨字段和升级属性进行替代。</span><span class="sxs-lookup"><span data-stu-id="de2b2-151">If you are using a map to extract or set properties used with business logic in an orchestration, use distinguished fields or promoted properties instead.</span></span> <span data-ttu-id="de2b2-152">在使用映射提取或设置值时，需要将文档加载到内存中。</span><span class="sxs-lookup"><span data-stu-id="de2b2-152">When extracting or setting values with a map the document is loaded into memory.</span></span> <span data-ttu-id="de2b2-153">但如果使用可分辨字段和升级属性，则业务流程引擎将访问消息上下文，而无需将文档加载到内存中。</span><span class="sxs-lookup"><span data-stu-id="de2b2-153">When using distinguished fields or promoted properties, the Orchestration engine accesses the message context and does not load the document into memory.</span></span>  
  
    -   <span data-ttu-id="de2b2-154">如果正在使用映射将多个字段聚合为一个字段，请将可分辨字段或升级属性与业务流程变量结合使用，以累计结果集。</span><span class="sxs-lookup"><span data-stu-id="de2b2-154">If you are using a map to aggregate several fields into one field, use distinguished fields or promoted properties with an orchestration variable to accumulate the result set.</span></span>  
  
    -   <span data-ttu-id="de2b2-155">请不要在业务流程中配置具有多个输入的转换形状。</span><span class="sxs-lookup"><span data-stu-id="de2b2-155">Do not configure an orchestration with multiple inputs to transform shapes.</span></span> <span data-ttu-id="de2b2-156">映射时，如果业务流程中包含的转换形状具有多个输入，则该业务流程将不会流入到文件系统中。</span><span class="sxs-lookup"><span data-stu-id="de2b2-156">An orchestration that contains multiple inputs to transform shapes will not stream to the file system while mapping.</span></span> <span data-ttu-id="de2b2-157">如果文档大小超过了指定的 TransformThreshold 注册表值，这种限制会导致将被映射的文档整个加载到内存中。</span><span class="sxs-lookup"><span data-stu-id="de2b2-157">This limitation will cause the entire document that is being mapped to load into memory if the document size exceeds the specified TransformThreshold registry value.</span></span> <span data-ttu-id="de2b2-158">此问题的一种可能的解决方法是在接收端口级别应用转换，这样业务流程就不会接受多个转换形状输入。</span><span class="sxs-lookup"><span data-stu-id="de2b2-158">One possible workaround to this issue would be to apply transforms at the receive port level so that the orchestration never accepts more than a single input to transform shapes.</span></span>  
  
3.  <span data-ttu-id="de2b2-159">调整**大型消息片段大小**属性上公开**BizTalk 组属性**配置页：</span><span class="sxs-lookup"><span data-stu-id="de2b2-159">Adjust the **Large message fragment size** property exposed on the **BizTalk Group Properties** configuration page:</span></span>  
  
     <span data-ttu-id="de2b2-160">如果收到的消息的内存中大小超过为指定的字节数**大型消息片段大小**消息拆分为指定大小的片段然后片段写入到 MessageBox 下Microsoft 分布式事务处理协调器 (MSDTC) 事务，如下所示的上下文：</span><span class="sxs-lookup"><span data-stu-id="de2b2-160">If the in-memory size of a received message exceeds the number of bytes specified for **Large message fragment size** then the message is split into fragments of the specified size and the fragments are written into the MessageBox under the context of a Microsoft Distributed Transaction Coordinator (MSDTC) transaction as follows:</span></span>  
  
    1.  <span data-ttu-id="de2b2-161">如果正在现有的 MSDTC 事务上下文中发布传入消息，则在消息片段写入 MessageBox 时使用此事务。</span><span class="sxs-lookup"><span data-stu-id="de2b2-161">If the incoming message is being published under the context of an existing MSDTC transaction, then this transaction is used when writing the message fragments to the MessageBox.</span></span> <span data-ttu-id="de2b2-162">例如，如果配置为需要事务的事务性适配器正在发布传入消息，则在消息片段写入 MessageBox 时使用现有事务。</span><span class="sxs-lookup"><span data-stu-id="de2b2-162">For example if the incoming message is being published by a transactional adapter configured to require transactions then the existing transaction would be used when writing the message fragments to the MessageBox.</span></span>  
  
    2.  <span data-ttu-id="de2b2-163">如果没有在现有的 MSDTC 事务上下文中发布传入消息，则将创建一个新的 MSDTC 事务以写入消息片段。</span><span class="sxs-lookup"><span data-stu-id="de2b2-163">If the incoming message is not being published under the context of an existing MSDTC transaction, then a new MSDTC transaction is created to write the message fragments.</span></span>  
  
    -   <span data-ttu-id="de2b2-164">值增加**大型消息片段大小**以减少大型消息已分段且减少创建关联的 MSDTC 事务的发生的频率。</span><span class="sxs-lookup"><span data-stu-id="de2b2-164">Increase the value for **Large message fragment size** to reduce the frequency with which large messages are fragmented and reduce the incidence of creating the associated MSDTC transactions.</span></span> <span data-ttu-id="de2b2-165">因此应该增大此值，因为过多使用 MSDTC 事务将极大地影响系统性能。</span><span class="sxs-lookup"><span data-stu-id="de2b2-165">This should be done because excessive use of MSDTC transactions is expensive from a performance standpoint.</span></span> <span data-ttu-id="de2b2-166">请注意，增大此值还可能增加要使用的可用内存量。</span><span class="sxs-lookup"><span data-stu-id="de2b2-166">Note that increasing this value may also increase the amount of available memory that is used.</span></span>  
  
    -   <span data-ttu-id="de2b2-167">如果将消息写入 MessageBox 所用时间大于最大允许的 MSDTC 事务超时时间（60 分钟），则该事务将超时并显示错误，尝试写入消息的操作失败，并进行回滚。</span><span class="sxs-lookup"><span data-stu-id="de2b2-167">If it takes longer than the maximum allowable MSDTC transaction timeout of 60 minutes to write a message to the MessageBox, then the transaction times out, an error results, and the attempt to write the message fails and is rolled back.</span></span> <span data-ttu-id="de2b2-168">**大型消息片段大小**值应增加足以处理非常大的消息时避免此问题。</span><span class="sxs-lookup"><span data-stu-id="de2b2-168">The **Large message fragment size** value should be increased enough to avoid this problem when processing very large messages.</span></span> <span data-ttu-id="de2b2-169">根据可用内存的大小，可将此值提高到 1000000 字节的最大值。</span><span class="sxs-lookup"><span data-stu-id="de2b2-169">Depending on available memory, this value should be increased up to a maximum value of 1000000 bytes.</span></span>  
  
    -   <span data-ttu-id="de2b2-170">消息中的每个消息片段都可针对 MessageBox 数据库创建一个或多个 SQL Server 数据库锁定。</span><span class="sxs-lookup"><span data-stu-id="de2b2-170">Each message fragment in a message creates one or more SQL Server database locks against the MessageBox database.</span></span> <span data-ttu-id="de2b2-171">如果锁定数目超过数十万，则 SQL Server 可能会发生“内存不足”错误。</span><span class="sxs-lookup"><span data-stu-id="de2b2-171">When the number of locks exceeds several hundred thousand, it is possible that SQL Server will start generating “out of lock” errors.</span></span> <span data-ttu-id="de2b2-172">如果出现此问题，增加**大型消息片段大小**以减少对 MessageBox 数据库的 SQL Server 数据库锁的数目。</span><span class="sxs-lookup"><span data-stu-id="de2b2-172">If this problem occurs, increase the **Large message fragment size** to reduce the number of SQL Server database locks made against the MessageBox database.</span></span>  
  
4.  <span data-ttu-id="de2b2-173">如果出现“内存不足”错误，请考虑在 64 位版本的 SQL Server 上保存 MessageBox 数据库。</span><span class="sxs-lookup"><span data-stu-id="de2b2-173">Consider housing your MessageBox database on a 64-bit version of SQL Server if you are experiencing "out of lock" errors.</span></span> <span data-ttu-id="de2b2-174">在 64 位版本的 SQL Server 上，可用锁定的数目将大大增加。</span><span class="sxs-lookup"><span data-stu-id="de2b2-174">The number of available locks is significantly higher on the 64-bit version of SQL Server.</span></span>  
  
5.  <span data-ttu-id="de2b2-175">调整**大型消息阈值**属性上公开**BizTalk 组属性**配置页：</span><span class="sxs-lookup"><span data-stu-id="de2b2-175">Adjust the **Large message threshold** property exposed on the **BizTalk Group Properties** configuration page:</span></span>  
  
     <span data-ttu-id="de2b2-176">作为消息处理批，如果消息批的内存中大小达到为指定的字节数**大型消息阈值**则已处理的消息批处理的部分写入到 MessageBox 之前处理消息批的其余部分。</span><span class="sxs-lookup"><span data-stu-id="de2b2-176">As a message batch is processed, if the in-memory size of a message batch reaches the number of bytes specified for **Large message threshold** then the portion of the message batch that has been processed is written to the MessageBox before the remainder of the message batch is processed.</span></span> <span data-ttu-id="de2b2-177">此操作是在 MSDTC 事务的上下文中完成的，如下所示：</span><span class="sxs-lookup"><span data-stu-id="de2b2-177">This is done under the context of an MSDTC transaction as follows:</span></span>  
  
    1.  <span data-ttu-id="de2b2-178">如果正在现有的 MSDTC 事务上下文中发布消息批，则在消息批的已处理部分写入 MessageBox 时使用此事务。</span><span class="sxs-lookup"><span data-stu-id="de2b2-178">If the message batch is being published under the context of an existing MSDTC transaction, then this transaction is used when writing the processed portion of the message batch to the MessageBox.</span></span> <span data-ttu-id="de2b2-179">例如，如果配置为需要事务的事务性适配器正在发布传入消息批，则在消息批的已处理部分写入 MessageBox 时使用现有事务。</span><span class="sxs-lookup"><span data-stu-id="de2b2-179">For example if the incoming message batch is being published by a transactional adapter configured to require transactions then the existing transaction would be used when writing the processed portion of the message batch to the MessageBox.</span></span>  
  
    2.  <span data-ttu-id="de2b2-180">如果没有在现有的 MSDTC 事务上下文中发布消息批，则必须创建一个新的 MSDTC 事务以将消息批的各部分写入 MessageBox。</span><span class="sxs-lookup"><span data-stu-id="de2b2-180">If the message batch is not being published under the context of an existing MSDTC transaction, then a new MSDTC transaction must be created to write the portions of the message batch to the MessageBox.</span></span> <span data-ttu-id="de2b2-181">使用 MSDTC 事务可确保给定消息批的所有部分均可成功写入 MessageBox 数据库。</span><span class="sxs-lookup"><span data-stu-id="de2b2-181">The MSDTC transaction is used to ensure that all of the portions of a given message batch are successfully written to the MessageBox database.</span></span>  
  
     <span data-ttu-id="de2b2-182">**大型消息阈值**设置就会直接应用到消息批次，但由于消息批可以设置为值为 1，**大型消息阈值**设置也可以是间接适用于单个消息。</span><span class="sxs-lookup"><span data-stu-id="de2b2-182">The **Large message threshold** setting is directly applicable to message batches but since a message batch can be set to a value of one, the **Large message threshold** setting can also be indirectly applicable to individual messages.</span></span> <span data-ttu-id="de2b2-183">仅在一条消息的消息批超过指定当例如**大型消息阈值**参数则**大型消息阈值**实际上仅适用于批处理中的单个消息。</span><span class="sxs-lookup"><span data-stu-id="de2b2-183">For example when a message batch of one message exceeds the specified **Large message threshold** parameter then the **Large message threshold** in effect applies only to the single message in the batch.</span></span>  
  
    -   <span data-ttu-id="de2b2-184">**大型消息阈值**应调整参数以缓解用于分配到 MessageBox 的消息批次的 MSDTC 事务的创建。</span><span class="sxs-lookup"><span data-stu-id="de2b2-184">The **Large message threshold** parameter should be adjusted to mitigate the creation of MSDTC transactions used to apportion message batches to the MessageBox.</span></span> <span data-ttu-id="de2b2-185">应该增大此值，因为过多使用 MSDTC 事务将极大地影响系统性能。</span><span class="sxs-lookup"><span data-stu-id="de2b2-185">This should be done because the excessive use of MSDTC transactions is expensive from a performance standpoint.</span></span> <span data-ttu-id="de2b2-186">使用以下计算来确定哪些的最小值**大型消息阈值**设置应是避免不必要地创建 MSDTC 事务：</span><span class="sxs-lookup"><span data-stu-id="de2b2-186">Use the following calculation to determine what the minimum value for the **Large message threshold** setting should be to avoid unnecessarily creating MSDTC transactions:</span></span>  
  
        ```  
        Batch Size * Average size (in bytes) of each message in the batch after being processed by the receive pipeline < Large message threshold  
        ```  
  
         <span data-ttu-id="de2b2-187">只要以字节为单位的消息批的总大小不超过指定的值**大型消息阈值**BizTalk 启动 MSDTC 事务无需分配到 MessageBox 消息批则数据库。</span><span class="sxs-lookup"><span data-stu-id="de2b2-187">As long as the total size in bytes of a message batch does not exceed the specified value for **Large message threshold** then there is no need for BizTalk to initiate an MSDTC transaction to apportion the message batch to the MessageBox database.</span></span>