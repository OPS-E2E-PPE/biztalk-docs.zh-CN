---
title: 持久化和业务流程引擎 |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
helpviewer_keywords:
- orchestration engine, persistence
- persistence
- orchestration engine, serialization
ms.assetid: 088230ef-13b3-440b-9875-6449f29dd5c6
caps.latest.revision: 11
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 3d61d6665ba0828fb6cf24ef71ffb04fbcb94d5e
ms.sourcegitcommit: 266308ec5c6a9d8d80ff298ee6051b4843c5d626
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 06/27/2018
ms.locfileid: "37022515"
---
# <a name="persistence-and-the-orchestration-engine"></a>持久化和业务流程引擎
状态持久性、 其管理和还原构成大量的业务流程引擎的基本功能的基础。 具体而言，持久性至关重要的正确运行：  
  
- 冻结和解除冻结  
  
- 计算机不可知执行和解除冻结  
  
- 补偿模型  
  
- 受控的系统关闭  
  
- 恢复  
  
  业务流程引擎将保存到持久性存储区的不同位置，正在运行的业务流程实例的整个状态，以便在内存中，该实例可以更高版本完全还原。 状态包括：  
  
- 引擎，包括其当前进度的内部状态。  
  
- 维护状态信息和正在使用的业务流程的任何.NET 组件的状态。  
  
- 消息和变量的值。  
  
## <a name="persistence-points"></a>持久性点  
 业务流程引擎保存在不同点正在运行的业务流程实例的状态。 如果需要解除冻结的业务流程实例、 从受控的关闭、 启动或从意外关机恢复，它将从最后一个持久点时，运行业务流程实例，像其他任何内容发生。 例如，如果收到一条消息，但没有意外的关机可以保存状态之前，该引擎不会记录它已经收到消息，并将其再次出现在重新启动。 在以下情况下，引擎将保存业务流程的状态：  
  
-   结束事务作用域。  
  
    -   引擎保存事务作用域结束时的状态，以便明确，定义业务流程应继续执行的点，并补偿可执行正确如有必要。  
  
    -   业务流程将继续暂留成功; 如果运行从范围的结束否则，将调用相应的异常处理程序。  
  
    -   如果该范围位于事务和原子，引擎将保存在原子作用域结束时的状态时提交。  
  
    -   如果作用域是事务性的且长时间运行，则引擎将生成一个新事务并保持运行时的完成状态时完成的作用域。  
  
-   达到调试断点。  
  
-   发送的消息。 唯一的例外是原子事务作用域内从发送消息。  
  
-   业务流程将启动另一个业务流程以异步方式如同**启动业务流程**形状。  
  
-   业务流程实例已挂起。  
  
-   当业务流程引擎要求关闭的情况下时，它将尝试保存控件的信息，以及所有正在运行的业务流程实例的当前状态，以便它可以继续重新启动时运行它们。 如果引擎中保存当前状态不成功，引擎将继续从最后一个持久点在关闭之前发生的业务流程实例。 这适用于在受控的条件，以及异常终止系统关闭。  
  
-   在引擎确定应已冻结实例。  
  
-   业务流程实例已完成。  
  
## <a name="serialization"></a>序列化  
 您的业务流程直接或间接引用的所有对象实例 （如通过其他对象） 必须是可序列化的业务流程状态持久保存。 有以下两种例外情况：  
  
-   您可以在原子事务内声明的不可序列化对象。 可以这样做是因为原子作用域不包含持久化点。  
  
-   不是可序列化的类; System.Xml.XmlDocument。它作为一种特殊情况进行处理，并可以在任意位置。  
  
> [!CAUTION]
>  为了使要保留的.NET 对象，它必须标记为可序列化。  
  
> [!NOTE]
>  不能使用标准.NET 序列化过程持续 COM 对象。 如果你想要调用原子事务外的 COM 对象，必须是可序列化的.NET 并知道如何保持和还原的 COM 对象的状态的.NET 对象中包装的 COM 对象。  
  
## <a name="system-shutdown"></a>系统关闭  
 当业务流程引擎要求关闭的情况下时，它将尝试保存控件的信息，以及所有正在运行的业务流程实例的当前状态，以便它可以继续重新启动时运行它们。 如果引擎中保存当前状态不成功，引擎将继续从最后一个持久点在关闭之前发生的业务流程实例。 这适用于在受控的条件，以及异常终止系统关闭。  
  
## <a name="recovery"></a>恢复  
 引擎定期保存到持久存储状态信息的业务流程实例，并且它还将保存发生系统关闭时的状态。  
  
 当业务流程实例由于任何原因失败异常时，可以从上次保持的状态恢复该实例，它可以继续运行就好像不会中断。 即使超出服务由于某种原因; 原始服务器实例上运行的是，则返回 true实例可以只需恢复单独的计算机上运行。 由于此多服务器恢复模型，您不再需要群集。  
  
## <a name="see-also"></a>请参阅  
 [业务流程冻结和解除冻结](../core/orchestration-dehydration-and-rehydration.md)