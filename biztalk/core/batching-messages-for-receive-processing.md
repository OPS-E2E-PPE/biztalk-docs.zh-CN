---
title: "批处理消息接收处理 |Microsoft 文档"
ms.custom: 
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: 32bf0b70-e9d1-4fab-9c74-160e51390700
caps.latest.revision: "8"
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: ef14179c1af460afc516b7fa331ee30a758219c3
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/20/2017
---
# <a name="batching-messages-for-receive-processing"></a><span data-ttu-id="78b30-102">批处理消息接收处理</span><span class="sxs-lookup"><span data-stu-id="78b30-102">Batching Messages for Receive Processing</span></span>
## <a name="batch-callbacks"></a><span data-ttu-id="78b30-103">批处理回调</span><span class="sxs-lookup"><span data-stu-id="78b30-103">Batch Callbacks</span></span>  
 <span data-ttu-id="78b30-104">提交的批次接收到消息引擎适配器以异步方式处理。</span><span class="sxs-lookup"><span data-stu-id="78b30-104">Batches submitted by receive adapters to the Messaging Engine are processed asynchronously.</span></span> <span data-ttu-id="78b30-105">因此该适配器需要一种机制，以便它可以成功或失败的通知并执行任何必要的清除操作将为适配器中某些状态回调。</span><span class="sxs-lookup"><span data-stu-id="78b30-105">Therefore the adapter needs a mechanism to tie a callback to some state in the adapter so it can be notified of success or failure and perform any necessary cleanup actions.</span></span> <span data-ttu-id="78b30-106">回调语义可以灵活，这样适配器可以使用一种或三种方法的组合。</span><span class="sxs-lookup"><span data-stu-id="78b30-106">The callback semantics are flexible such that adapters can use one or a combination of three approaches.</span></span> <span data-ttu-id="78b30-107">这些是：</span><span class="sxs-lookup"><span data-stu-id="78b30-107">These are:</span></span>  
  
-   <span data-ttu-id="78b30-108">实现对同一对象实例进行所有回调**IBTBatchCallBack**。</span><span class="sxs-lookup"><span data-stu-id="78b30-108">All callbacks are made on the same object instance that implements **IBTBatchCallBack**.</span></span>  
  
-   <span data-ttu-id="78b30-109">当请求一个新的批处理用于关联到适配器中的状态回调时，cookie 将传递到引擎。</span><span class="sxs-lookup"><span data-stu-id="78b30-109">The cookie passed into the engine when requesting a new batch is used to correlate the callback to the state in the adapters.</span></span>  
  
-   <span data-ttu-id="78b30-110">没有实现每个批的不同的回调对象**IBTBatchCallBack**。</span><span class="sxs-lookup"><span data-stu-id="78b30-110">There is a different callback object for each batch that implements **IBTBatchCallBack**.</span></span> <span data-ttu-id="78b30-111">此处每个对象保存其自己的私有状态。</span><span class="sxs-lookup"><span data-stu-id="78b30-111">Here each object holds its own private state.</span></span>  
  
 <span data-ttu-id="78b30-112">适配器处理批处理时在其实现的回叫**IBTBatchCallBack.BatchComplete**。</span><span class="sxs-lookup"><span data-stu-id="78b30-112">When the batch has been processed, the adapter is called back on its implementation of **IBTBatchCallBack.BatchComplete**.</span></span> <span data-ttu-id="78b30-113">由第一个参数，HRESULT 状态指示批处理的总体状态。</span><span class="sxs-lookup"><span data-stu-id="78b30-113">The overall status of the batch is indicated by the first parameter, the HRESULT status.</span></span> <span data-ttu-id="78b30-114">如果此值为大于或等于零，则批处理已成功在引擎具有数据的所有权，并且适配器可以随时从网络中删除该数据的意义上。</span><span class="sxs-lookup"><span data-stu-id="78b30-114">If this value is greater than or equal to zero, then the batch was successful in the sense that the engine has ownership of the data and the adapter is free to delete that data from the wire.</span></span> <span data-ttu-id="78b30-115">负状态指示批处理失败： 无批处理中的操作已成功和适配器负责处理失败。</span><span class="sxs-lookup"><span data-stu-id="78b30-115">A negative status indicates that the batch failed: None of the operations in the batch were successful and the adapter is responsible for handling the failure.</span></span>  
  
 <span data-ttu-id="78b30-116">如果批处理失败，该适配器将需要了解哪一项操作失败，在其中。</span><span class="sxs-lookup"><span data-stu-id="78b30-116">If the batch failed, then the adapter needs to know which item in which operation failed.</span></span> <span data-ttu-id="78b30-117">例如，假设该适配器已从磁盘并将它们到提交读取 20 个文件[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]使用单个批处理。</span><span class="sxs-lookup"><span data-stu-id="78b30-117">For example, suppose that the adapter was reading 20 files from disk and submitting them into [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] using a single batch.</span></span> <span data-ttu-id="78b30-118">如果第 10 个文件已损坏，则适配器将需要挂起该一个文件并重新提交剩余 19。</span><span class="sxs-lookup"><span data-stu-id="78b30-118">If the tenth file was corrupted, the adapter would need to suspend that one file and resubmit the remaining 19.</span></span> <span data-ttu-id="78b30-119">此信息可供第二个和第三个参数中的适配器-`opCount` （操作计数） 的短类型和`operationStatus`，它属于类型 BTBatchOperationStatus []。</span><span class="sxs-lookup"><span data-stu-id="78b30-119">This information is available to the adapter in the second and third parameters—`opCount` (operation count) of type short and `operationStatus`, which is of type BTBatchOperationStatus[].</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="78b30-120">单个批处理对象上你应永远不会提交一条消息一次以上。</span><span class="sxs-lookup"><span data-stu-id="78b30-120">On a single batch object you should never submit a message more than once.</span></span> <span data-ttu-id="78b30-121">在同一个批处理多次提交同一消息对象所做的工作会引擎错误。</span><span class="sxs-lookup"><span data-stu-id="78b30-121">Submitting the same message object more than once on the same batch will result in engine errors.</span></span>  
  
 <span data-ttu-id="78b30-122">操作计数表明如何许多类型的操作已在批处理中 (的大小**BTBatchOperationStatus**数组)。</span><span class="sxs-lookup"><span data-stu-id="78b30-122">The operation count indicates how many types of operations were in the batch (the size of the **BTBatchOperationStatus** array).</span></span> <span data-ttu-id="78b30-123">操作状态数组中的每个元素对应于给定的操作类型。</span><span class="sxs-lookup"><span data-stu-id="78b30-123">Each element in the operation status array corresponds to a given operation type.</span></span> <span data-ttu-id="78b30-124">通过使用**BTBatchOperationStatus**数组，该适配器可以确定哪一项中给定的操作失败，通过查看**BTBatchOperationStatus.MessageStatus**为负 HRESULT 数组表明失败的值。</span><span class="sxs-lookup"><span data-stu-id="78b30-124">By using the **BTBatchOperationStatus** array, the adapter can determine which item in a given operation failed by looking at the **BTBatchOperationStatus.MessageStatus** array for negative HRESULT values signifying failure.</span></span> <span data-ttu-id="78b30-125">在上述方案中，适配器会创建一个新的批处理包含 19 提交了消息，一条消息挂起。</span><span class="sxs-lookup"><span data-stu-id="78b30-125">In the scenario above, the adapter creates a new batch containing 19 message submits and one message suspend.</span></span>  
  
 <span data-ttu-id="78b30-126">下面的代码段演示如何适配器从引擎通过其传输代理请求一个新的批处理，并使用 cookie 方法引擎提交一条消息。</span><span class="sxs-lookup"><span data-stu-id="78b30-126">The following code fragment shows how an adapter requests a new batch from the engine through its transport proxy and submits a single message into the engine using the cookie approach.</span></span> <span data-ttu-id="78b30-127">Messaging Engine 调用**BatchComplete**作为批处理回调处理整个批处理的完成方法提交消息。</span><span class="sxs-lookup"><span data-stu-id="78b30-127">The Messaging Engine calls the **BatchComplete** method as the batch callback when it has completed processing the entire batch of submitted messages.</span></span>  
  
```  
using Microsoft.BizTalk.TransportProxy.Interop;  
using Microsoft.BizTalk.Message.Interop;  
  
public class MyAdapter :   
                  IBTTransport,   
                  IBTTransportConfig,   
                  IBTTransportControl,  
                  IPersistPropertyBag,   
                  IBaseComponent,  
                  IBTBatchCallBack  
{  
      private IBTTransportProxy _tp;  
  
      public void BatchComplete(      
            Int32                         status,   
            Int16                         opCount,   
            BTBatchOperationStatus[]      operationStatus,   
            System.Object                 callbackCookie)  
      {  
            // Use cookie to correlate callback with work done,  
            // in this example the batch is to submit a single  
            // file the name of which will be in the  
            // callbackCookie  
            string fileName = (string)callbackCookie;  
            if ( status >= 0 )  
                  // DeleteFile from disc  
                  File.Delete(fileName);          
            else  
                  // Rename file to fileName.bad  
                  File.Move(fileName, fileName + ".bad");  
      }  
  
      private void SubmitMessage(  
            IBaseMessage                  msg,   
            string                        fileName)  
      {  
            // Note: Pass in the filename as the cookie  
            IBTTransportBatch batch =   
                  _tp.GetBatch(this, (object)fileName);  
  
            // Add msg to batch for submitting   
            batch.SubmitMessage(msg);   
  
            // Process this batch  
            batch.Done(null);  
      }  
}  
```  
  
 <span data-ttu-id="78b30-128">[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] SDK 包括以下适配器的示例： 文件、 HTTP、 MSMQ 和事务的适配器。</span><span class="sxs-lookup"><span data-stu-id="78b30-128">The [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] SDK includes samples for the following adapters: File, HTTP, MSMQ, and the Transactional Adapter.</span></span> <span data-ttu-id="78b30-129">所有这些适配器的构建基于功能调用 BaseAdapter 常见构建基块。</span><span class="sxs-lookup"><span data-stu-id="78b30-129">All of these adapters are built on top of a common building block called the BaseAdapter.</span></span> <span data-ttu-id="78b30-130">版本 1.0.1 BaseAdapter 包括所有相关的代码，以分析操作状态并重新生成一个新的批次以提交。</span><span class="sxs-lookup"><span data-stu-id="78b30-130">Version 1.0.1 of the BaseAdapter includes all of the relevant code to parse the operation status and rebuild a new batch to submit.</span></span>  
  
## <a name="race-condition"></a><span data-ttu-id="78b30-131">争用条件</span><span class="sxs-lookup"><span data-stu-id="78b30-131">Race Condition</span></span>  
 <span data-ttu-id="78b30-132">解决错误，并决定提交批处理的最后结果的两个任务看起来很简单，但实际上它们依赖于从不同的线程的信息：</span><span class="sxs-lookup"><span data-stu-id="78b30-132">The two tasks of resolving errors and deciding the final outcome of a submitted batch seem simple enough, but in fact they rely on information from different threads:</span></span>  
  
-   <span data-ttu-id="78b30-133">适配器来处理基于信息由传递的错误[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]到适配器的**BatchComplete**回调方法。</span><span class="sxs-lookup"><span data-stu-id="78b30-133">The adapter processes errors based on information passed by [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] to the adapter's **BatchComplete** callback method.</span></span> <span data-ttu-id="78b30-134">在适配器的线程上执行此回调。</span><span class="sxs-lookup"><span data-stu-id="78b30-134">This callback executes on the adapter's thread.</span></span>  
  
-   <span data-ttu-id="78b30-135">**DTCCommitConfirm**上是一种方法**IBTDTCCommitConfirm**对象。</span><span class="sxs-lookup"><span data-stu-id="78b30-135">**DTCCommitConfirm** is a method on the **IBTDTCCommitConfirm** object.</span></span> <span data-ttu-id="78b30-136">实例**IBTDTCCommitConfirm**对象返回批处理**IBTTransportBatch::Done**调用。</span><span class="sxs-lookup"><span data-stu-id="78b30-136">An instance of the **IBTDTCCommitConfirm** object is returned by the batch **IBTTransportBatch::Done** call.</span></span> <span data-ttu-id="78b30-137">此实例位于相同的线程上**IBTTransportBatch::Done**调用，即不同于适配器的回调线程。</span><span class="sxs-lookup"><span data-stu-id="78b30-137">This instance is on the same thread as the **IBTTransportBatch::Done** call, which is different from the adapter's callback thread.</span></span>  
  
 <span data-ttu-id="78b30-138">适配器对每次调用**IBTTransportBatch::Done** the Messaging Engine 使相应地调用的回调方法**BatchComplete**在单独的线程来报告的结果批次提交。</span><span class="sxs-lookup"><span data-stu-id="78b30-138">For every call that the adapter makes to **IBTTransportBatch::Done** the Messaging Engine makes a corresponding call to the callback method **BatchComplete** in a separate thread to report the result of the batch submission.</span></span> <span data-ttu-id="78b30-139">在**BatchComplete**批处理适配器需要提交或回滚事务基于是否通过或失败。</span><span class="sxs-lookup"><span data-stu-id="78b30-139">In **BatchComplete** the adapter needs to commit or roll back the transaction based on whether the batch passed or failed.</span></span> <span data-ttu-id="78b30-140">在任一情况下，适配器然后应调用**DTCCommitConfirm**报告事务的状态。</span><span class="sxs-lookup"><span data-stu-id="78b30-140">In either case, the adapter should then call **DTCCommitConfirm** to report the status of the transaction.</span></span>  
  
 <span data-ttu-id="78b30-141">可能的争用情况存在因为适配器的实现**BatchComplete**可以假设**IBTDTCCommitConfirm**返回对象**IBTTransportBatch::Done**始终可用，是何时**BatchComplete**执行。</span><span class="sxs-lookup"><span data-stu-id="78b30-141">A possible race condition exists because the adapter’s implementation of **BatchComplete** can assume that the **IBTDTCCommitConfirm** object returned by **IBTTransportBatch::Done** is always available when **BatchComplete** executes.</span></span> <span data-ttu-id="78b30-142">但是， **BatchComplete**可以在单独的消息传送引擎线程，即使之前调用**IBTTransportBatch::Done**返回。</span><span class="sxs-lookup"><span data-stu-id="78b30-142">However, **BatchComplete** can be called in a separate Messaging Engine thread, even before **IBTTransportBatch::Done** returns.</span></span> <span data-ttu-id="78b30-143">可能的适配器尝试访问**IBTDTCCommitConfirm**对象作为的一部分**BatchComplete**实现中，存在是访问冲突，因为调用线程不再存在。</span><span class="sxs-lookup"><span data-stu-id="78b30-143">It is possible that when the adapter tries to access the **IBTDTCCommitConfirm** object as a part of the **BatchComplete** implementation, there is an access violation because that calling thread no longer exists.</span></span> <span data-ttu-id="78b30-144">使用以下解决方案来避免这种情况。</span><span class="sxs-lookup"><span data-stu-id="78b30-144">Use the following solution to avoid this condition.</span></span>  
  
 <span data-ttu-id="78b30-145">在下面的示例中，通过使用事件，可解决问题。</span><span class="sxs-lookup"><span data-stu-id="78b30-145">In the following example, the problem is solved by using an event.</span></span> <span data-ttu-id="78b30-146">在这里，通过使用事件的属性来访问接口指针。</span><span class="sxs-lookup"><span data-stu-id="78b30-146">Here the interface pointer is accessed through a property that uses the event.</span></span> <span data-ttu-id="78b30-147">Get 始终等待要在继续之前完成的集。</span><span class="sxs-lookup"><span data-stu-id="78b30-147">The get always waits for the set to complete before proceeding.</span></span>  
  
```  
protected IBTDTCCommitConfirm CommitConfirm  
{  
      set  
      {  
            this.commitConfirm = value;  
            this.commitConfirmEvent.Set();  
      }  
      get  
      {  
            this.commitConfirmEvent.WaitOne();  
            return this.commitConfirm;  
      }  
}  
protected IBTDTCCommitConfirm commitConfirm = null;  
private ManualResetEvent commitConfirmEvent = new ManualResetEvent(false);  
```  
  
## <a name="batch-status-codes"></a><span data-ttu-id="78b30-148">批处理状态代码</span><span class="sxs-lookup"><span data-stu-id="78b30-148">Batch Status Codes</span></span>  
 <span data-ttu-id="78b30-149">总体批处理状态代码指示批处理的结果。</span><span class="sxs-lookup"><span data-stu-id="78b30-149">The overall batch status code indicates the outcome of the batch.</span></span> <span data-ttu-id="78b30-150">操作状态将授予的每个邮件项的提交状态代码。</span><span class="sxs-lookup"><span data-stu-id="78b30-150">The operation status gives the submission status code for individual message items.</span></span> <span data-ttu-id="78b30-151">由于各种原因，批处理可能会失败。</span><span class="sxs-lookup"><span data-stu-id="78b30-151">Batches can fail for various reasons.</span></span> <span data-ttu-id="78b30-152">可能有与安全相关的故障，或消息可能已提交引擎已关闭时。</span><span class="sxs-lookup"><span data-stu-id="78b30-152">There might be a security-related failure, or the message might have been submitted when the engine was shutting down.</span></span> <span data-ttu-id="78b30-153">（通常当引擎关闭时它不接受任何新的工作但允许进程内可完成工作。）下表指示在批处理状态或操作状态中返回一些常见的 HRESULT 值。</span><span class="sxs-lookup"><span data-stu-id="78b30-153">(Typically when the engine shuts down it does not accept any new work but does allow in-process work to be completed.) The following table indicates some common HRESULT values that are returned either in the batch status or the operation status.</span></span> <span data-ttu-id="78b30-154">它还指示这些是否成功或失败代码。</span><span class="sxs-lookup"><span data-stu-id="78b30-154">It also indicates whether these are success or failure codes.</span></span> <span data-ttu-id="78b30-155">正确处理这些代码中所述更完全[如何处理适配器故障影响](../core/how-to-handle-adapter-failures.md)。</span><span class="sxs-lookup"><span data-stu-id="78b30-155">The proper handling of these codes is described more fully in [How to Handle Adapter Failures](../core/how-to-handle-adapter-failures.md).</span></span>  
  
|<span data-ttu-id="78b30-156">（BTTransportProxy 的类中定义） 的代码</span><span class="sxs-lookup"><span data-stu-id="78b30-156">Code (defined in the class BTTransportProxy)</span></span>|<span data-ttu-id="78b30-157">成功/失败代码</span><span class="sxs-lookup"><span data-stu-id="78b30-157">Success/failure code</span></span>|<span data-ttu-id="78b30-158">Description</span><span class="sxs-lookup"><span data-stu-id="78b30-158">Description</span></span>|  
|----------------------------------------------------|---------------------------|-----------------|  
|<span data-ttu-id="78b30-159">BTS_S_EPM_SECURITY_CHECK_FAILED</span><span class="sxs-lookup"><span data-stu-id="78b30-159">BTS_S_EPM_SECURITY_CHECK_FAILED</span></span>|<span data-ttu-id="78b30-160">成功</span><span class="sxs-lookup"><span data-stu-id="78b30-160">Success</span></span>|<span data-ttu-id="78b30-161">此端口已配置为执行安全检查和删除身份验证失败的消息。</span><span class="sxs-lookup"><span data-stu-id="78b30-161">The port was configured to perform a security check and drop messages that failed authentication.</span></span> <span data-ttu-id="78b30-162">适配器不应挂起返回此状态代码的批处理。</span><span class="sxs-lookup"><span data-stu-id="78b30-162">Adapters should not suspend batches that return this status code.</span></span>|  
|<span data-ttu-id="78b30-163">BTS_S_EPM_MESSAGE_SUSPENDED</span><span class="sxs-lookup"><span data-stu-id="78b30-163">BTS_S_EPM_MESSAGE_SUSPENDED</span></span>|<span data-ttu-id="78b30-164">成功</span><span class="sxs-lookup"><span data-stu-id="78b30-164">Success</span></span>|<span data-ttu-id="78b30-165">表示一个或多个消息已挂起，引擎具有数据的所有权。</span><span class="sxs-lookup"><span data-stu-id="78b30-165">Indicates that one or more messages were suspended, and the engine has ownership of the data.</span></span> <span data-ttu-id="78b30-166">它的成功代码在于 the Messaging Engine 已接受消息提交。</span><span class="sxs-lookup"><span data-stu-id="78b30-166">It is a success code in that the Messaging Engine has accepted the message submission.</span></span>|  
|<span data-ttu-id="78b30-167">E_BTS_URL_DISALLOWED</span><span class="sxs-lookup"><span data-stu-id="78b30-167">E_BTS_URL_DISALLOWED</span></span>|<span data-ttu-id="78b30-168">失败</span><span class="sxs-lookup"><span data-stu-id="78b30-168">Failure</span></span>|<span data-ttu-id="78b30-169">一条消息已提交具有无效**InboundTransportLocation**。</span><span class="sxs-lookup"><span data-stu-id="78b30-169">A message was submitted with an invalid **InboundTransportLocation**.</span></span>|  
  
## <a name="batch-operations"></a><span data-ttu-id="78b30-170">批处理操作</span><span class="sxs-lookup"><span data-stu-id="78b30-170">Batch Operations</span></span>  
 <span data-ttu-id="78b30-171">下表详细说明的成员方法和操作**IBTTransportBatch**对象，该适配器使用以将工作添加到给定的批处理。</span><span class="sxs-lookup"><span data-stu-id="78b30-171">The following table details the member methods and operations of the **IBTTransportBatch** object that the adapter uses to add work to a given batch.</span></span>  
  
|<span data-ttu-id="78b30-172">方法名称</span><span class="sxs-lookup"><span data-stu-id="78b30-172">Method name</span></span>|<span data-ttu-id="78b30-173">操作类型</span><span class="sxs-lookup"><span data-stu-id="78b30-173">Operation type</span></span>|<span data-ttu-id="78b30-174">Description</span><span class="sxs-lookup"><span data-stu-id="78b30-174">Description</span></span>|  
|-----------------|--------------------|-----------------|  
|<span data-ttu-id="78b30-175">**SubmitMessage**</span><span class="sxs-lookup"><span data-stu-id="78b30-175">**SubmitMessage**</span></span>|<span data-ttu-id="78b30-176">提交</span><span class="sxs-lookup"><span data-stu-id="78b30-176">Submit</span></span>|<span data-ttu-id="78b30-177">将消息提交到引擎。</span><span class="sxs-lookup"><span data-stu-id="78b30-177">Submits a message into the engine.</span></span>|  
|<span data-ttu-id="78b30-178">**SubmitResponseMessage**</span><span class="sxs-lookup"><span data-stu-id="78b30-178">**SubmitResponseMessage**</span></span>|<span data-ttu-id="78b30-179">提交</span><span class="sxs-lookup"><span data-stu-id="78b30-179">Submit</span></span>|<span data-ttu-id="78b30-180">将响应消息提交到引擎。</span><span class="sxs-lookup"><span data-stu-id="78b30-180">Submits a response message into the engine.</span></span> <span data-ttu-id="78b30-181">这是请求-响应对中的响应消息。</span><span class="sxs-lookup"><span data-stu-id="78b30-181">This is the response message in a solicit-response pair.</span></span>|  
|<span data-ttu-id="78b30-182">**DeleteMessage**</span><span class="sxs-lookup"><span data-stu-id="78b30-182">**DeleteMessage**</span></span>|<span data-ttu-id="78b30-183">DELETE</span><span class="sxs-lookup"><span data-stu-id="78b30-183">Delete</span></span>|<span data-ttu-id="78b30-184">删除适配器已成功传输通过网络中使用非阻止发送一条消息。</span><span class="sxs-lookup"><span data-stu-id="78b30-184">Deletes a message that an adapter has successfully transmitted over the wire using a non-blocking send.</span></span> <span data-ttu-id="78b30-185">使用阻止发送的适配器不需要调用此方法，因为消息引擎会将其删除适配器的代表如果适配器返回`true`从**TransmitMesssage**。</span><span class="sxs-lookup"><span data-stu-id="78b30-185">Adapters that use blocking sends do not need to call this method because the Messaging Engine will delete it on the adapter's behalf if the adapter returns `true` from **TransmitMesssage**.</span></span>|  
|<span data-ttu-id="78b30-186">**MoveToSuspendQ**</span><span class="sxs-lookup"><span data-stu-id="78b30-186">**MoveToSuspendQ**</span></span>|<span data-ttu-id="78b30-187">MoveToSuspendQ</span><span class="sxs-lookup"><span data-stu-id="78b30-187">MoveToSuspendQ</span></span>|<span data-ttu-id="78b30-188">将消息移动到已挂起队列中。</span><span class="sxs-lookup"><span data-stu-id="78b30-188">Moves a message into the Suspended queue.</span></span>|  
|<span data-ttu-id="78b30-189">**重新提交**</span><span class="sxs-lookup"><span data-stu-id="78b30-189">**Resubmit**</span></span>|<span data-ttu-id="78b30-190">重新提交</span><span class="sxs-lookup"><span data-stu-id="78b30-190">Resubmit</span></span>|<span data-ttu-id="78b30-191">一条消息，应在以后的传输重试请求。</span><span class="sxs-lookup"><span data-stu-id="78b30-191">Requests that a message should be retried for transmission at a later time.</span></span> <span data-ttu-id="78b30-192">这通常称为后传输尝试失败。</span><span class="sxs-lookup"><span data-stu-id="78b30-192">This is typically called after a transmission attempt has failed.</span></span>|  
|<span data-ttu-id="78b30-193">**MoveToNextTransport**</span><span class="sxs-lookup"><span data-stu-id="78b30-193">**MoveToNextTransport**</span></span>|<span data-ttu-id="78b30-194">MoveToNextTransport</span><span class="sxs-lookup"><span data-stu-id="78b30-194">MoveToNextTransport</span></span>|<span data-ttu-id="78b30-195">请求，使用其备份传输传输一条消息。</span><span class="sxs-lookup"><span data-stu-id="78b30-195">Requests that a message be transmitted using its backup transport.</span></span> <span data-ttu-id="78b30-196">通常称为耗尽所有重试后。</span><span class="sxs-lookup"><span data-stu-id="78b30-196">Typically called after all retries have been exhausted.</span></span> <span data-ttu-id="78b30-197">如果存在任何备份的传输，不则此方法将失败</span><span class="sxs-lookup"><span data-stu-id="78b30-197">If no backup transport is present this method will fail</span></span>|  
|<span data-ttu-id="78b30-198">**SubmitRequestMessage**</span><span class="sxs-lookup"><span data-stu-id="78b30-198">**SubmitRequestMessage**</span></span>|<span data-ttu-id="78b30-199">SubmitRequest</span><span class="sxs-lookup"><span data-stu-id="78b30-199">SubmitRequest</span></span>|<span data-ttu-id="78b30-200">将提交请求消息。</span><span class="sxs-lookup"><span data-stu-id="78b30-200">Submits a request message.</span></span> <span data-ttu-id="78b30-201">这是请求-响应对中的请求消息。</span><span class="sxs-lookup"><span data-stu-id="78b30-201">This is a request message in a request-response pair.</span></span>|  
|<span data-ttu-id="78b30-202">**CancelRequestForResponse**</span><span class="sxs-lookup"><span data-stu-id="78b30-202">**CancelRequestForResponse**</span></span>|<span data-ttu-id="78b30-203">CancelRequestForResponse</span><span class="sxs-lookup"><span data-stu-id="78b30-203">CancelRequestForResponse</span></span>|<span data-ttu-id="78b30-204">通知适配器不再想要等待的请求-响应对中的响应消息的引擎。</span><span class="sxs-lookup"><span data-stu-id="78b30-204">Notifies the engine that the adapter no longer wishes to wait for the response message in a request-response pair.</span></span>|  
|<span data-ttu-id="78b30-205">**Clear**</span><span class="sxs-lookup"><span data-stu-id="78b30-205">**Clear**</span></span>|<span data-ttu-id="78b30-206">不适用</span><span class="sxs-lookup"><span data-stu-id="78b30-206">NA</span></span>|<span data-ttu-id="78b30-207">清除批次中的所有工作。</span><span class="sxs-lookup"><span data-stu-id="78b30-207">Clears all work from the batch.</span></span>|  
|<span data-ttu-id="78b30-208">**完成**</span><span class="sxs-lookup"><span data-stu-id="78b30-208">**Done**</span></span>|<span data-ttu-id="78b30-209">不适用</span><span class="sxs-lookup"><span data-stu-id="78b30-209">NA</span></span>|<span data-ttu-id="78b30-210">将提交一批引擎以进行处理的消息。</span><span class="sxs-lookup"><span data-stu-id="78b30-210">Submits a batch of messages to the engine for processing.</span></span>|  
  
## <a name="batch-management"></a><span data-ttu-id="78b30-211">批处理管理</span><span class="sxs-lookup"><span data-stu-id="78b30-211">Batch Management</span></span>  
 <span data-ttu-id="78b30-212">在消息引擎中的本机代码中实现批处理。</span><span class="sxs-lookup"><span data-stu-id="78b30-212">Batches are implemented in native code in the Messaging Engine.</span></span> <span data-ttu-id="78b30-213">出于此原因用托管代码编写的适配器应释放运行时可调用包装 (RCW) 批处理与批次完成之后。</span><span class="sxs-lookup"><span data-stu-id="78b30-213">For this reason an adapter written in managed code should release the runtime callable wrapper (RCW) for the batch after it has finished with the batch.</span></span> <span data-ttu-id="78b30-214">这可在托管代码中使用**Marshal.ReleaseComObject** API。</span><span class="sxs-lookup"><span data-stu-id="78b30-214">This is done in managed code by using the **Marshal.ReleaseComObject** API.</span></span> <span data-ttu-id="78b30-215">务必记住，在一段时间中应该调用此 API 循环执行，直到返回的引用计数达到零时。</span><span class="sxs-lookup"><span data-stu-id="78b30-215">It is important to remember that this API should be called in a while loop until the returned reference count reaches zero.</span></span>  
  
 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]<span data-ttu-id="78b30-216">处理同步在一个批处理中的消息。</span><span class="sxs-lookup"><span data-stu-id="78b30-216"> processes messages synchronously within a batch.</span></span> <span data-ttu-id="78b30-217">同时，它提供的信息与适配器中的某些优化机会通过调整应用程序域中的批处理大小，均可以处理许多批处理。</span><span class="sxs-lookup"><span data-stu-id="78b30-217">Many batches may be processed concurrently, which may provide an opportunity for some optimization in the adapter by adjusting the batch size in the application domain.</span></span> <span data-ttu-id="78b30-218">例如，你可能会处理 FTP 站点上的所有文件 （直到命中某些限制）。</span><span class="sxs-lookup"><span data-stu-id="78b30-218">For example, you might process all the files on an FTP site (until some limit is hit).</span></span> <span data-ttu-id="78b30-219">对于 SAP 可能到数目的消息，然后提交以批处理方式处理单个流。</span><span class="sxs-lookup"><span data-stu-id="78b30-219">In the case of SAP you might process a single stream into a number of messages that are then submitted as a batch.</span></span>  
  
 <span data-ttu-id="78b30-220">适配器用于传递操作批处理回[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]不需要完全对应的消息列表的[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]赋予适配器。</span><span class="sxs-lookup"><span data-stu-id="78b30-220">The batch used by an adapter to pass operations back to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] does not need to exactly correspond to the list of messages that [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] gives to the adapter.</span></span> <span data-ttu-id="78b30-221">换而言之，当这样做事务发送必须拆分重新提交操作**MoveToNextTransport**和**MoveToSuspendQ**到单独的批处理文件。</span><span class="sxs-lookup"><span data-stu-id="78b30-221">In other words, when doing transactional sends you must split the resubmit operations **MoveToNextTransport** and **MoveToSuspendQ** into separate batches.</span></span> <span data-ttu-id="78b30-222">许多适配器对一批消息的多个终结点提交到单独的进一步处理的消息的列表进行排序。</span><span class="sxs-lookup"><span data-stu-id="78b30-222">Many adapters sort a batch of messages that have been submitted for multiple endpoints into separate lists of messages for further processing.</span></span>  
  
 <span data-ttu-id="78b30-223">点是否不有任何规则 （除了与事务关联的那些） 与消息批处理中关联[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="78b30-223">The point is that there are no rules (besides those associated with the transaction) associated with message batching in [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span> <span data-ttu-id="78b30-224">批处理是只需为使适配器进出分块消息的特定于实现的方法[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="78b30-224">Batching is simply an implementation-specific way for the adapter to chunk messages into and out of [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span>  
  
 <span data-ttu-id="78b30-225">一个适配器可以批处理中的消息较小的多个批处理[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]授予它较大的批插入到响应[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="78b30-225">An adapter can batch messages from multiple smaller batches that [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] has given it into a larger batch for the response to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span> <span data-ttu-id="78b30-226">这可能是处理的大量非常小的消息的事务适配器中的一个重要优化。</span><span class="sxs-lookup"><span data-stu-id="78b30-226">This might be a significant optimization in transactional adapters that are dealing with large numbers of very small messages.</span></span> <span data-ttu-id="78b30-227">它最小化"的每个消息的事务总数"比率。</span><span class="sxs-lookup"><span data-stu-id="78b30-227">It minimizes the "total number of transactions per message" ratio.</span></span>  
  
 <span data-ttu-id="78b30-228">通常[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]产生 5-10 的消息之间的发送端批处理。</span><span class="sxs-lookup"><span data-stu-id="78b30-228">Typically [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] produces send-side batches of between 5 and 10 messages.</span></span> <span data-ttu-id="78b30-229">如果这些是很小的消息、 适配器可能批处理最多 100 个消息或多个提交的事务性批处理中的删除之前回[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="78b30-229">If these are very small messages, an adapter might batch up to 100 messages or more before it submits a transactional batch of deletes back to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span> <span data-ttu-id="78b30-230">一种优化方式如下并不容易实现;你必须确保消息永远不会在适配器内存中，获取遇到有关某一阈值，需满足无休止地等待。</span><span class="sxs-lookup"><span data-stu-id="78b30-230">An optimization like this is not easy to implement; you must make sure that messages never get stuck in the adapter memory, waiting endlessly for some threshold to be met.</span></span>  
  
 <span data-ttu-id="78b30-231">批处理的重要性所示的性能数字[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]如 MQSeries 高吞吐量适配器。</span><span class="sxs-lookup"><span data-stu-id="78b30-231">The significance of batching can be seen in the performance numbers for [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] for the high-throughput adapters like MQSeries.</span></span> <span data-ttu-id="78b30-232">这些适配器可以在至少两次经常与将它们发送接收消息。</span><span class="sxs-lookup"><span data-stu-id="78b30-232">In these adapters, messages are received at least twice as often as they are sent.</span></span> <span data-ttu-id="78b30-233">默认情况下接收适配器使用批次的 100 个消息并发送适配器使用默认值[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]将为其给定的批处理。</span><span class="sxs-lookup"><span data-stu-id="78b30-233">By default the receive adapter uses batches of 100 messages and the send adapter uses the default [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] batch it is given.</span></span>  
  
## <a name="transactional-batches"></a><span data-ttu-id="78b30-234">事务批</span><span class="sxs-lookup"><span data-stu-id="78b30-234">Transactional Batches</span></span>  
 <span data-ttu-id="78b30-235">当你编写的适配器，创建事务对象，并为到[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]，表明你接受负责编写的代码，执行下列任务：</span><span class="sxs-lookup"><span data-stu-id="78b30-235">When you write an adapter that creates a transaction object and hands it to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)], you are accepting responsibility for writing code that does the following:</span></span>  
  
-   <span data-ttu-id="78b30-236">决定批处理操作的最终结果： 提交或结束事务。</span><span class="sxs-lookup"><span data-stu-id="78b30-236">Decides the final outcome of the batch operation: to either commit or end the transaction.</span></span> <span data-ttu-id="78b30-237">这可能取决于事务的其他分支的范围内的此一个事务不[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]依赖项，例如，对消息队列 (MSMQ) 队列或事务的数据库操作写入。</span><span class="sxs-lookup"><span data-stu-id="78b30-237">This may depend upon other transactional branches within the scope of this one transaction that are not [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] dependent, such as writing to an Message Queuing (MSMQ) queue or a transactional database operation.</span></span>  
  
-   <span data-ttu-id="78b30-238">通知[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]通过调用的最后结果的**IBTDTCCommitConfirm.DTCCommitConfirm**方法。</span><span class="sxs-lookup"><span data-stu-id="78b30-238">Informs [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] of the final outcome by calling the **IBTDTCCommitConfirm.DTCCommitConfirm** method.</span></span> <span data-ttu-id="78b30-239">返回`true`指示成功提交的事务; 返回`false`表示失败，并回滚事务。</span><span class="sxs-lookup"><span data-stu-id="78b30-239">Returning `true` indicates a successful commit of the transaction; returning `false` signifies failure and rollback of the transaction.</span></span>  
  
 <span data-ttu-id="78b30-240">适配器必须通知[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]关于事务来维护其内部的最终结果跟踪数据。</span><span class="sxs-lookup"><span data-stu-id="78b30-240">The adapter must inform [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] about the final outcome of the transaction to maintain its internal tracking data.</span></span> <span data-ttu-id="78b30-241">适配器通知[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]通过调用的结果的**DTCCommitConfirm**。</span><span class="sxs-lookup"><span data-stu-id="78b30-241">The adapter informs [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] of the outcome by calling **DTCCommitConfirm**.</span></span> <span data-ttu-id="78b30-242">如果适配器不满足该条件，则会发生大量的内存泄漏和 MSDTC 事务可能会超时，并且尽管成功完成其操作失败。</span><span class="sxs-lookup"><span data-stu-id="78b30-242">If the adapter does not do this, a significant memory leak occurs and the MSDTC transaction could time out and fail despite its operations completing successfully.</span></span>