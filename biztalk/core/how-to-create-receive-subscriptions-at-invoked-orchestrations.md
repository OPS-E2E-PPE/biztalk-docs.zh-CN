---
title: 如何创建接收调用的业务流程上的订阅 |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 3423309a-cb5a-40a5-9582-6ee3ac82b538
caps.latest.revision: 9
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: a3ccb4743b2054a02d492b053de21a32a27badaf
ms.sourcegitcommit: 266308ec5c6a9d8d80ff298ee6051b4843c5d626
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 06/27/2018
ms.locfileid: "37010302"
---
# <a name="how-to-create-receive-subscriptions-at-invoked-orchestrations"></a><span data-ttu-id="91e14-102">如何创建接收调用的业务流程上的订阅</span><span class="sxs-lookup"><span data-stu-id="91e14-102">How to Create Receive Subscriptions at Invoked Orchestrations</span></span>
<span data-ttu-id="91e14-103">尽管您可以将消息传递作为参数通过**启动业务流程**形状在启动业务流程，在某些情况下，你可能想要从调用方业务流程向后调用的业务流程发送消息时调用。</span><span class="sxs-lookup"><span data-stu-id="91e14-103">Although you can pass messages as parameters through the **Start Orchestration** shape when you start an orchestration, in some scenarios you may want to send messages from the caller orchestration to the invoked orchestration after the invocation.</span></span> <span data-ttu-id="91e14-104">例如，您可能不清楚调用时要传递什么消息，或者其他业务流程可能需要向调用的业务流程动态发送消息。</span><span class="sxs-lookup"><span data-stu-id="91e14-104">For example, you may not know what messages you want to pass at the time of invocation, or other orchestrations may need to send messages to the invoked orchestration dynamically.</span></span>  
  
 <span data-ttu-id="91e14-105">应该通过传入一个相关来向调用的业务流程发送消息，以便调用的业务流程能够创建由该相关帮助定义的订阅，然后使用该订阅来接收消息。</span><span class="sxs-lookup"><span data-stu-id="91e14-105">The way to send a message to an invoked orchestration is to pass in a correlation so that the invoked orchestration can create the subscription that the correlation helps define and then receive the message by using that subscription.</span></span> <span data-ttu-id="91e14-106">不过，仅仅靠传入一个相关，然后由调用的业务流程基于该相关创建订阅，再根据该订阅接收消息，还是不够的。</span><span class="sxs-lookup"><span data-stu-id="91e14-106">However, you cannot simply pass in a correlation and expect the invoked orchestration to create the subscription based on the correlation and receive a message on the subscription.</span></span> <span data-ttu-id="91e14-107">如果采用上述方法，从调用方业务流程发送到调用的业务流程的消息将导致错误：“无法路由发布的消息，因为找不到订户。”</span><span class="sxs-lookup"><span data-stu-id="91e14-107">If you use that approach, the messages you send from the caller orchestration to the invoked orchestration will result in the error, "The published message could not be routed because no subscribers were found."</span></span> <span data-ttu-id="91e14-108">原因如下：</span><span class="sxs-lookup"><span data-stu-id="91e14-108">This is because of the following:</span></span>  
  
- <span data-ttu-id="91e14-109">调用的业务流程中存在争用情况。</span><span class="sxs-lookup"><span data-stu-id="91e14-109">There is a race condition in the invoked orchestration.</span></span>  
  
- <span data-ttu-id="91e14-110">不存在提交点，调用的业务流程无法向 MessageBox 数据库发送订阅以便路由，所以无法接收消息。</span><span class="sxs-lookup"><span data-stu-id="91e14-110">There is no commit point for the invoked orchestration to send the subscription to the MessageBox database for routing so that it can receive the messages.</span></span>  
  
  <span data-ttu-id="91e14-111">解决此问题的方法之一是执行以下步骤：</span><span class="sxs-lookup"><span data-stu-id="91e14-111">A way to resolve this problem is to perform the following steps:</span></span>  
  
1. <span data-ttu-id="91e14-112">在调用方业务流程中，应具有某个激活接收以接收消息。</span><span class="sxs-lookup"><span data-stu-id="91e14-112">In the caller orchestration, you have an activate receive to receive the message.</span></span> <span data-ttu-id="91e14-113">调用方业务流程中接收消息、 初始化相关集，并将相关集和一个自相关接收直接绑定端口通过后**启动业务流程**形状。</span><span class="sxs-lookup"><span data-stu-id="91e14-113">After you receive the message in the caller orchestration, initialize the correlation set, and then pass the correlation set and a self-correlating receive direct-bound port through the **Start Orchestration** shape.</span></span> <span data-ttu-id="91e14-114">传入的端口将变为调用的业务流程中的发送端口，您将用该端口发回消息，以便与调用方业务流程同步。</span><span class="sxs-lookup"><span data-stu-id="91e14-114">The port that you pass in becomes a send port in the invoked orchestration, and you will use it to send the message back to synchronize with the caller orchestration.</span></span>  
  
2. <span data-ttu-id="91e14-115">在调用的业务流程中，将消息通过自相关端口发回调用方业务流程。</span><span class="sxs-lookup"><span data-stu-id="91e14-115">In the invoked orchestration, send a message back to the caller orchestration through the self-correlating port.</span></span> <span data-ttu-id="91e14-116">这样即可与调用方业务流程保持同步，避免出现争用情况，并且在向 MessageBox 创建接收订阅以便路由的过程中在调用的业务流程中提供提交点。</span><span class="sxs-lookup"><span data-stu-id="91e14-116">This synchronizes with the caller orchestration to prevent race conditions and to provide a commit point while creating the receive subscription to the MessageBox for routing in the invoked orchestration.</span></span>  
  
3. <span data-ttu-id="91e14-117">调用方业务流程通过自相关端口接收消息，并与调用的业务流程保持同步。</span><span class="sxs-lookup"><span data-stu-id="91e14-117">The caller orchestration receives the message through the self-correlating port and synchronizes with the invoked orchestration.</span></span> <span data-ttu-id="91e14-118">请注意，使用自相关端口接收消息时不需要再指定相关。</span><span class="sxs-lookup"><span data-stu-id="91e14-118">Note that self-correlating port receives do not need correlation followers.</span></span> <span data-ttu-id="91e14-119">现在可以安全地从调用方业务流程向调用的业务流程发送消息，调用的业务流程将根据相关来接收消息。</span><span class="sxs-lookup"><span data-stu-id="91e14-119">You can now safely send messages from the caller orchestration to the invoked orchestration, and the invoked orchestration will receive the messages based upon the correlation.</span></span>  
  
   <span data-ttu-id="91e14-120">尽管上述方法可以实现目标，但更好的做法是传入对接收所基于的相关进行初始化的消息。</span><span class="sxs-lookup"><span data-stu-id="91e14-120">Although the preceding approach can achieve the goal, a better approach is to pass in the message that initializes the correlation on which you want to receive upon.</span></span> <span data-ttu-id="91e14-121">通过自相关端口对调用方业务流程和调用的业务流程进行同步时，我们建议始终传入对相关进行初始化所需的消息。</span><span class="sxs-lookup"><span data-stu-id="91e14-121">When you are synchronizing a caller orchestration with an invoked orchestration through a self-correlating port, we recommend that you always pass in the message that you need for initializing the correlations.</span></span> <span data-ttu-id="91e14-122">以下步骤提供了最为可靠且性能最佳的方法：</span><span class="sxs-lookup"><span data-stu-id="91e14-122">The following steps provide the most reliable and highest-performance approach:</span></span>  
  
4. <span data-ttu-id="91e14-123">在调用方业务流程中，应具有某个激活接收以接收消息。</span><span class="sxs-lookup"><span data-stu-id="91e14-123">In the caller orchestration, you have an activate receive to receive the message.</span></span> <span data-ttu-id="91e14-124">在收到消息后，消息传递和一个自相关接收直接绑定端口穿过**启动业务流程**形状。</span><span class="sxs-lookup"><span data-stu-id="91e14-124">After you receive the message, pass a message and a self-correlating receive direct-bound port through the **Start Orchestration** shape.</span></span> <span data-ttu-id="91e14-125">您传入的消息将用于在调用的业务流程中对相关进行初始化。</span><span class="sxs-lookup"><span data-stu-id="91e14-125">The message you pass in will be used to initialize the correlation in the invoked orchestration.</span></span> <span data-ttu-id="91e14-126">传入的端口将变为调用的业务流程中的发送端口，您将用该端口发回消息，以便与调用方业务流程同步。</span><span class="sxs-lookup"><span data-stu-id="91e14-126">The port that you pass in becomes a send port in the invoked orchestration, and you will use it to send the message back to synchronize with the caller orchestration.</span></span>  
  
5. <span data-ttu-id="91e14-127">在调用的业务流程中，对相关进行初始化，然后将消息发回调用方业务流程。</span><span class="sxs-lookup"><span data-stu-id="91e14-127">In the invoked orchestration, initialize the correlation and send a message back to the caller orchestration.</span></span> <span data-ttu-id="91e14-128">这样即可与调用方业务流程保持同步，避免出现争用情况，并且在向 MessageBox 创建接收订阅以便路由的过程中在调用的业务流程中提供提交点。</span><span class="sxs-lookup"><span data-stu-id="91e14-128">This synchronizes with the caller orchestration to prevent race conditions and to provide a commit point while creating the receive subscription to the MessageBox for routing in the invoked orchestration.</span></span>  
  
6. <span data-ttu-id="91e14-129">调用方业务流程通过自相关端口接收消息，并与调用的业务流程保持同步。</span><span class="sxs-lookup"><span data-stu-id="91e14-129">The caller orchestration receives the message through the self-correlating port and synchronizes with the invoked orchestration.</span></span> <span data-ttu-id="91e14-130">请注意，自相关端口接收不需要再指定相关。</span><span class="sxs-lookup"><span data-stu-id="91e14-130">Note that the self-correlating port receives do not need correlation followers.</span></span> <span data-ttu-id="91e14-131">现在可以安全地从调用方业务流程向调用的业务流程发送消息，调用的业务流程将根据相关来接收消息。</span><span class="sxs-lookup"><span data-stu-id="91e14-131">You can now safely send messages from the caller orchestration to the invoked orchestration, and the invoked orchestration will receive the messages based upon the correlation.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="91e14-132">请参阅</span><span class="sxs-lookup"><span data-stu-id="91e14-132">See Also</span></span>  
 <span data-ttu-id="91e14-133">[业务流程中使用的相关性](../core/using-correlations-in-orchestrations.md) </span><span class="sxs-lookup"><span data-stu-id="91e14-133">[Using Correlations in Orchestrations](../core/using-correlations-in-orchestrations.md) </span></span>  
 [<span data-ttu-id="91e14-134">如何使用自相关直接绑定端口</span><span class="sxs-lookup"><span data-stu-id="91e14-134">How to Use Self-Correlating Direct Bound Ports</span></span>](../core/how-to-use-self-correlating-direct-bound-ports.md)