---
title: 使用保护方案 |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 1028ab37-7ead-41a6-a186-53e5344d1a28
caps.latest.revision: 19
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: e3eb1e6656b6aa725cbc110030257df77657b631
ms.sourcegitcommit: 381e83d43796a345488d54b3f7413e11d56ad7be
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/07/2019
ms.locfileid: "65258525"
---
# <a name="working-with-convoy-scenarios"></a>使用保护方案
一个*保护*存在多个单独的消息必须起来才能达到所需的结果的任何时间。 有两种主要类型的保护： 顺序和并行。  
  
 某些情况下，业务流程实例可能会全部在同一时间收到一组相关消息。 在此情况下，争用条件可能会出现，在其中一个组中的消息必须初始化中的相关集的业务流程实例之前其他消息再关联到该业务流程实例。  
  
 若要确保由相同的业务流程实例收到所有相关的消息，BizTalk Server 检测到潜在的争用条件，并将这些消息视为一个保护。 登记时，运行时创建一个常规订阅和其标识为保护的组成部分。 后填写完此订阅，消息引擎创建一个临时订阅中预定义的相关属性的值。 此临时订阅称为*护航集*。 保护集就是一组在保护中使用的相关集。 与常规订阅匹配的所有后续消息根据保护集进行计算并与匹配的路由到现有的端口。  
  
## <a name="using-convoys-with-business-processes"></a>业务流程中使用保护  
 使用保护处理业务流程时，请考虑以下方法：  
  
-   一个*相关集*是具有将消息路由到特定业务流程使用的特定值的属性的列表。 使用上的相关集**接收**形状不能包含三个以上用于相关的属性。 这是因为这些值进行标识和存储在数据库级别，支持最多三个参数。  
  
-   并行和顺序保护可以共存于同一业务流程，但它们不能彼此共享任何相关集。 这是因为每个相关集只能属于一个保护。  
  
-   BizTalk Server 不支持保护处理时使用**启动业务流程**形状以将传递到新的业务流程设置已初始化的相关。 这是因为保护集在数据库级别，独立于已运行的业务流程实例的处理。  
  
-   不能使用单个**接收**形状来初始化将不同保护中使用的两个或多个相关集。 例如，假设接收 r1 初始化相关集 c1 和 c2 的第一个保护接收 r2 为第二个保护，如下所示 c1，接收 r3 为第三个保护如下所示 c2。 第二个保护的保护集 c1，r2 和第三个保护的保护集是 c2，r3，都由 r1 初始化。 在这种情况下，业务流程引擎不会将它们视为保护。 该示例是一个有效的保护方案，如果 r2 和 r3 遵循 c1 和 c2 (c1，r2，r3 和 c2，r2，r3)，二者均遵循 c1 唯一 (c1，r2，r3)，或二者均遵循 c2 唯一 (c2，r2，r3)。  
  
## <a name="zombies"></a>僵停  
 使用保护可以导致称为僵停的"丢失"消息。 非激活接收时正在运行的业务流程中的订阅与 MessageBox 数据库中的消息相匹配，则 MessageBox 的消息传递到业务流程。 由于 MessageBox 不知道该业务流程内部的业务逻辑，它只是提供了到业务流程与订阅匹配的所有消息。 如果任何这些消息传递的是业务流程执行流已经传递接收订阅后，可以使用消息时，此类消息成为僵停。  
  
 产生僵停的情况下的一个示例是接收循环 17 次循环内的，但 18 的消息传送的匹配中循环的接收订阅。 （MessageBox 不知道的业务流程逻辑只处理 17 个消息。）第 18 的消息传递未被业务流程，因为执行流已经退出循环。 业务流程已完成并且丢弃消息 （僵停），这是因为已经完成业务流程实例不可恢复。  
  
 可以使用 Windows Management Instrumentation (WMI) 脚本来查询了"已挂起-不可恢复"状态的实例管理僵停。 此外，消息引擎将写入错误消息，"已完成有消息被放弃"，该事件的日志。  
  
 此外，如果顺序保护具有长时间运行事务作用域，并且该作用域具有超时设置，某些业务流程实例最终可能处于"已挂起-不可恢复"状态。 您可能还注意到其中的输出消息的数量加"已挂起-不可恢复"实例数小于输入消息数。 这种行为是默认设置。 在超时异常情况下，代码将进入异常处理程序。 BizTalk Server 调用异常处理程序，以使其处理的异常，包括处理僵停。 可以使用异常处理程序中的发送端口将僵停发送到目标以进一步查看和处理。  
  
 保护以外的方案还可以生成僵停。 例如，假设业务流程实例需要一个响应消息从业务流程自动运行，由于某种原因，它接收两个匹配的订阅的响应消息。 在这种情况下，第二个响应消息成为僵停消息。 另一个示例是，有时**侦听**形状和**接收**在一个分支的形状和一个**延迟**形状在其他分支。 如果一条消息到达时同时发生超时的时候，该消息成为僵停消息。  
  
 有关如何管理僵停的详细信息，请参阅**删除挂起的服务实例** [!INCLUDE[ui-guidance-developers-reference](../includes/ui-guidance-developers-reference.md)]。
  
## <a name="next-steps"></a>后续步骤
 [顺序保护](../core/sequential-convoys.md)  
  
 [并行保护](../core/parallel-convoys.md)  
  
## <a name="see-also"></a>请参阅  
 [在业务流程中使用关联](../core/using-correlations-in-orchestrations.md)