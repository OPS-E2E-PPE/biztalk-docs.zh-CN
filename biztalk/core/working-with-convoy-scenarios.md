---
title: "使用队列方案 |Microsoft 文档"
ms.custom: 
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: 1028ab37-7ead-41a6-a186-53e5344d1a28
caps.latest.revision: "19"
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 42f1c9931fe91b284c53a05c7868554c622306fb
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/20/2017
---
# <a name="working-with-convoy-scenarios"></a>使用保护方案
A*队列*存在的任何时间都必须与相关多个单个消息，以实现所需的结果。 有两种主要类型的保护： 顺序和并行。  
  
 在某些情况下，业务流程实例可能会同时收到一组相关消息。 这时就会产生争用条件，必须从该组中选出一条消息，令其在该业务流程实例中初始化一个相关集，然后其他消息再关联到该业务流程实例。  
  
 为了确保所有相关消息都由同一个业务流程实例接收，BizTalk Server 会检测出现争用条件的可能性，并将这些消息视为一个保护。 登记时，运行时会创建一个常规订阅，并将其标识为保护的组成部分。 填写完此订阅后，消息引擎会根据预定义相关属性的值，创建一个临时订阅。 此临时订阅称为*护航集*。 一个保护集就是一组在保护中使用的相关集。 系统会依据保护集，对所有匹配常规订阅的后续消息进行评价，匹配的消息被路由到一个现有端口。  
  
## <a name="using-convoys-with-business-processes"></a>在业务流程中使用保护  
 在业务流程中使用保护处理时，请注意以下事项：  
  
-   A*相关集*是与消息路由到特定的业务流程用于特定值的属性的列表。 关联集上使用**接收**形状不能包含超过三个用于相关的属性。 这是因为这些值在数据库级别上进行标识和存储，而这种方式最多只支持三个参数。  
  
-   并行保护和顺序保护可并存于同一个业务流程中，但相互之间不能共享任何相关集。 这是因为每个相关集只能属于一个保护。  
  
-   BizTalk Server 不支持队列处理，当你使用**启动 Orchestration**形状将设置到新的业务流程已初始化相关。 这是因为保护集是在数据库级别处理的，独立于已在运行的业务流程实例。  
  
-   不能使用单个**接收**形状初始化将在单独的保护中使用的两个或多个关联集。 例如，假设接收 r1 为第一个保护初始化相关集 c1 和 c2，接收 r2 为第二个保护初始化 c1，接收 r3 为第三个保护初始化 c2。 设想中，第二个保护的保护集为 (c1, r2)，第三个保护的保护集为 (c2, r3)，它们都由 r1 初始化。 在这种情况下，业务流程引擎不会将它们视为保护。 在这个例子中，如果 r2 和 r3 均初始化 c1 (c1, r2, r3) 和 c2 (c2, r2, r3)，均仅初始化 c1 (c1, r2, r3) 或均仅初始化 c2 (c2, r2, r3)，则该保护方案将是有效的。  
  
## <a name="zombies"></a>僵停  
 使用保护可能会引发称为僵停的“丢失”消息。 如果正在运行的业务流程中的非激活接收订阅与 MessageBox 数据库中的消息相匹配，则 MessageBox 会将该消息传递给业务流程。 由于 MessageBox 不了解业务流程内的业务逻辑，所以它只是简单地将所有匹配订阅的消息都传递给业务流程。 如果在该业务流程的执行流已经传递了可处理消息的接收订阅后，又传送了匹配消息，则这些消息将会僵停。  
  
 产生僵停的一个例子是：在一个循环中，一个接收循环 17 次，却有 18 个与该循环中的接收订阅匹配的消息被传出。 （MessageBox 不知道该业务流程逻辑只处理 17 个消息。）由于该业务流程的执行流已经退出了循环，因此传出的第 18 个消息将不会被处理。 该业务流程完成时，有丢弃的消息（僵停），这是不可恢复的，因为该业务流程实例已经完成了。  
  
 使用 Windows 管理规范 (WMI) 脚本来查询处于“已挂起-不可恢复”状态的实例，可以对僵停进行管理。 此外，消息引擎还会向事件日志写入一条错误消息：“已完成，有消息被放弃”。  
  
 而且，如果顺序保护具有长期事务作用域，且该作用域有超时设置，则某些业务流程实例也将以“已挂起-不可恢复”状态结束。 您也许已经注意到了输出消息数与“已挂起-不可恢复”实例数之和小于输入消息数。 这种行为是默认设置。 发生超时异常时，代码将会转向异常处理程序。 BizTalk Server 调用异常处理程序来处理该异常，其中包括处理僵停。 您可以使用异常处理程序中的发送端口，将僵停发送到一个目标，以进一步查看和处理。  
  
 除保护外，其他方案也会产生僵停。 例如，假设一个业务流程实例在等待来自业务处理流程的响应消息，由于某种原因，它接收到了两个匹配订阅的响应消息。 在这种情况下，第二个响应消息成为僵停消息。 另一个示例是当你有**侦听**调整与**接收**形状一个分支和一个**延迟**在其他分支的形状。 如果消息到达的同时发生超时，则该消息成为僵停消息。  
  
 有关如何管理僵尸的详细信息，请参阅**删除挂起的服务实例** [!INCLUDE[ui-guidance-developers-reference](../includes/ui-guidance-developers-reference.md)]。
  
## <a name="next-steps"></a>后续步骤
 [顺序保护](../core/sequential-convoys.md)  
  
 [并行的保护](../core/parallel-convoys.md)  
  
## <a name="see-also"></a>另请参阅  
 [在业务流程中使用相关性](../core/using-correlations-in-orchestrations.md)