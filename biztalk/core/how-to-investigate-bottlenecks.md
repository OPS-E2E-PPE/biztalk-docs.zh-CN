---
title: "如何调查瓶颈 |Microsoft 文档"
ms.custom: 
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: 7ca22d07-d5fe-4dfb-8b52-3be3a95b0d6f
caps.latest.revision: "4"
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: a6a3cf4630bf3269516537439ed58b464589cf26
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/20/2017
---
# <a name="how-to-investigate-bottlenecks"></a><span data-ttu-id="a4197-102">如何调查瓶颈</span><span class="sxs-lookup"><span data-stu-id="a4197-102">How to Investigate Bottlenecks</span></span>
<span data-ttu-id="a4197-103">本主题介绍如何调查瓶颈的建议过程。</span><span class="sxs-lookup"><span data-stu-id="a4197-103">This topic describes a recommended process for how to investigate bottlenecks.</span></span>  
  
## <a name="what-is-the-source-of-the-problem"></a><span data-ttu-id="a4197-104">什么是问题根源？</span><span class="sxs-lookup"><span data-stu-id="a4197-104">What is the Source of the Problem?</span></span>  
 <span data-ttu-id="a4197-105">问题根源可能是相关的硬件或软件。</span><span class="sxs-lookup"><span data-stu-id="a4197-105">The source of the problem could be hardware or software related.</span></span> <span data-ttu-id="a4197-106">在资源利用不足时，通常意味着系统中某处是瓶颈。</span><span class="sxs-lookup"><span data-stu-id="a4197-106">When resources are underutilized it is usually an indication of a bottleneck somewhere in the system.</span></span> <span data-ttu-id="a4197-107">瓶颈可能源于硬件限制，也可能源于软件配置效率低下，也可能同时由这两方面导致。</span><span class="sxs-lookup"><span data-stu-id="a4197-107">Bottlenecks can be caused either due to hardware limitations or due to inefficient software configurations or both.</span></span>  
  
 <span data-ttu-id="a4197-108">确定瓶颈是一个渐进式的过程，因此缓解一个问题可能导致发现下一个过程。</span><span class="sxs-lookup"><span data-stu-id="a4197-108">Identifying bottlenecks is an incremental process whereby alleviating one bottleneck can lead to the discovery of the next one.</span></span> <span data-ttu-id="a4197-109">本主题的目标就是帮助您科学地确定和缓解这些瓶颈。</span><span class="sxs-lookup"><span data-stu-id="a4197-109">The science of identifying and alleviating these bottlenecks is the objective of this topic.</span></span> <span data-ttu-id="a4197-110">系统有可能在短期内以峰值执行。</span><span class="sxs-lookup"><span data-stu-id="a4197-110">It is possible for a system to perform at peaks for short periods of time.</span></span> <span data-ttu-id="a4197-111">但为了可承受吞吐量，系统只能按其执行速度最慢的组件的最快速度进行处理。</span><span class="sxs-lookup"><span data-stu-id="a4197-111">However, for sustainable throughput a system can only process as fast as its slowest performing component.</span></span>  
  
## <a name="using-a-serial-approach"></a><span data-ttu-id="a4197-112">使用连续方法</span><span class="sxs-lookup"><span data-stu-id="a4197-112">Using a Serial Approach</span></span>  
 <span data-ttu-id="a4197-113">瓶颈可能发生在系统的终结点（进入/退出），有时候也会发生在中间（业务流程/数据库）。</span><span class="sxs-lookup"><span data-stu-id="a4197-113">Bottlenecks can occur at the endpoints (entry/exit) of the system or somewhere in the middle (orchestration/database).</span></span> <span data-ttu-id="a4197-114">在确定瓶颈位置后，可以采用结构化的方法来标识问题根源。</span><span class="sxs-lookup"><span data-stu-id="a4197-114">After the location of the bottleneck has been isolated a structured approach can be undertaken to identify the source.</span></span> <span data-ttu-id="a4197-115">在缓解了瓶颈问题后，需要再次测量性能，以确保没有在系统的其他地方造成新的瓶颈。</span><span class="sxs-lookup"><span data-stu-id="a4197-115">After the bottlenecks have been alleviated it is essential to measure performance again to ensure that a new bottleneck has not been introduced elsewhere in the system further down the line.</span></span>  
  
 <span data-ttu-id="a4197-116">标识和解决瓶颈的过程应该以连续的方式进行，因此一次只应对一个参数进行变化，然后对性能进行测量以验证这一单个变化的影响。</span><span class="sxs-lookup"><span data-stu-id="a4197-116">The process of identifying and fixing bottlenecks should be done in a serial manner whereby only one parameter at a time should be varied and then performance measured to verify the impact of that single change.</span></span> <span data-ttu-id="a4197-117">一次变化多个参数可能会掩盖更改结果。</span><span class="sxs-lookup"><span data-stu-id="a4197-117">Varying more than one parameter at a time could conceal the effect of the change.</span></span>  
  
 <span data-ttu-id="a4197-118">例如，尽管更改参数 1 可能会改善性能，但如果更改参数 1 时还一同更改了参数 2，则可能会产生抵消更改参数 1 所带来的好处的负面影响，因此导致正负抵消的零效果。</span><span class="sxs-lookup"><span data-stu-id="a4197-118">For example, changing parameter 1 could improve performance however, changing parameter 2 in conjunction with changing parameter 1 could have a detrimental effect negating the benefits of changing parameter 1 thus leading to a net zero effect.</span></span> <span data-ttu-id="a4197-119">而且，也可能会造成改变参数 1 会带来负面效果、而改变参数 2 会带来正面效果的完全虚假的印象。</span><span class="sxs-lookup"><span data-stu-id="a4197-119">However, this results in a false negative on the effect of varying parameter 1 and a false positive on the effect of varying parameter 2.</span></span>  
  
## <a name="testing-consistency"></a><span data-ttu-id="a4197-120">测试一致性</span><span class="sxs-lookup"><span data-stu-id="a4197-120">Testing Consistency</span></span>  
 <span data-ttu-id="a4197-121">在更改设置后测量性能有利于验证更改的效果。</span><span class="sxs-lookup"><span data-stu-id="a4197-121">Measuring performance characteristics after changing settings is imperative to validate the effect of the change.</span></span>  
  
-   <span data-ttu-id="a4197-122">的硬件： 它是对重要使用为不同的硬件一致的硬件可以显示不一致的行为，例如生成误导性结果不使用便携式计算机。</span><span class="sxs-lookup"><span data-stu-id="a4197-122">Hardware: It is important to use consistent hardware as varying the hardware can display inconsistent behavior producing misleading results e.g. do not use a laptop.</span></span>  
  
-   <span data-ttu-id="a4197-123">测试运行持续时间： 它还进行测量非常重要的固定的最短期限以确保结果的确实可持续和不是简单地峰值性能。</span><span class="sxs-lookup"><span data-stu-id="a4197-123">Test Run Duration: It is also important to measure performance for a fixed minimum period to ensure that the results are indeed sustainable and not simply peaks.</span></span> <span data-ttu-id="a4197-124">执行较长时间段的测试的另一个原因是：确保系统经历热启动/突增期间（此期间中，所有缓存都被填满，数据库表达到预期计数，并在达到预定义的阈值后有足够时间进行限流和调整吞吐量）。</span><span class="sxs-lookup"><span data-stu-id="a4197-124">Another reason to run tests for longer periods is to ensure that the system has gone through the initial warm/ramp up period where all caches are populated, database tables have reached expected counts and throttling is given sufficient time to kick in and regulate throughput once predefined thresholds are hit.</span></span> <span data-ttu-id="a4197-125">此方法将有助于发现最佳可承受吞吐量。</span><span class="sxs-lookup"><span data-stu-id="a4197-125">This approach will help discover optimal sustainable throughput.</span></span>  
  
-   <span data-ttu-id="a4197-126">测试参数： 它也是命令性不改变参数从运行要测试的测试运行的测试。</span><span class="sxs-lookup"><span data-stu-id="a4197-126">Test Parameters: It is also imperative to not vary test parameters from test run to test run.</span></span> <span data-ttu-id="a4197-127">例如，改变映射复杂性和/或文档大小可能产生不同的吞吐量和延迟结果。</span><span class="sxs-lookup"><span data-stu-id="a4197-127">For example, varying map complexity and/or document sizes can produce different throughput and latency results.</span></span>  
  
-   <span data-ttu-id="a4197-128">干净状态： 完成测试后很重要的所有状态在运行下一次测试前的都运行的清除。</span><span class="sxs-lookup"><span data-stu-id="a4197-128">Clean State: Once a test is complete it is important to cleanup all state before running the next test run.</span></span> <span data-ttu-id="a4197-129">例如，历史数据可能会在数据库中累积，从而影响运行时吞吐量。</span><span class="sxs-lookup"><span data-stu-id="a4197-129">For example, historical data can buildup in the database impacting runtime throughput.</span></span> <span data-ttu-id="a4197-130">回收服务实例有助于释放缓存的资源，例如内存、数据库连接和线程。</span><span class="sxs-lookup"><span data-stu-id="a4197-130">Recycling the service instances help to release cached resources like memory, database connections and threads.</span></span>  
  
## <a name="expectations-throughput-versus-latency"></a><span data-ttu-id="a4197-131">与滞后时间预期： 吞吐量</span><span class="sxs-lookup"><span data-stu-id="a4197-131">Expectations: Throughput versus Latency</span></span>  
 <span data-ttu-id="a4197-132">用户期望已部署系统中具备一定的吞吐量和/或具体的延迟时间顺理成章；</span><span class="sxs-lookup"><span data-stu-id="a4197-132">It is reasonable to expect a certain amount of throughput and/or latency from the deployed system.</span></span> <span data-ttu-id="a4197-133">但期望吞吐量很高、而延迟时间还很短，未免太得陇望蜀了。</span><span class="sxs-lookup"><span data-stu-id="a4197-133">Attempting to have both high throughput & low latency is like pulling in two different directions.</span></span> <span data-ttu-id="a4197-134">不过，期望获得最佳吞吐量且具有合理的延迟时间却切实可行。</span><span class="sxs-lookup"><span data-stu-id="a4197-134">However it is realistic to expect optimal throughput with reasonable latency.</span></span> <span data-ttu-id="a4197-135">随着吞吐量的增加，系统也面临越来越高的压力（更高的 CPU 消耗量、更多的磁盘 IO 争用、内存压力、更多的锁定争用），这些压力可能导致对延迟时间造成负面影响。</span><span class="sxs-lookup"><span data-stu-id="a4197-135">As throughput improves increased stress (higher CPU consumption, higher disk-IO contention, memory pressure, greater lock contention) is placed on the system which can have a negative impact on latency.</span></span> <span data-ttu-id="a4197-136">若要发现最佳系统容量，必须找到并缓解所有瓶颈。</span><span class="sxs-lookup"><span data-stu-id="a4197-136">To discover optimal capacity of a system it is imperative to identify and alleviate any and all bottlenecks.</span></span>  
  
 <span data-ttu-id="a4197-137">在未清除的数据库中驻留的旧数据（已完成实例）可能会导致瓶颈。出现此瓶颈时，性能可能会下降。</span><span class="sxs-lookup"><span data-stu-id="a4197-137">Bottlenecks can be caused by legacy data (completed instances) residing in the database not cleaned out. When this occurs performance can degrade.</span></span> <span data-ttu-id="a4197-138">给予系统充足的清空时间可能有助于缓解此问题。</span><span class="sxs-lookup"><span data-stu-id="a4197-138">Giving the system sufficient time to drain can help alleviate the problem.</span></span> <span data-ttu-id="a4197-139">但是，发现导致积压累积的原因并帮助缓解这一问题十分重要。</span><span class="sxs-lookup"><span data-stu-id="a4197-139">However, discovering the cause of the backlog buildup and helping alleviate the issue is important.</span></span>  
  
 <span data-ttu-id="a4197-140">为了发现积压的原因，一定要分析历史数据和监视性能监视器计数器（为了发现使用方案和诊断积压的根源）。</span><span class="sxs-lookup"><span data-stu-id="a4197-140">To discover the cause of the backlog, it is important to analyze historical data, monitor Performance Monitor counters (to discover usage patterns, and diagnose the source of the backlog).</span></span> <span data-ttu-id="a4197-141">会出现积压的常见情形是：在每晚以批处理方式处理大量数据时。</span><span class="sxs-lookup"><span data-stu-id="a4197-141">This is a common situation where large volumes of data are processed in a batched manner on a nightly basis.</span></span> <span data-ttu-id="a4197-142">通过发现系统容量以及能否从积压中恢复，可有助于评估处理过载情况的硬件要求以及在系统为处理意外吞吐量突增而留出的缓冲空间量。</span><span class="sxs-lookup"><span data-stu-id="a4197-142">Discovering the capacity of the system and its ability to recover from a backlog can be useful in estimating hardware requirements for handling overdrive scenarios and the amount of buffer room to accommodate within a system to handle unforeseen spikes in throughput.</span></span>  
  
 <span data-ttu-id="a4197-143">优化系统以获得最佳可承受吞吐量要求用户深入理解要部署的应用程序、系统的优缺点以及特定情况下的使用模式。</span><span class="sxs-lookup"><span data-stu-id="a4197-143">Tuning the system for optimal sustainable throughput requires an in depth understanding of the application being deployed, the strengths and weaknesses of the system and usage patterns of the specific scenario.</span></span> <span data-ttu-id="a4197-144">发现瓶颈和准确预测最佳可承受吞吐量的唯一方式就是通过对非常契合生产中使用情况的拓扑结构进行全面测试。</span><span class="sxs-lookup"><span data-stu-id="a4197-144">The only way to discover bottlenecks and predict optimal sustainable throughput with certainty is through thorough testing on a topology that closely matches what will be used in production.</span></span>  
  
 <span data-ttu-id="a4197-145">本部分中的其他主题引导您完成定义该拓扑结构的过程，并且提供有关如何缓解瓶颈和从一开始就避免瓶颈的指南。</span><span class="sxs-lookup"><span data-stu-id="a4197-145">Other topics in this section guides you through the process of defining that topology, and provides guidance on how to alleviate bottlenecks and hopefully help to avoid bottlenecks in the first place.</span></span>  
  
## <a name="scaling"></a><span data-ttu-id="a4197-146">缩放</span><span class="sxs-lookup"><span data-stu-id="a4197-146">Scaling</span></span>  
 <span data-ttu-id="a4197-147">在部署的拓扑结构的各个阶段都可能发生瓶颈。</span><span class="sxs-lookup"><span data-stu-id="a4197-147">Bottlenecks can occur at various stages of the deployed topology.</span></span> <span data-ttu-id="a4197-148">某些瓶颈可通过升级硬件得以缓解。</span><span class="sxs-lookup"><span data-stu-id="a4197-148">Some bottlenecks can be addressed by upgrading hardware.</span></span> <span data-ttu-id="a4197-149">可通过向上扩展（更多的 CPU、内存或缓存）或向外扩展（更多的服务器）对硬件进行升级。</span><span class="sxs-lookup"><span data-stu-id="a4197-149">Hardware can be upgraded either by scaling-up (more CPU’s, memory or cache) or by scaling-out (additional servers).</span></span> <span data-ttu-id="a4197-150">是向上扩展还是向外扩展取决于所遇到的瓶颈类型和要配置的应用程序。</span><span class="sxs-lookup"><span data-stu-id="a4197-150">The decision to scale up/out depends on the type of bottleneck encountered and the application being configured.</span></span> <span data-ttu-id="a4197-151">以下内容介绍如何基于遇到的瓶颈更改硬件部署的拓扑结构。</span><span class="sxs-lookup"><span data-stu-id="a4197-151">The following will help with guidance on how to change hardware deployment topologies based on bottlenecks encountered.</span></span> <span data-ttu-id="a4197-152">应用程序需要从头创建，以便能够利用向上扩展/向外扩展。例如：</span><span class="sxs-lookup"><span data-stu-id="a4197-152">An application needs to be built from the ground up to be capable of taking advantage of scaling up/out. For example:</span></span>  
  
-   <span data-ttu-id="a4197-153">如果应用程序是序列化的并且依赖于单个线程执行，则通过增加 CPU 和/或内存的向上扩展服务器可能不会有助于缓解这一问题。</span><span class="sxs-lookup"><span data-stu-id="a4197-153">Scaling up a server with additional CPU’s and/or memory may not help alleviate the problem if the application is serialized and dependent on a single thread of execution.</span></span>  
  
-   <span data-ttu-id="a4197-154">如果更多服务器只会加重对无法扩展的公共资源的争用情况，则使用更多服务器的向外扩展可能起不到帮助作用。</span><span class="sxs-lookup"><span data-stu-id="a4197-154">Scaling out a system with additional servers may not help if the additional servers simply add contention on a common resource that cannot be scaled.</span></span> <span data-ttu-id="a4197-155">不过，向外扩展还另有好处。</span><span class="sxs-lookup"><span data-stu-id="a4197-155">However, scaling-out provides additional benefits.</span></span> <span data-ttu-id="a4197-156">部署两个双处理器服务器而不是一个四处理器服务器可有助于提供冗余的服务器，起到处理增加的吞吐量并提供高度可用拓扑结构的双重扩展作用。</span><span class="sxs-lookup"><span data-stu-id="a4197-156">Deploying two dual-proc servers instead of one quad-proc server helps provide a redundant server that serves the dual purpose of scaling to handle additional throughput and provides a highly available topology.</span></span>