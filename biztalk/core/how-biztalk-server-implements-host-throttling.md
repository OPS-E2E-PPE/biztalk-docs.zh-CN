---
title: BizTalk Server 如何实现主机阻止 |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
helpviewer_keywords:
- host throttling, rate based throttling
- host throttling, outbound
- host throttling, algorithm
- host throttling, components
- host throttling, inbound
- host throttling, resource based throttling
- host throttling, user controlled throttling
- host throttling, strategies
ms.assetid: 46d3c3de-66b9-4c8a-8369-e68563fc9c40
caps.latest.revision: 27
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 659e4f9db894a9a822d50b1a5e0bc2a7e2850dcb
ms.sourcegitcommit: 381e83d43796a345488d54b3f7413e11d56ad7be
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/07/2019
ms.locfileid: "65387514"
---
# <a name="how-biztalk-server-implements-host-throttling"></a>BizTalk Server 如何实现主机阻止
[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]主机阻止机制不断监视阻止条件，计算阻止条件的严重性和应用主机阻止以渐进方式具体取决于计算出的严重性。 该阻止机制具有自我优化和默认配置选项都适用于大多数[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]处理方案。 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 主机阻止公开可用于优化限制为特定方案的多个可配置选项。 有关更改这些配置选项的信息，请参阅[如何修改主机设置](../core/how-to-modify-host-settings.md)。  

## <a name="components-of-the-host-throttling-algorithm"></a>主机阻止算法的组件  
 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 应用主机阻止时，请使用以下算法：  

1.  持续监视以下参数以确定它们是否超出特定阈值。 如果参数的值超出该参数的阈值则存在阻止条件。  

    -   使用 （系统范围内和进程内存的主机） 的内存量。  

    -   进程内消息数要送达或处理 （出站阻止阈值）。  

    -   使用中的线程数。  

    -   数据库大小、 的队列表中的项目数来度量为所有主机和后台处理和跟踪表中的项的数目。  

    -   并行数据库连接数。  

    -   消息发布 （入站） 速率和传送或处理 （出站）。  

2.  确定阻止条件的严重性。 阻止条件按严重性，如下所示 （从最严重到最不严重） 排列。  

    -   在使用中的主机进程内存超出阈值。  

    -   进程内消息数超出了阈值。  

    -   使用的线程数超出阈值。  

    -   数据库大小超过了阈值。  

    -   所有其他限制条件。  

3.  以渐进方式应用基于阻止条件的严重性。 严重性级别提升为更主动的方式应用阻止。 渐进式阻止的实现，如下所示：  

    -   一个或多个阻止条件检测，并分配的严重性。  

    -   基于具有最高严重级别的条件发出实现阻止的指令。 根据阻止条件，如果问题仍然存在，可能会降低各种线程池的大小，并且可能会通过冻结正在运行的业务流程释放内存。  

    -   在发布或处理消息，具体取决于消息是入站或出站时应用延迟。 延迟时间是阻止条件的严重性成正比，因此阻止条件的严重性较高将启动更长的阻止时间长于阻止条件的严重性较低。 根据条件更改，此延迟时间一定范围内向上和向下调整阻止机制。 通过公开当前延迟时间**消息传递的延迟 (ms)** 并**消息发布延迟 (ms)** 与关联的性能计数器**biztalk: Message Agent**性能对象类别。 主题中介绍了这些性能对象计数器[主机阻止性能计数器](../core/host-throttling-performance-counters.md)。  

    -   该阻止机制继续检查是否存在阻止条件。 如果阻止条件得以缓解阻止的消息的未被阻止，并允许线程池和其他资源在不受限制的模式下操作。 如果系统继续运行而无需任何阻止条件，大大降低延迟时间。 如果阻止条件持续存在，则延迟时间条件的严重性按比例递增，并随后的消息可能会有所延迟较长。  

    -   在延迟期过后将不再实现限制。  

## <a name="type-of-throttling-conditions"></a>阻止条件的类型  
 有三种主要类型的阻止条件： 基于速率的、 基于资源和业务流程。  

1. **基于速率的阻止**分为两类; 入站 （发布） 和出站 （送达）：  

   - 对于入站 （已发布的） 消息，BizTalk Server 将阻止消息发布而如果**消息发布传入速率**主机实例超出**消息发布传出速率\\*** 指定**加速因子 （百分比）** 值。 **加速因子 （百分比）** 参数是可在配置**消息发布阻止设置**对话框。 基于速率的阻止入站消息的主要通过将消息成批发布到 MessageBox 数据库之前引入延迟。 不执行任何其他操作来实现对入站消息进行基于速率的阻止。  

   - 对于出站 （送达的） 消息，BizTalk Server 将阻止的消息如果**消息送达传入速率**主机实例超出**消息送达传出速率** \*指定**加速因子 （百分比）** 值。 **加速因子 （百分比）** 参数是可在配置**消息处理阻止设置**对话框。 基于速率的出站消息阻止功能主要通过将引入从内存中队列中删除消息并将消息送达端点管理器 (EPM) 或业务流程引擎进行处理之前延迟。 不执行任何其他操作来实现对出站消息进行基于速率的阻止。  

      有关加速因子和其他基于速率的阻止值的详细信息，请参阅[如何修改速率基于阻止设置](../core/how-to-modify-rate-based-throttling-settings.md)。  

2. **基于资源的阻止**监视系统资源，例如线程、 内存和数据库大小，并可以应用于任何服务类。 有关基于资源的阻止值的详细信息，请参阅[如何修改资源基于阻止设置](../core/how-to-modify-resource-based-throttling-settings.md)。  

3. **业务流程阻止**可防止冻结以及确定何时暂停/恢复订阅。 有关业务流程阻止值的详细信息，请参阅[如何修改业务流程阻止设置](../core/how-to-modify-orchestration-throttling-settings.md)。  

## <a name="throttling-condition-triggers-actions-and-mitigation-strategies"></a>阻止条件触发器、 操作和缓解策略  
 本部分介绍各种阻止条件触发器、 生成的阻止机制和技术的措施来缓解阻止条件的操作。  

### <a name="inbound-throttling"></a>入站阻止  
 BizTalk 阻止机制应用入站阻止对业务流程引擎 (XLANG) 和入站适配器。  

 使用**消息发布阻止状态**并**消息发布阻止状态持续时间**与关联的计数器**biztalk: Messageagent**性能对象类别来测量当前阻止状态和阻止持续时间。 有关可用的主机阻止性能计数器的详细信息，请参阅[主机阻止性能计数器](../core/host-throttling-performance-counters.md)。  

 入站阻止可导致入站的消息在源积压。 如果入站阻止功能应用于接收适配器接收适配器可能会停止接收消息，直到阻止条件得以缓解。  


| 消息发布<br /><br /> 限制状态 |                                                                                                                                                                                                                                                  阻止条件的触发器                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                        采取的阻止操作                                                                                                                                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                 缓解策略                                                                                                                                                                                                                                                                                                                                                                                                  |                                                 性能对象                                                  |                                                                                                                                性能计数器                                                                                                                                 |
|-------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|                        2                        |                                                                                                                                                   **消息发布传入速率**实例的主机超过**消息发布传出速率\\** \*指定**加速因子 （百分比）** 值。 数据库不能跟上发布的速率。                                                                                                                                                   |                                                                                                                                                                                 阻止发布线程，直到在动态计算出的时间段内**Message Publishing Incoming Rate**是，这等同于**Message Publishing Outgoing Rate** \*指定的**加速因子 （百分比）** 值。                                                                                                                                                                                  |                                                                                                                                                  使用性能计数器来确定消息发布传入消息发布传出速率。 请考虑您的环境相应因子。<br /><br /> 验证是否为提供的值**取样时段**并**最小样本数**参数是适用于你的方案。<br /><br /> 有关这些参数的详细信息，请参阅[如何修改速率基于阻止设置](../core/how-to-modify-rate-based-throttling-settings.md)。                                                                                                                                                   |                                                BizTalk:MessageAgent                                                 |                                                                                                   消息发布传入速率<br /><br /> 消息发布传出速率                                                                                                    |
|                        4                        |                                                                                                                                                                         进程内存超出指定的阈值。<br /><br /> 发生这种情况要发布的批处理具有很高的内存要求或过多的线程所处理的消息                                                                                                                                                                          | 减少由 EPM 线程池的大小。<br /><br /> 阻止 EPM 线程以防止处理新的消息批。<br /><br /> 如果有很高的内存要求将保存到数据库的一批中的消息，对发布线程还渐进式延迟之前会将消息保存到数据库。<br /><br /> 是否将阻止发布批或出于进程内存不足的情况取决于许多因素，包括批中的消息或是否存在冻结或消息删除命令批处理中的数字。 |                                                                                                                                                                                   请考虑通过减少 EPM 线程池，和/或适配器批的大小来降低负荷量。<br /><br /> 如果进程并未占用过多的内存，请考虑增大**进程虚拟**主机的阈值。<br /><br /> 有关更改的详细信息**进程虚拟**值，请参阅[如何修改资源基于阻止设置](../core/how-to-modify-resource-based-throttling-settings.md)。                                                                                                                                                                                    |                                                BizTalk:MessageAgent                                                 |                                                                                     高进程内存<br /><br /> 进程内存使用率 (MB)<br /><br /> 进程内存使用情况阈值 (MB)                                                                                      |
|                        6                        | 承载消息队列大小、 后台处理表大小或跟踪表大小超过指定的阈值。<br /><br /> 这种情况的可能原因包括：<br /><br /> SQL 代理作业 BizTalk Server 用于维护 BizTalk Server 数据库未运行或运行速度变慢。<br />-下游组件未及时处理来自内存中队列的消息。<br />-挂起的消息数太多。<br />的已达到最大可承受负载的系统。 |                                                                                                                                                                      减少由 EPM 线程池的大小。<br /><br /> 阻止 EPM 线程以防止处理新的消息批。<br /><br /> 对发布线程还渐进式延迟之前会将消息保存到数据库。                                                                                                                                                                      | 请确保 SQL 代理作业 BizTalk Server 用于维护 BizTalk Server 数据库正在运行且没有故障。<br /><br /> 终止，并根据需要恢复挂起的实例。<br /><br /> 增加的默认值为**DB 中的消息数**考虑承载 BizTalk 数据库的 SQL server 的空间要求的阈值。<br /><br /> 如果你的数据库适当地设置大小，以处理其他消息积压，请考虑增大**后台乘数**并**跟踪数据乘数**值，以允许更多的积压在假脱机和跟踪表。<br /><br /> 有关更改这些值的详细信息，请参阅[如何修改资源基于阻止设置](../core/how-to-modify-resource-based-throttling-settings.md)。 | BizTalk:MessageAgent<br /><br /> Biztalk: Message Box: General Counters<br /><br /> Biztalk: Message Box: Host Counters | MessageAgent /Database 大小<br /><br /> 消息框： 常规计数器 /Spool 大小<br /><br /> 消息框： 常规计数器 /Tracking 数据大小<br /><br /> 消息框： 主机计数器/主机队列-长度<br /><br /> 消息框： 主机计数器/主机队列-挂起的消息-长度 |
|                        8                        |                                                                                                                                                                                                                         主机实例正在使用的数据库会话超过指定的阈值。                                                                                                                                                                                                                          |                                                                                                                                                                      减少由 EPM 线程池的大小。<br /><br /> 阻止 EPM 线程以防止处理新的消息批。<br /><br /> 对发布线程还渐进式延迟之前会将消息保存到数据库。                                                                                                                                                                      |                                                                                                                                                                                                                                                                                请考虑增大**数据库连接**主机的阈值。<br /><br /> 更改此值的详细信息，请参阅[如何修改资源基于阻止设置](../core/how-to-modify-resource-based-throttling-settings.md)。                                                                                                                                                                                                                                                                                |                                                BizTalk:MessageAgent                                                 |                                                                                                                                  数据库会话                                                                                                                                  |
|                        9                        |                                                                                                                                                                                                                                       进程线程数超出指定的阈值。                                                                                                                                                                                                                                        |                                                                                                                                                                      减少由 EPM 线程池的大小。<br /><br /> 阻止 EPM 线程以防止处理新的消息批。<br /><br /> 对发布线程还渐进式延迟之前会将消息保存到数据库。                                                                                                                                                                      |                                                                                                                                                                                                         请考虑调整不同线程池大小，以确保系统不会创建大量的线程。<br /><br /> 有关修改线程池大小的详细信息，请参阅[如何修改常规设置](../core/how-to-modify-general-settings.md)并[如何修改资源基于阻止设置](../core/how-to-modify-resource-based-throttling-settings.md)。                                                                                                                                                                                                         |                                                BizTalk:MessageAgent                                                 |                                                                                                                  线程计数<br /><br /> 线程计数阈值                                                                                                                   |
|                        5                        |                                                                                                                                                                                                                                           系统内存超出指定的阈值。                                                                                                                                                                                                                                           | 减少由 EPM 线程池的大小。<br /><br /> 阻止 EPM 线程以防止处理新的消息批。<br /><br /> 如果有很高的内存要求将保存到数据库的一批中的消息，对发布线程还渐进式延迟之前会将消息保存到数据库。<br /><br /> 是否将阻止发布批或出于进程内存不足的情况取决于许多因素，包括批中的消息或是否存在冻结或消息删除命令批处理中的数字。 |                                                                                                                                                                                请考虑通过减少 EPM 线程池的默认大小和/或适配器批的大小来减少负载。<br /><br /> 如果进程并未占用过多的内存，请考虑增大**全局物理**主机的阈值。<br /><br /> 有关更改的详细信息**全局物理**阈值，请参阅[如何修改资源基于阻止设置](../core/how-to-modify-resource-based-throttling-settings.md)。                                                                                                                                                                                |                                                BizTalk:MessageAgent                                                 |                                                                                                    物理内存使用率 (MB)<br /><br /> 物理内存使用情况阈值 (MB)                                                                                                     |

### <a name="outbound-throttling"></a>出站阻止  
 BizTalk 阻止机制应用出站阻止对业务流程引擎 (XLANG) 和出站适配器。  

 使用**消息传递限制状态**并**限制状态持续时间的消息传递**与关联的计数器**biztalk: Messageagent**性能对象类别来测量当前阻止状态和阻止持续时间。 有关可用的主机阻止性能计数器请参阅[主机阻止性能计数器](../core/host-throttling-performance-counters.md)。  

 出站阻止功能可能会导致延迟的消息传递和消息可能会生成内存中队列中并可能导致出列线程被阻止，直到阻止条件得以缓解。 当出列线程被阻止任何额外的消息从 MessageBox 中提取到的内存中队列的出站送达。  


| 消息传递<br /><br /> 限制状态 |                                                                                                                                    阻止条件的触发器                                                                                                                                     |                                                                                                                                                   采取的阻止操作                                                                                                                                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                缓解策略                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |  性能对象  |                                                                               性能计数器                                                                               |
|-----------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|                       1                       | **消息送达传入速率**实例的主机超过**消息送达传出速率\\**  \*指定**加速因子 （百分比）** 值<br /><br /> 这可能引起高处理复杂性、 出站适配器速度缓慢或系统资源出现暂时短缺。 |                                                 直到 Message delivery incoming rate 等于这等同于在动态计算出的时间段内阻止送达线程**消息送达传出速率\\**  \*指定**速率加速因子 （百分比）** 值。                                                 |                                                                                                                                                                                                                                                  使用性能计数器来确定消息送达传入和传出速率的消息传递。 通过为您的环境的驱动器身份，请考虑适当。<br /><br /> 验证是否为提供的值**取样时段**并**最小样本数**参数是适用于你的方案。<br /><br /> 有关这些参数的详细信息，请参阅[如何修改速率基于阻止设置](../core/how-to-modify-rate-based-throttling-settings.md)。                                                                                                                                                                                                                                                   | BizTalk:MessageAgent |                                                   消息送达传入速率<br /><br /> 消息发布传出速率                                                   |
|                       4                       |                             进程内存超出指定的阈值。<br /><br /> 这在内存密集型处理方案中，处理大消息时或发生时发送适配器尝试同时处理大量消息。                              | 消息传递到适配器或 XLANG 变慢。<br /><br /> 降低进程内存占用，通过冻结服务实例和缩减缓存时适用。<br /><br /> 减少由 EPM 和/或消息代理使用的线程池大小。<br /><br /> 定期强制执行.NET 垃圾回收 (GC)。 | 如果系统不成为进程基于内存的阻止功能而进入空闲状态，可能不需要执行任何操作。<br /><br /> 如果**进程内消息计数**计数器值较高和 CPU 使用率不是过多，即使没有基于进程内存的限制，可能需要执行任何其他操作。<br /><br /> 如果系统表现为过度阻止，请考虑增大与关联的值**进程虚拟**主机的阈值，并验证主机实例不会生成"内存不足"错误。 如果通过增加引发"内存不足"错误**进程虚拟**阈值，请考虑减小的值**内部消息队列大小**和**进程内消息数**阈值。 此策略是特别适用于大型消息处理方案。<br /><br /> 有关这些参数的详细信息，请参阅[如何修改资源基于阻止设置](../core/how-to-modify-resource-based-throttling-settings.md)。 | BizTalk:MessageAgent | 高进程内存<br /><br /> 进程内存 usage(MB)<br /><br /> 进程内存使用情况阈值 (MB)<br /><br /> 进程内消息计数<br /><br /> 活动的实例计数 |
|                       3                       |                                     送达服务类别的进程内消息数超出指定的阈值。<br /><br /> 这可能引起高处理复杂性、 出站适配器速度缓慢或系统资源出现暂时短缺。                                      |                                                                                                  消息传递到适配器或 XLANG 变慢。<br /><br /> 减少由消息代理使用的线程池大小。                                                                                                   |                                                                                                                                                                                                                                                                                            如果出现过度阻止情况，请考虑增大与关联的值**进程内消息数**阈值。<br /><br /> 有关此参数的详细信息，请参阅[如何修改资源基于阻止设置](../core/how-to-modify-resource-based-throttling-settings.md)**注意：** 增加此值可能会产生负面影响发送适配器的性能和/或提高进程的内存使用率。                                                                                                                                                                                                                                                                                             | BizTalk:MessageAgent |                                                     进程内消息计数<br /><br /> 进程内消息计数阈值                                                     |
|                       9                       |                                                                                                                          进程线程数超出指定的阈值。                                                                                                                          |                                                                                                                         减少由 EPM 和/或消息代理使用的线程池大小                                                                                                                          |                                                                                                                                                                                                                                                                                                       请考虑调整不同线程池大小，以确保系统不会创建大量的线程。<br /><br /> 有关修改线程池大小的详细信息，请参阅[如何修改常规设置](../core/how-to-modify-general-settings.md)并[如何修改资源基于阻止设置](../core/how-to-modify-resource-based-throttling-settings.md)。                                                                                                                                                                                                                                                                                                        | BizTalk:MessageAgent |                                                                 线程计数<br /><br /> 线程计数阈值                                                                 |
|                       5                       |                                                                                                                                   系统内存超出阈值。                                                                                                                                    |                                消息传递到适配器或 XLANG 变慢。<br /><br /> 降低进程内存占用，通过冻结服务实例和缩减缓存时适用。<br /><br /> 减少由 EPM 和/或消息代理使用的线程池大小。                                 |                                                                                                                                                                                                                                                                             请考虑通过减少 EPM 线程池的默认大小和/或适配器批的大小来减少负载。<br /><br /> 如果进程并未占用过多的内存，请考虑增大**全局物理**主机的阈值。<br /><br /> 有关更改的详细信息**全局物理**阈值，请参阅[如何修改资源基于阻止设置](../core/how-to-modify-resource-based-throttling-settings.md)。                                                                                                                                                                                                                                                                             | BizTalk:MessageAgent |                                                                           物理内存使用率 (MB)                                                                            |

