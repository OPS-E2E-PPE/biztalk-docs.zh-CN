---
title: "引擎持久性和持久性 |Microsoft 文档"
ms.custom: 
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: 9bd209e9-75d2-422f-b3b2-377986f41f2f
caps.latest.revision: "7"
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 13f9f3f1a02ddfe84a963704476e867783f31042
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/20/2017
---
# <a name="engine-persistence-and-durability"></a><span data-ttu-id="6b0d4-102">引擎持久性和持久性</span><span class="sxs-lookup"><span data-stu-id="6b0d4-102">Engine Persistence and Durability</span></span>
<span data-ttu-id="6b0d4-103">本部分将介绍 BizTalk Server 如何通过利用 SQL Server 将流程状态保存到磁盘上来可靠地集成松散连接的业务流程。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-103">This section explains how BizTalk Server reliably integrates loosely coupled business processes by persisting process state to disk via SQL Server.</span></span> <span data-ttu-id="6b0d4-104">通过利用事务以适当的次数保存状态，系统可以保证即使在硬件或软件发生故障的情况下也不会丢失任何流程状态。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-104">By persisting state at appropriate times, leveraging transactions, the system guarantees that no process state is lost even in the event of a hardware or software outage.</span></span> <span data-ttu-id="6b0d4-105">这称为系统持久性。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-105">This is referred to as system durability.</span></span>  
  
## <a name="loosely-coupled-business-process-management"></a><span data-ttu-id="6b0d4-106">松散耦合的业务流程管理</span><span class="sxs-lookup"><span data-stu-id="6b0d4-106">Loosely Coupled Business Process Management</span></span>  
 <span data-ttu-id="6b0d4-107">集成现有系统以执行单个逻辑业务流程需要在现有系统外对流程状态进行管理。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-107">Integrating existing systems to perform a single logical business process requires management of process state outside of the existing systems.</span></span> <span data-ttu-id="6b0d4-108">为了避免由于将系统紧密连接在一起而导致自定义通信路径公开，无论是长期运行的还是生命期短的业务流程，都必须独立维护其流程状态。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-108">Whether the business process is long running or short lived, process state must be maintained independently in order to avoid the explosion of custom communications paths that result from tightly coupling systems together.</span></span>  
  
 <span data-ttu-id="6b0d4-109">显然，如果业务流程非常关键，则运行业务流程实例的状态必须十分可靠。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-109">Clearly, the state of a running business process instance must be reliable if the business process is mission critical.</span></span> <span data-ttu-id="6b0d4-110">为确保业务流程具有可靠性和持久性，BizTalk 利用 SQL Server 事务将流程状态和业务数据保存到磁盘上称为 MessageBox 数据库的数据库中。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-110">To assure that business processes are reliable and durable, BizTalk leverages SQL Server transactions to persist process state and business data to disk in a database known as the MessageBox database.</span></span> <span data-ttu-id="6b0d4-111">MessageBox 数据库有关的详细信息，请参阅[MessageBox 数据库](../core/the-messagebox-database.md)。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-111">For more information about the MessageBox database, see [The MessageBox Database](../core/the-messagebox-database.md).</span></span>  
  
 <span data-ttu-id="6b0d4-112">在处理期间，至少会将 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 中的每个消息以及几乎最细微的业务程序实例（例如，业务流程实例）保存到 MessageBox 数据库中一次。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-112">Every message and all but the most trivial business process instances (for example, orchestration instances) in [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] are persisted in the MessageBox database at least once during processing.</span></span>  
  
## <a name="persistence-and-sustainability"></a><span data-ttu-id="6b0d4-113">持久性和可持续性</span><span class="sxs-lookup"><span data-stu-id="6b0d4-113">Persistence and Sustainability</span></span>  
 <span data-ttu-id="6b0d4-114">BizTalk Server 仍然存在的所有消息，大多数的业务流程的事实将直接影响对中所述的可持续性[什么是可持续的性能？](../core/what-is-sustainable-performance.md)</span><span class="sxs-lookup"><span data-stu-id="6b0d4-114">The fact that BizTalk Server persists all messages and most orchestrations has a direct affect on sustainability as noted in [What Is Sustainable Performance?](../core/what-is-sustainable-performance.md)</span></span> <span data-ttu-id="6b0d4-115">当消息到达 MessageBox 数据库中时，它们是路由到等待订阅者 （例如，业务流程和发送端口） 和 en-排入队列，或已发布到 messagebox SQL 表等待订户中选取它们，并处理它们。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-115">As messages arrive in the MessageBox database, they are routed to waiting subscribers (for example, orchestrations and send ports) and en-queued, or published, into messagebox SQL tables to wait for subscribers to pick them up and process them.</span></span> <span data-ttu-id="6b0d4-116">其中某些到达的消息将激活新的订户实例。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-116">Some of the arriving messages activate new subscriber instances.</span></span> <span data-ttu-id="6b0d4-117">其他到达的消息则通过相关路由到已在运行的订户（例如，相关业务流程）的等待实例。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-117">Other messages arrive and are routed, via correlation, to a waiting instance of an already running subscriber such as a correlated orchestration.</span></span>  
  
 <span data-ttu-id="6b0d4-118">为使相关业务流程继续进行处理，到达的相关消息必须保持未阻塞状态。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-118">In order for correlated orchestrations to continue processing, arriving correlated messages must remain un-blocked.</span></span> <span data-ttu-id="6b0d4-119">为实现此条件，BizTalk 将尽力确保即使在高负载情况下也会继续接收激活和相关的消息，以便等待相关消息的订户可以完成处理，并为要运行的其他流程留出空间。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-119">To facilitate this, BizTalk does its best to make sure messages (both activating and correlated) continue to be received, even under high load, so that subscribers waiting for correlated messages can finish and make room for more processes to run.</span></span> <span data-ttu-id="6b0d4-120">这意味着，接收消息的速度可能超过对其进行处理并将其从 MessageBox 数据库中删除的速度，从而产生消息积压。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-120">This means it is possible to receive messages faster than they can be processed and removed from the MessageBox database, thus building up a message backlog.</span></span> <span data-ttu-id="6b0d4-121">作为一项存储并转发技术，BizTalk 自身可以提供这种类型的缓冲，但是，如果接收速度长期持续超过处理速度，则会产生大量积压，而这将会导致问题。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-121">Being a store-and-forward technology, it is natural for BizTalk to provide this type of buffering, however, it can result in problems if the receive rate is consistently faster than the process rate indefinitely, resulting in a large backlog.</span></span>  
  
 <span data-ttu-id="6b0d4-122">BizTalk Server 所接收的或在其中创建的每个消息都是不可改变的。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-122">Every message that is received by, or created within, BizTalk Server is immutable.</span></span> <span data-ttu-id="6b0d4-123">也就是说，在接收或创建消息后，则无法更改其内容。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-123">That is, once it has been received or created, its content cannot be changed.</span></span> <span data-ttu-id="6b0d4-124">此外，接收的消息可能会有多个订户。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-124">In addition, received messages may have multiple subscribers.</span></span> <span data-ttu-id="6b0d4-125">特定消息的每个订户都引用该消息的同一个副本。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-125">Each subscriber of a particular message references the same, single copy of that message.</span></span> <span data-ttu-id="6b0d4-126">尽管此方法可以最大限度地减少存储，但仍必须保持每个消息的引用计数，并且必须定期执行维护以清除那些引用计数为 0 的消息。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-126">While this approach minimizes storage, a ref-count must be kept for each message and maintenance must be performed periodically to get rid of those messages that have a ref count of 0.</span></span>  
  
 <span data-ttu-id="6b0d4-127">如果允许在 MessageBox 数据库中产生足够大量的积压，则该数据库的维护进程（对于每个 MessageBox 数据库，该进程作为一组 SQL 作业实现）将会滞后，如果没有机会及时进行维护，则最终将导致磁盘空间不足等问题。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-127">If a large enough backlog is allowed to build up in the MessageBox database, the maintenance processes for the database (implemented as a set of SQL Jobs for each MessageBox database) will fall behind and, if not given an opportunity to catch up, will eventually cause issues such as running out of disk space.</span></span> <span data-ttu-id="6b0d4-128">为避免出现此情况，BizTalk Server 提供了一种阻止机制，该机制可以在 MessageBox 数据库积压达到用户可配置的某个级别时降低消息接收速度。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-128">To avoid this situation, BizTalk Server provides a throttling mechanism that slows down the message receive rate when the MessageBox database backlog gets to some user-configurable level.</span></span> <span data-ttu-id="6b0d4-129">有关限制的详细信息，请参阅[优化资源使用通过主机限制](../core/optimizing-resource-usage-through-host-throttling.md)。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-129">For more information about throttling, see [Optimizing Resource Usage Through Host Throttling](../core/optimizing-resource-usage-through-host-throttling.md).</span></span>  
  
 <span data-ttu-id="6b0d4-130">假定所有活动和流程都会影响可维持性，则对一段时间内可维持性的主要度量是不允许积压无限增长。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-130">Given all of the activities and processes that contribute to sustainability, the primary measure of sustainability over time is that a backlog is not allowed to grow indefinitely.</span></span> <span data-ttu-id="6b0d4-131">换而言之，在一段时间内，高低峰值吞吐量级别之间必须保持平衡，以便 MessageBox 数据库能够维护持续的易于管理的平均积压。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-131">In other words, over time, there must be a balance between the high and low peak throughput levels so that the MessageBox database is able to maintain a constant and manageable average backlog.</span></span> <span data-ttu-id="6b0d4-132">积压的主要度量是后台处理表的深度，该表作为名为 BizTalk:Message Box:General Counters:Spool Size 的 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 性能计数器公开。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-132">The primary measure of backlog is the depth of the spool table, which is exposed as a [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] performance counter called BizTalk:Message Box:General Counters:Spool Size.</span></span> <span data-ttu-id="6b0d4-133">有关此性能计数器的详细信息，请参阅[消息框性能计数器](../core/message-box-performance-counters.md)。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-133">For more information about this performance counter, see [Message Box Performance Counters](../core/message-box-performance-counters.md).</span></span>  
  
 <span data-ttu-id="6b0d4-134">有关如何使用假脱机大小和其他计数器来确定系统可以承受的最大吞吐量的详细信息，请参阅[测量最大可持续引擎吞吐量](../core/measuring-maximum-sustainable-engine-throughput.md)。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-134">For more information on how to use the spool size and other counters to determine the maximum throughput a system can sustain, see [Measuring Maximum Sustainable Engine Throughput](../core/measuring-maximum-sustainable-engine-throughput.md).</span></span>  
  
## <a name="recommendations"></a><span data-ttu-id="6b0d4-135">建议</span><span class="sxs-lookup"><span data-stu-id="6b0d4-135">Recommendations</span></span>  
 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]<span data-ttu-id="6b0d4-136"> 将保存所有消息和大多数业务流程，如果不进行限制，则会造成消息积压，从而导致磁盘空间不足等问题。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-136"> persists all messages and most orchestrations and can, left un-checked, develop a backlog of messages that can result in issues such as running out of disk space.</span></span> <span data-ttu-id="6b0d4-137">积压的主要度量是 MessageBox 后台处理表的深度，该表作为名为 BizTalk:Message Box:General Counters:Spool Size 的性能计数器公开。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-137">The primary measure of backlog is the depth of the messagebox spool table, which is exposed as a performance counter called: BizTalk:Message Box:General Counters:Spool Size.</span></span>  
  
 <span data-ttu-id="6b0d4-138">考虑可承受吞吐量时，后台处理大小必须在一段时间内维持稳定的平均值。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-138">When thinking about sustainable throughput, the spool size must sustain a stable average over time.</span></span> <span data-ttu-id="6b0d4-139">也就是说，后台处理不能继续不受限制地无限增长。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-139">That is, the spool cannot continue to grow un-checked indefinitely.</span></span> <span data-ttu-id="6b0d4-140">在[测量最大可持续引擎吞吐量](../core/measuring-maximum-sustainable-engine-throughput.md)、 此行为更详细地讨论和确定系统可以承受的最大吞吐量的方法提供它利用假脱机大小和其他性能指示器。</span><span class="sxs-lookup"><span data-stu-id="6b0d4-140">In [Measuring Maximum Sustainable Engine Throughput](../core/measuring-maximum-sustainable-engine-throughput.md), this behavior is discussed in more detail and a method of determining the maximum throughput a system can sustain is provided which leverages the spool size and other performance indicators.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="6b0d4-141">另请参阅</span><span class="sxs-lookup"><span data-stu-id="6b0d4-141">See Also</span></span>  
 <span data-ttu-id="6b0d4-142">[测量的最大可持续引擎吞吐量](../core/measuring-maximum-sustainable-engine-throughput.md) </span><span class="sxs-lookup"><span data-stu-id="6b0d4-142">[Measuring Maximum Sustainable Engine Throughput](../core/measuring-maximum-sustainable-engine-throughput.md) </span></span>  
 <span data-ttu-id="6b0d4-143">[什么是可持续的性能？](../core/what-is-sustainable-performance.md) </span><span class="sxs-lookup"><span data-stu-id="6b0d4-143">[What Is Sustainable Performance?](../core/what-is-sustainable-performance.md) </span></span>  
 <span data-ttu-id="6b0d4-144">[性能提示和技巧](../core/performance-tips-and-tricks.md) </span><span class="sxs-lookup"><span data-stu-id="6b0d4-144">[Performance Tips and Tricks](../core/performance-tips-and-tricks.md) </span></span>  
 [<span data-ttu-id="6b0d4-145">消息框性能计数器</span><span class="sxs-lookup"><span data-stu-id="6b0d4-145">Message Box Performance Counters</span></span>](../core/message-box-performance-counters.md)