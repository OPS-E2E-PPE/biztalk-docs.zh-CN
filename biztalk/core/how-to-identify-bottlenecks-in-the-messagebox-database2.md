---
title: 如何找出 MessageBox 数据库 2 的瓶颈 |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 10b2eb1e-541c-457d-9735-ac6fb069b209
caps.latest.revision: 7
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: ca799b6fc97262d1e7e3af4f4d73b09ca24eb444
ms.sourcegitcommit: 381e83d43796a345488d54b3f7413e11d56ad7be
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/07/2019
ms.locfileid: "65337168"
---
# <a name="how-to-identify-bottlenecks-in-the-messagebox-database"></a><span data-ttu-id="d370f-102">如何找出 MessageBox 数据库的瓶颈</span><span class="sxs-lookup"><span data-stu-id="d370f-102">How to Identify Bottlenecks in the MessageBox Database</span></span>
<span data-ttu-id="d370f-103">若要找出 MessageBox 数据库的瓶颈，首先要确保 SQL Server 代理服务已启动。</span><span class="sxs-lookup"><span data-stu-id="d370f-103">To identify bottlenecks in the MessageBox database, first ensure that the SQL-Server-Agent Service is started.</span></span> <span data-ttu-id="d370f-104">将服务的启动状态从“手动”改为“自动”，这样即使服务器重新启动了，服务也会自动重新启动。</span><span class="sxs-lookup"><span data-stu-id="d370f-104">Change the Service startup state from Manual to Auto so that even if the server is restarted, the service will automatically restart.</span></span>  
  
 <span data-ttu-id="d370f-105">默认情况下，如果 Spool、TrackingData 或 ApplicationQ 表增大了，则 BizTalk 服务将会限流。</span><span class="sxs-lookup"><span data-stu-id="d370f-105">By default the BizTalk service will throttle if the Spool, TrackingData or ApplicationQ tables grow.</span></span> <span data-ttu-id="d370f-106">SQL 代理作业会对这些表进行削减，如果不这样，将会引起 Spool 的增长，从而导致服务限流，以保护数据库免受更大压力。</span><span class="sxs-lookup"><span data-stu-id="d370f-106">These tables are pruned by SQL-Agent jobs, which, if not running will cause the Spool to grow causing throttling to kick in protecting the database from additional pressure.</span></span> <span data-ttu-id="d370f-107">检查下列性能计数器的状态：</span><span class="sxs-lookup"><span data-stu-id="d370f-107">Check the status of the following performance counters:</span></span>  
  
- <span data-ttu-id="d370f-108">BizTalk:Message Agent (Host Name) Message Delivery Throttling State</span><span class="sxs-lookup"><span data-stu-id="d370f-108">BizTalk:Message Agent (Host Name) Message Delivery Throttling State</span></span>  
  
- <span data-ttu-id="d370f-109">BizTalk:Message Agent (Host Name) Message Publishing Throttling State</span><span class="sxs-lookup"><span data-stu-id="d370f-109">BizTalk:Message Agent (Host Name) Message Publishing Throttling State</span></span>  
  
  <span data-ttu-id="d370f-110">值“0”表示没有发生限流。</span><span class="sxs-lookup"><span data-stu-id="d370f-110">A value of 0 indicates no throttling is occurring.</span></span> <span data-ttu-id="d370f-111">值“6”表示系统由于数据库增长而限流。</span><span class="sxs-lookup"><span data-stu-id="d370f-111">A value of 6 is indicative the system is throttling due to database growth.</span></span> <span data-ttu-id="d370f-112">有关如何解释这些计数器的其他值的信息，请参考有关文档。</span><span class="sxs-lookup"><span data-stu-id="d370f-112">Please refer to the documentation on how to interpret other values of these counters.</span></span>  
  
## <a name="spool-table-growth"></a><span data-ttu-id="d370f-113">Spool 表的增长</span><span class="sxs-lookup"><span data-stu-id="d370f-113">Spool Table Growth</span></span>  
 <span data-ttu-id="d370f-114">导致 Spool 增长的原因有多种。</span><span class="sxs-lookup"><span data-stu-id="d370f-114">The Spool can start growing for multiple reasons.</span></span> <span data-ttu-id="d370f-115">其中一个就是应用程序队列的增长。</span><span class="sxs-lookup"><span data-stu-id="d370f-115">One reason for Spool growth is if the application queues are growing.</span></span> <span data-ttu-id="d370f-116">其增长可能有多种原因，比如下游瓶颈和/或资源争夺。</span><span class="sxs-lookup"><span data-stu-id="d370f-116">They could grow due to various reasons like downstream bottlenecks and/or resource contention.</span></span>  
  
 <span data-ttu-id="d370f-117">如果应用程序队列很小，但 Spool 却很大，请检查清除作业的速度是否够快。</span><span class="sxs-lookup"><span data-stu-id="d370f-117">If the application queues are small and the Spool is still large, verify that the purge jobs are keeping up.</span></span> <span data-ttu-id="d370f-118">请确保 SQL 代理服务正在运行，然后验证下列作业是否成功完成：</span><span class="sxs-lookup"><span data-stu-id="d370f-118">Ensure that the SQL-Agent Service is running and then verify that the following jobs are successfully completing:</span></span>  
  
- <span data-ttu-id="d370f-119">MessageBox_Message_Cleanup_BizTalkMessageBoxDb</span><span class="sxs-lookup"><span data-stu-id="d370f-119">MessageBox_Message_Cleanup_BizTalkMessageBoxDb</span></span>  
  
- <span data-ttu-id="d370f-120">MessageBox_Parts_Cleanup_BizTalkMessageBoxDb</span><span class="sxs-lookup"><span data-stu-id="d370f-120">MessageBox_Parts_Cleanup_BizTalkMessageBoxDb</span></span>  
  
  <span data-ttu-id="d370f-121">如果 MessageZeroSum 表很大，说明消息已经处理完毕（DeQueue 已经成功完成，并已从应用程序队列表中删除了数据），也标记了要删除的行。</span><span class="sxs-lookup"><span data-stu-id="d370f-121">If the MessageZeroSum table is large it indicates that the messages have been processed (DeQueue has successfully completed and deleted data from the Application Queue tables) and the rows have been flagged for deletion.</span></span> <span data-ttu-id="d370f-122">但清除作业不能及时删除数据。</span><span class="sxs-lookup"><span data-stu-id="d370f-122">However, the purge jobs are unable to keep up with deleting the data.</span></span> <span data-ttu-id="d370f-123">导致这种情况的一个原因是，SQL Server 计算机的 CPU 资源争夺很激烈，CPU 资源的紧张影响了清除作业的能力，使其无法及时完成任务。</span><span class="sxs-lookup"><span data-stu-id="d370f-123">One reason for this is if the SQL-Server machine is experiencing severe CPU contention, impacting the ability of the purge jobs to keep up due to CPU starvation.</span></span>  
  
## <a name="application-queue-table-growth"></a><span data-ttu-id="d370f-124">应用程序队列表的增长</span><span class="sxs-lookup"><span data-stu-id="d370f-124">Application Queue Table Growth</span></span>  
 <span data-ttu-id="d370f-125">应用程序队列中等待处理的转换数据在处理后立即由 DeQueue 清除。</span><span class="sxs-lookup"><span data-stu-id="d370f-125">Application queues host in-flight transition data that, once processed, are cleaned up by DeQueue.</span></span>  
  
 <span data-ttu-id="d370f-126">处理完这些消息后，就可以清理 Spool（存有对这些行的引用）了。</span><span class="sxs-lookup"><span data-stu-id="d370f-126">After these messages are processed the Spool (holding references to these rows) can be cleaned.</span></span>  
  
 <span data-ttu-id="d370f-127">例如，RxHostQ 将数据发布到业务流程 PxHostQ，PxHostQ 又将这些数据发布到发送 TxHostQ，它们每个都在 Spool 表中引用一行。</span><span class="sxs-lookup"><span data-stu-id="d370f-127">For example, the RxHostQ publishes data to the orchestration PxHostQ which in turn publishes data to the sending TxHostQ each referencing a row in the Spool table.</span></span> <span data-ttu-id="d370f-128">系统成功处理完特定 HostQ 的消息后，DeQueue 会删除这些行。</span><span class="sxs-lookup"><span data-stu-id="d370f-128">After the messages for a particular HostQ have successfully processed through the system these rows are deleted by DeQueue.</span></span> <span data-ttu-id="d370f-129">删除这些行后，清除作业就可以清理 Spool（已不再被这些行引用）了。</span><span class="sxs-lookup"><span data-stu-id="d370f-129">After these rows are deleted, the Spool (which is no longer referenced by these rows) can then be cleaned by the purge jobs.</span></span>  
  
 <span data-ttu-id="d370f-130">应用程序队列的增长说明负责清理应用程序队列的主机实例已经跟不上传入速度了，传入速率是指向特定应用程序发布消息的速率。</span><span class="sxs-lookup"><span data-stu-id="d370f-130">Application Queue growth indicates that the Host Instances responsible for draining the Application Queue are unable to keep up with the incoming rate, that is, the rate at which messages are being published to the particular application queue.</span></span>  
  
 <span data-ttu-id="d370f-131">例如，由于负责处理业务流程的服务器争夺不到更多的 CPU 资源而无法加快处理速度，这就会导致业务流程应用程序队列 (PxHostQ) 增长。</span><span class="sxs-lookup"><span data-stu-id="d370f-131">For example, the orchestration application queue (PxHostQ) may grow because the server responsible for processing orchestrations is CPU bound and unable to process any faster.</span></span> <span data-ttu-id="d370f-132">此外，如果接收服务器的速度很快，它的发布速度比业务流程服务器的处理速度快，也会导致应用程序队列增长。</span><span class="sxs-lookup"><span data-stu-id="d370f-132">However, if the receiving server is fast it may publish faster than what the orchestration server can process leading to the application queue growth.</span></span>  
  
 <span data-ttu-id="d370f-133">另一个导致业务流程队列增长的原因是内存争用，如果有大量长时间运行的业务流程实例同时实例化到内存中，将会导致内存膨胀，从而间接引发限流，压缩线程池，直到内存压力缓解为止。</span><span class="sxs-lookup"><span data-stu-id="d370f-133">Another reason for orchestration queue growth could be due to memory contention whereby numerous long running orchestration instances are all concurrently instantiated in memory, causing memory bloat indirectly causing throttling to shrink the thread pool until memory pressure is relieved.</span></span> <span data-ttu-id="d370f-134">导致应用程序发送队列增长的一个原因是下游系统接收消息（从 BizTalk 传出）的速度不够快。</span><span class="sxs-lookup"><span data-stu-id="d370f-134">One reason why the send application queue may grow is if the downstream system is unable to receive (outgoing from BizTalk) messages fast enough.</span></span> <span data-ttu-id="d370f-135">因此，消息将持续驻留在 BizTalk 系统中，导致应用程序队列增长，最终引起系统限流，降低接收速率，影响系统的整体吞吐量。</span><span class="sxs-lookup"><span data-stu-id="d370f-135">Thus the messages will continue to reside within the BizTalk system causing Application queue growth which will ultimately cause throttling to kick in reducing the receiving rate impacting the overall throughput of the system.</span></span>  
  
## <a name="trackingdata-table-growth"></a><span data-ttu-id="d370f-136">TrackingData 表的增长</span><span class="sxs-lookup"><span data-stu-id="d370f-136">TrackingData Table Growth</span></span>  
 <span data-ttu-id="d370f-137">MessageBox 数据库中的 TrackingData 表是一个转换表，侦听器会将消息和服务实例跟踪及 BAM 跟踪的跟踪数据写入该表。</span><span class="sxs-lookup"><span data-stu-id="d370f-137">The TrackingData table in the MessageBox database is a transition table into which interceptors write tracking data for both message and service instance tracking and BAM tracking.</span></span> <span data-ttu-id="d370f-138">如果禁用跟踪，则此表将为空。</span><span class="sxs-lookup"><span data-stu-id="d370f-138">If tracking is disabled, this table should be empty.</span></span> <span data-ttu-id="d370f-139">默认情况下，启用了对管道和业务流程输入/输出事件的消息和服务实例跟踪。</span><span class="sxs-lookup"><span data-stu-id="d370f-139">By default message and service instance tracking is enabled for the pipelines and orchestrations In/Out events.</span></span>  
  
 <span data-ttu-id="d370f-140">如果启用消息正文跟踪，请确保 MessageBox 服务器（即“允许主机跟踪”的主机）处于运行状态。</span><span class="sxs-lookup"><span data-stu-id="d370f-140">If Message Body Tracking is enabled, ensure that the MessageBox server (that is, the host with "allow host tracking") is running.</span></span> <span data-ttu-id="d370f-141">它将数据从 MessageBox 数据库的 TrackingData 表移到 BizTalkDTADb 表，从而缓解瓶颈。</span><span class="sxs-lookup"><span data-stu-id="d370f-141">It will reduce a bottleneck as it moves data from TrackingData table in the MessageBox database to the BizTalkDTADb tables.</span></span>  
  
 <span data-ttu-id="d370f-142">通过启用自定义消息和服务实例跟踪，可以跟踪自定义事件，例如，跟踪升级属性和消息正文跟踪。</span><span class="sxs-lookup"><span data-stu-id="d370f-142">It is possible to track custom events by enabling custom message and service instance  tracking, for example, on promoted properties and message body tracking.</span></span> <span data-ttu-id="d370f-143">除跟踪数据外，BAM 数据也将写入此表。</span><span class="sxs-lookup"><span data-stu-id="d370f-143">In addition to tracking data, BAM data is also written to this table.</span></span> <span data-ttu-id="d370f-144">TDDS（启用跟踪的主机）负责将此数据从 MessageBox 数据库移至 BizTalkDTADb 和 BAMPrimaryImport 数据库，并在移动成功后，删除这些数据。</span><span class="sxs-lookup"><span data-stu-id="d370f-144">It is the responsibility of TDDS (the host on which tracking is enabled) to move this data from the MessageBox database to the BizTalkDTADb and BAMPrimaryImport databases, and then once successfully moved, delete this data.</span></span> <span data-ttu-id="d370f-145">消息正文跟踪数据另由 SQL 代理作业 TrackedMessages_Copy_BizTalkMsgBoxDb 来移动。</span><span class="sxs-lookup"><span data-stu-id="d370f-145">Message body tracking data is moved separately by a SQL-Agent job TrackedMessages_Copy_BizTalkMsgBoxDb.</span></span>  
  
 <span data-ttu-id="d370f-146">如果 TDDS 的速度赶不上侦听器向 TrackingData 表写入数据的速度，则此表将增长，从而导致限流，最终影响可承受吞吐量。</span><span class="sxs-lookup"><span data-stu-id="d370f-146">If TDDS is unable to keep up with the rate at which the interceptors are writing data to the TrackingData table, this table will grow, causing throttling to kick in, ultimately impacting sustainable throughput.</span></span> <span data-ttu-id="d370f-147">若要缓解此问题，请确保启用跟踪时，至少有一台主机处于运行状态。</span><span class="sxs-lookup"><span data-stu-id="d370f-147">To alleviate this problem, ensure that at least 1 host is running with tracking enabled.</span></span>  
  
 <span data-ttu-id="d370f-148">如果数据仍在增长，请检查 BizTalkDTADb 数据库，确定该数据库的增长没有失控。</span><span class="sxs-lookup"><span data-stu-id="d370f-148">If the data still builds up, verify the BizTalkDTADb database to ensure that the database is not growing out of control.</span></span> <span data-ttu-id="d370f-149">确保归档和清除作业正在运行，并能跟上数据的到达速度。</span><span class="sxs-lookup"><span data-stu-id="d370f-149">Ensure that the archiving and purging job is running and is able to keep up with the rate at which data is arriving.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="d370f-150">数据归档前，清除作业是无法从 BizTalkDTADb 表删除数据的。</span><span class="sxs-lookup"><span data-stu-id="d370f-150">The purge job is unable to delete data from the BizTalkDTADb tables until this data has been archived.</span></span>  
  
 <span data-ttu-id="d370f-151">验证 TrackingData 表没有增长。</span><span class="sxs-lookup"><span data-stu-id="d370f-151">Verify that the TrackingData table is not growing.</span></span> <span data-ttu-id="d370f-152">请确保至少有一台正在运行的主机实例启用了跟踪 (TDDS)。</span><span class="sxs-lookup"><span data-stu-id="d370f-152">Ensure that at least 1 host instance that is running has tracking enabled (TDDS).</span></span> <span data-ttu-id="d370f-153">如果 BizTalkDTADb 数据库已经增长得非常大，则会对 TDDS 将数据从 MessageBox 数据库移至 BizTalkDTADb 数据库的能力产生负面影响。</span><span class="sxs-lookup"><span data-stu-id="d370f-153">If the BizTalkDTADb database has grown too large, it can have a negative impact on the ability of TDDS to move data from the MessageBox database to the BizTalkDTADb database.</span></span>  
  
 <span data-ttu-id="d370f-154">TrackingData 表的增长会导致限流，从而影响可承受的运行时吞吐量。</span><span class="sxs-lookup"><span data-stu-id="d370f-154">Growth in the TrackingData table can cause throttling to kick in, impacting sustainable runtime throughput.</span></span>